
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../explanation/">
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Full listing of all docstrings by module - LyoPRONTO Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#full-listing-of-all-docstrings-by-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="LyoPRONTO Documentation" class="md-header__button md-logo" aria-label="LyoPRONTO Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LyoPRONTO Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Full listing of all docstrings by module
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="LyoPRONTO Documentation" class="md-nav__button md-logo" aria-label="LyoPRONTO Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LyoPRONTO Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LyoPRONTO: Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How-to Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../explanation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Explanations
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Full listing of all docstrings by module
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Full listing of all docstrings by module
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lyopronto" class="md-nav__link">
    <span class="md-ellipsis">
      
        lyopronto
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lyopronto.functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Eq_Constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Eq_Constraints
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Ineq_Constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ineq_Constraints
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Kv_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kv_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Lpr0_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lpr0_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Rp_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rp_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Rp_finder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rp_finder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_bot_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_bot_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_Rp_finder" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_Rp_finder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_fromTpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_fromTpr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_solver_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_solver_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Tbot_max_eq_cap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tbot_max_eq_cap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Vapor_pressure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vapor_pressure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.calc_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        calc_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.crystallization_time_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        crystallization_time_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.fill_output" class="md-nav__link">
    <span class="md-ellipsis">
      
        fill_output
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.lumped_cap_Tpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        lumped_cap_Tpr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.sub_rate" class="md-nav__link">
    <span class="md-ellipsis">
      
        sub_rate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        pyomo_models
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pyomo_models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.create_multi_period_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_multi_period_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.create_single_step_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_single_step_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Pch_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Pch_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_multi_period" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_multi_period
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_multi_period">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_multi_period--get-scipy-warmstart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get scipy warmstart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.solve_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.warmstart_from_scipy_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        warmstart_from_scipy_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.create_multi_period_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_multi_period_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.optimize_multi_period" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_multi_period
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_multi_period">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.optimize_multi_period--get-scipy-warmstart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get scipy warmstart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.warmstart_from_scipy_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        warmstart_from_scipy_trajectory
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimizers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimizers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_control_tracking_penalty" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_control_tracking_penalty
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_slack_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_slack_variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_trust_region" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_trust_region
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.create_optimizer_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_optimizer_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Pch_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Pch_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.staged_solve" class="md-nav__link">
    <span class="md-ellipsis">
      
        staged_solve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.validate_scipy_residuals" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_scipy_residuals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        single_step
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="single_step">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.create_single_step_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_single_step_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.optimize_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.solve_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_single_step
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.add_scaling_suffix" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_scaling_suffix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.check_solution_validity" class="md-nav__link">
    <span class="md-ellipsis">
      
        check_solution_validity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.extract_solution_to_array" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_solution_to_array
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.initialize_from_scipy" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize_from_scipy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lyopronto" class="md-nav__link">
    <span class="md-ellipsis">
      
        lyopronto
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lyopronto.functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Eq_Constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Eq_Constraints
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Ineq_Constraints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ineq_Constraints
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Kv_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Kv_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Lpr0_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lpr0_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Rp_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rp_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Rp_finder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rp_finder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_bot_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_bot_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_Rp_finder" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_Rp_finder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_fromTpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_fromTpr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.T_sub_solver_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        T_sub_solver_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Tbot_max_eq_cap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tbot_max_eq_cap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.Vapor_pressure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vapor_pressure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.calc_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        calc_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.crystallization_time_FUN" class="md-nav__link">
    <span class="md-ellipsis">
      
        crystallization_time_FUN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.fill_output" class="md-nav__link">
    <span class="md-ellipsis">
      
        fill_output
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.lumped_cap_Tpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        lumped_cap_Tpr
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.functions.sub_rate" class="md-nav__link">
    <span class="md-ellipsis">
      
        sub_rate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        pyomo_models
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pyomo_models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.create_multi_period_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_multi_period_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.create_single_step_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_single_step_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Pch_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Pch_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_multi_period" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_multi_period
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_multi_period">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_multi_period--get-scipy-warmstart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get scipy warmstart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimize_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.solve_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.warmstart_from_scipy_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        warmstart_from_scipy_trajectory
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.create_multi_period_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_multi_period_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.optimize_multi_period" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_multi_period
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_multi_period">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.optimize_multi_period--get-scipy-warmstart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get scipy warmstart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.model.warmstart_from_scipy_trajectory" class="md-nav__link">
    <span class="md-ellipsis">
      
        warmstart_from_scipy_trajectory
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimizers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimizers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_control_tracking_penalty" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_control_tracking_penalty
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_slack_variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_slack_variables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.add_trust_region" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_trust_region
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.create_optimizer_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_optimizer_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Pch_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Pch_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Pch_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.optimize_Tsh_pyomo" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_Tsh_pyomo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.staged_solve" class="md-nav__link">
    <span class="md-ellipsis">
      
        staged_solve
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.optimizers.validate_scipy_residuals" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_scipy_residuals
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        single_step
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="single_step">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.create_single_step_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_single_step_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.optimize_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_single_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.single_step.solve_single_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        solve_single_step
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils" class="md-nav__link">
    <span class="md-ellipsis">
      
        utils
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.add_scaling_suffix" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_scaling_suffix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.check_solution_validity" class="md-nav__link">
    <span class="md-ellipsis">
      
        check_solution_validity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.extract_solution_to_array" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_solution_to_array
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lyopronto.pyomo_models.utils.initialize_from_scipy" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize_from_scipy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="full-listing-of-all-docstrings-by-module">Full listing of all docstrings by module</h1>


<div class="doc doc-object doc-module">



<a id="lyopronto"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h2 id="lyopronto.functions" class="doc doc-heading">
            <code>functions</code>


</h2>

    <div class="doc doc-contents ">

        <p>File with a bunch of functions in it.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Eq_Constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Eq_Constraints</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span> <span class="n">dmdt</span><span class="p">,</span> <span class="n">Tbot</span><span class="p">,</span> <span class="n">Tsh</span><span class="p">,</span> <span class="n">Psub</span><span class="p">,</span> <span class="n">Tsub</span><span class="p">,</span> <span class="n">Kv</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Av</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Rp</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Defines the equality constraints for lyophilization. Inputs are chamber pressure [Torr],
sublimation rate [kg/hr], vial bottom temperature [degC], shelf temperature [degC],
sublimation front pressure [Torr], sublimation front temperature [degC], vial heat
transfer coefficient [cal/s/K/cm<strong>2], initial product length [cm], cake length [cm],
vial area [cm</strong>2], product area [cm<strong>2], and product resistance [cm</strong>2<em>Torr</em>hr/g]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Eq_Constraints</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span><span class="n">dmdt</span><span class="p">,</span><span class="n">Tbot</span><span class="p">,</span><span class="n">Tsh</span><span class="p">,</span><span class="n">Psub</span><span class="p">,</span><span class="n">Tsub</span><span class="p">,</span><span class="n">Kv</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Av</span><span class="p">,</span><span class="n">Ap</span><span class="p">,</span><span class="n">Rp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the equality constraints for lyophilization. Inputs are chamber pressure [Torr],</span>
<span class="sd">    sublimation rate [kg/hr], vial bottom temperature [degC], shelf temperature [degC],</span>
<span class="sd">    sublimation front pressure [Torr], sublimation front temperature [degC], vial heat</span>
<span class="sd">    transfer coefficient [cal/s/K/cm**2], initial product length [cm], cake length [cm],</span>
<span class="sd">    vial area [cm**2], product area [cm**2], and product resistance [cm**2*Torr*hr/g] </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">C1</span> <span class="o">=</span> <span class="n">Psub</span> <span class="o">-</span> <span class="mf">2.698e10</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">6144.96</span><span class="o">/</span><span class="p">(</span><span class="mf">273.15</span><span class="o">+</span><span class="n">Tsub</span><span class="p">))</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="n">C2</span> <span class="o">=</span> <span class="n">dmdt</span> <span class="o">-</span> <span class="n">Ap</span><span class="o">/</span><span class="n">Rp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">*</span><span class="p">(</span><span class="n">Psub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span>  <span class="c1"># Sublimation rate [kg/hr]</span>

    <span class="n">C3</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tsh</span><span class="o">-</span><span class="n">Tbot</span><span class="p">)</span><span class="o">*</span><span class="n">Av</span><span class="o">*</span><span class="n">Kv</span><span class="o">*</span><span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ap</span><span class="o">*</span><span class="p">(</span><span class="n">Tbot</span><span class="o">-</span><span class="n">Tsub</span><span class="p">)</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span>  <span class="c1"># Vial heat transfer balance</span>

    <span class="n">C4</span> <span class="o">=</span> <span class="n">Tsh</span> <span class="o">-</span> <span class="n">dmdt</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">/</span><span class="n">Av</span><span class="o">/</span><span class="n">Kv</span> <span class="o">-</span> <span class="n">Tbot</span>  <span class="c1"># Shelf temperature [degC]</span>

    <span class="k">return</span> <span class="n">C1</span><span class="p">,</span><span class="n">C2</span><span class="p">,</span><span class="n">C3</span><span class="p">,</span><span class="n">C4</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Ineq_Constraints" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Ineq_Constraints</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span> <span class="n">dm_dt</span><span class="p">,</span> <span class="n">Tcrit</span><span class="p">,</span> <span class="n">Tbot</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Defines the inequality constraints for lyophilization optimization within
safe operation region inside the desgin space. Inputs are chamber pressure [Torr],
sublimation rate [kg/hr], critical product temperature [degC], vial bottom
temperature [degC], equipment capability parameters a [kg/hr] and b [kg/hr/Torr],
and number of vials</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Ineq_Constraints</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span><span class="n">dm_dt</span><span class="p">,</span><span class="n">Tcrit</span><span class="p">,</span><span class="n">Tbot</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nVial</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the inequality constraints for lyophilization optimization within</span>
<span class="sd">    safe operation region inside the desgin space. Inputs are chamber pressure [Torr],</span>
<span class="sd">    sublimation rate [kg/hr], critical product temperature [degC], vial bottom</span>
<span class="sd">    temperature [degC], equipment capability parameters a [kg/hr] and b [kg/hr/Torr],</span>
<span class="sd">    and number of vials</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">C1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">Pch</span> <span class="o">-</span> <span class="n">nVial</span><span class="o">*</span><span class="n">dm_dt</span>	<span class="c1"># Equipment capability limit</span>

    <span class="n">C2</span> <span class="o">=</span> <span class="n">Tcrit</span> <span class="o">-</span> <span class="n">Tbot</span>		<span class="c1"># Maximum product temperature limit</span>

    <span class="k">return</span> <span class="n">C1</span><span class="p">,</span><span class="n">C2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Kv_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Kv_FUN</span><span class="p">(</span><span class="n">KC</span><span class="p">,</span> <span class="n">KP</span><span class="p">,</span> <span class="n">KD</span><span class="p">,</span> <span class="n">Pch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the vial heat transfer coefficient.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>KC</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial heat transfer parameter [cal/s/K/cm**2].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>KP</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial heat transfer parameter [cal/s/K/cm**2/Torr].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>KD</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial heat transfer parameter [1/Torr].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pch</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chamber pressure [Torr].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial heat transfer coefficient [cal/s/K/cm**2].</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Kv_FUN</span><span class="p">(</span><span class="n">KC</span><span class="p">,</span><span class="n">KP</span><span class="p">,</span><span class="n">KD</span><span class="p">,</span><span class="n">Pch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the vial heat transfer coefficient.</span>

<span class="sd">    Args:</span>
<span class="sd">        KC (float): Vial heat transfer parameter [cal/s/K/cm**2].</span>
<span class="sd">        KP (float): Vial heat transfer parameter [cal/s/K/cm**2/Torr].</span>
<span class="sd">        KD (float): Vial heat transfer parameter [1/Torr].</span>
<span class="sd">        Pch (float): Chamber pressure [Torr].</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): Vial heat transfer coefficient [cal/s/K/cm**2].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">KC</span> <span class="o">+</span> <span class="n">KP</span><span class="o">*</span><span class="n">Pch</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">KD</span><span class="o">*</span><span class="n">Pch</span><span class="p">)</span> <span class="c1"># Kv [cal/s/K/cm**2]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Lpr0_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="n">Vfill</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">cSolid</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the intial fill height of the frozen product [cm]. </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Ap</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>product area [cm**2]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cSolid</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>fractional concentration of the solute in solution</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>initial fill height of the frozen product, [cm].</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Lpr0_FUN</span><span class="p">(</span><span class="n">Vfill</span><span class="p">,</span><span class="n">Ap</span><span class="p">,</span><span class="n">cSolid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the intial fill height of the frozen product [cm]. </span>

<span class="sd">    Args:</span>
<span class="sd">        Vfill (float): fill volume [mL]</span>
<span class="sd">        Ap (float): product area [cm**2]</span>
<span class="sd">        cSolid (float): fractional concentration of the solute in solution</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): initial fill height of the frozen product, [cm].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dens_fac</span> <span class="o">=</span> <span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">rho_solution</span><span class="o">-</span><span class="n">cSolid</span><span class="o">*</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">rho_solution</span><span class="o">-</span><span class="n">constant</span><span class="o">.</span><span class="n">rho_ice</span><span class="p">)</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">rho_solute</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Vfill</span><span class="o">/</span><span class="p">(</span><span class="n">Ap</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">rho_ice</span><span class="p">)</span><span class="o">*</span><span class="n">dens_fac</span>  <span class="c1"># Fill height [cm]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Rp_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Rp_FUN</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates product resistance [cm<em><em>2</em>hr</em>Torr/g].</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>l</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>cake length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>R0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>base product resistance [cm<em><em>2</em>hr</em>Torr/g]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>A1</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>product resistance parameter [cm<em>hr</em>Torr/g]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>A2</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>product resistance parameter in [1/cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>product resistance [cm<em><em>2</em>hr</em>Torr/g]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Rp_FUN</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">R0</span><span class="p">,</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates product resistance [cm**2*hr*Torr/g].</span>

<span class="sd">    Args:</span>
<span class="sd">        l (float): cake length [cm]</span>
<span class="sd">        R0 (float): base product resistance [cm**2*hr*Torr/g]</span>
<span class="sd">        A1 (float): product resistance parameter [cm*hr*Torr/g]</span>
<span class="sd">        A2 (float): product resistance parameter in [1/cm]</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): product resistance [cm**2*hr*Torr/g]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">R0</span> <span class="o">+</span> <span class="n">A1</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">A2</span><span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="c1"># Product resistance [cm**2*hr*Torr/g]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Rp_finder" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Rp_finder</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch</span><span class="p">,</span> <span class="n">Tbot</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates product resistance [cm<em><em>2</em>hr</em>Torr/g]. Inputs are sublimation
temperature [degC], initial product length [cm], cake length [cm],
chamber pressure [Torr], and vial bottom temperature [degC]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Rp_finder</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Pch</span><span class="p">,</span><span class="n">Tbot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates product resistance [cm**2*hr*Torr/g]. Inputs are sublimation</span>
<span class="sd">    temperature [degC], initial product length [cm], cake length [cm],</span>
<span class="sd">    chamber pressure [Torr], and vial bottom temperature [degC]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub</span><span class="p">)</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="n">Rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">/</span><span class="p">(</span><span class="n">Tbot</span><span class="o">-</span><span class="n">T_sub</span><span class="p">)</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span>	<span class="c1"># Product resistance [cm**2*Torr*hr/g]</span>

    <span class="k">return</span> <span class="n">Rp</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.T_bot_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">T_bot_FUN</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch</span><span class="p">,</span> <span class="n">Rp</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the temperature at the bottom of the vial [degC]. Inputs are
sublimation front temperature [degC], initial product length [cm], cake
length [cm], chamber pressure [Torr], and product resistance in
[cm<em><em>2</em>Torr</em>hr/g]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">T_bot_FUN</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Pch</span><span class="p">,</span><span class="n">Rp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the temperature at the bottom of the vial [degC]. Inputs are</span>
<span class="sd">    sublimation front temperature [degC], initial product length [cm], cake</span>
<span class="sd">    length [cm], chamber pressure [Torr], and product resistance in</span>
<span class="sd">    [cm**2*Torr*hr/g]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub</span><span class="p">)</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="n">Tbot</span> <span class="o">=</span> <span class="n">T_sub</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">/</span><span class="n">Rp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span> <span class="c1"># Vial bottom temperature [degC]</span>

    <span class="k">return</span> <span class="n">Tbot</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.T_sub_Rp_finder" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">T_sub_Rp_finder</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Tsub is found from solving for T_unknown.
Determines the function to calculate the sublimation temperature
represented as T_unknown. Other inputs are chamber pressure [Torr], vial
area [cm<strong>2], product area [cm</strong>2], vial heat transfer coefficient in
[cal/s/K/cm**2], initial product length [cm], cake length [cm], vial bottom 
temperature [degC], and shelf temperature [degC]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">T_sub_Rp_finder</span><span class="p">(</span><span class="n">T_sub</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tsub is found from solving for T_unknown.</span>
<span class="sd">    Determines the function to calculate the sublimation temperature</span>
<span class="sd">    represented as T_unknown. Other inputs are chamber pressure [Torr], vial</span>
<span class="sd">    area [cm**2], product area [cm**2], vial heat transfer coefficient in</span>
<span class="sd">    [cal/s/K/cm**2], initial product length [cm], cake length [cm], vial bottom </span>
<span class="sd">    temperature [degC], and shelf temperature [degC]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Av</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Kv</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Tbot</span><span class="p">,</span> <span class="n">Tsh</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">LHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tsh</span> <span class="o">-</span> <span class="n">Tbot</span><span class="p">)</span><span class="o">*</span><span class="n">Av</span><span class="o">*</span><span class="n">Kv</span>
    <span class="n">RHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tbot</span> <span class="o">-</span> <span class="n">T_sub</span><span class="p">)</span><span class="o">*</span><span class="n">Ap</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span><span class="o">/</span><span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LHS</span><span class="o">-</span><span class="n">RHS</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.T_sub_fromTpr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">T_sub_fromTpr</span><span class="p">(</span><span class="n">T_unknown</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Tsub is found from solving for T_unknown.  # Determines the function to calculate the sublimation temperature
represented as T_unknown. Other inputs are vial bottom temperature [degC], 
initial product length [cm], cake length [cm], chamber pressure [Torr],
and product resistance [cm<em><em>2</em>Torr</em>hr/g]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">T_sub_fromTpr</span><span class="p">(</span><span class="n">T_unknown</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tsub is found from solving for T_unknown.  # Determines the function to calculate the sublimation temperature</span>
<span class="sd">    represented as T_unknown. Other inputs are vial bottom temperature [degC], </span>
<span class="sd">    initial product length [cm], cake length [cm], chamber pressure [Torr],</span>
<span class="sd">    and product resistance [cm**2*Torr*hr/g]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Tbot</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch</span><span class="p">,</span> <span class="n">Rp</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_unknown</span><span class="p">)</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">T_unknown</span> <span class="o">-</span> <span class="n">Tbot</span> <span class="o">+</span> <span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">/</span><span class="n">Rp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span>  <span class="c1"># Heat and mass transfer energy balance function - Should be zero</span>

    <span class="k">return</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.T_sub_solver_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">T_sub_solver_FUN</span><span class="p">(</span><span class="n">T_sub_guess</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Tsub is found from solving for T_unknown.
Determines the function to calculate the sublimation temperature
represented as T_unknown. Other inputs are chamber pressure [Torr], vial
area [cm<strong>2], product area [cm</strong>2], vial heat transfer coefficient in
[cal/s/K/cm<strong>2], initial product length [cm], cake length [cm], product
resistance [cm</strong>2<em>Torr</em>Hr/g], and shelf temperature [degC]</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>T_sub_guess</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial guess for the sublimation temperature [degC].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pch, Av, Ap, Kv, Lpr0, Lck, Rp, Tsh</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>residual for the pseudosteady heat balance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">T_sub_solver_FUN</span><span class="p">(</span><span class="n">T_sub_guess</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tsub is found from solving for T_unknown.</span>
<span class="sd">    Determines the function to calculate the sublimation temperature</span>
<span class="sd">    represented as T_unknown. Other inputs are chamber pressure [Torr], vial</span>
<span class="sd">    area [cm**2], product area [cm**2], vial heat transfer coefficient in</span>
<span class="sd">    [cal/s/K/cm**2], initial product length [cm], cake length [cm], product</span>
<span class="sd">    resistance [cm**2*Torr*Hr/g], and shelf temperature [degC]</span>

<span class="sd">    Args:</span>
<span class="sd">        T_sub_guess (float): Initial guess for the sublimation temperature [degC].</span>
<span class="sd">        data (tuple): Pch, Av, Ap, Kv, Lpr0, Lck, Rp, Tsh</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): residual for the pseudosteady heat balance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Pch</span><span class="p">,</span> <span class="n">Av</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Kv</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Tsh</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub_guess</span><span class="p">)</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>
    <span class="n">Qsub</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">*</span><span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span><span class="o">*</span><span class="n">Ap</span><span class="o">/</span><span class="n">Rp</span> <span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span> <span class="c1"># Sublimation heat</span>
    <span class="n">T_b</span> <span class="o">=</span> <span class="n">T_sub_guess</span> <span class="o">+</span> <span class="n">Qsub</span><span class="o">/</span><span class="n">Ap</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span><span class="o">*</span><span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span> <span class="c1"># Corresponding bottom temperature</span>
    <span class="n">Qsh</span> <span class="o">=</span> <span class="n">Kv</span><span class="o">*</span><span class="n">Av</span><span class="o">*</span><span class="p">(</span><span class="n">Tsh</span> <span class="o">-</span> <span class="n">T_b</span><span class="p">)</span> <span class="c1"># Heat transfer from shelf</span>
    <span class="k">return</span> <span class="n">Qsub</span><span class="o">-</span><span class="n">Qsh</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Tbot_max_eq_cap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Tbot_max_eq_cap</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span> <span class="n">dm_dt</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Ap</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the maximum product temperature (occus at vial bottom)
[degC]. Inputs are chamber pressure [Torr], sublimation rate based on
equipment capability [kg/hr], initial product length [cm], cake length
[cm], product resistance [cm<strong>2<em>Torr</em>hr/g], and product area [cm</strong>2]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Tbot_max_eq_cap</span><span class="p">(</span><span class="n">Pch</span><span class="p">,</span><span class="n">dm_dt</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Rp</span><span class="p">,</span><span class="n">Ap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the maximum product temperature (occus at vial bottom)</span>
<span class="sd">    [degC]. Inputs are chamber pressure [Torr], sublimation rate based on</span>
<span class="sd">    equipment capability [kg/hr], initial product length [cm], cake length</span>
<span class="sd">    [cm], product resistance [cm**2*Torr*hr/g], and product area [cm**2]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">dm_dt</span><span class="o">/</span><span class="n">Ap</span><span class="o">*</span><span class="n">Rp</span> <span class="o">+</span> <span class="n">Pch</span>     <span class="c1"># Sublimation front pressure [Torr]</span>
    <span class="n">T_sub</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6144.96</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P_sub</span><span class="o">/</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>    <span class="c1"># Sublimation front temperature [degC]</span>
    <span class="n">Tbot</span> <span class="o">=</span> <span class="n">T_sub</span> <span class="o">+</span> <span class="p">(</span><span class="n">Lpr0</span><span class="o">-</span><span class="n">Lck</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="o">/</span><span class="n">Rp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span>	<span class="c1">#Vial bottom temperature [degC]</span>
    <span class="n">Tbot_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Tbot</span><span class="p">)</span>   <span class="c1"># Maximum vial bottom temperature [degC]</span>

    <span class="k">return</span> <span class="n">Tbot_max</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.Vapor_pressure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the vapor pressure [Torr]. Input is sublimation front
temperature [degC]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the vapor pressure [Torr]. Input is sublimation front</span>
<span class="sd">    temperature [degC]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="mf">2.698e10</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">6144.96</span><span class="o">/</span><span class="p">(</span><span class="mf">273.15</span><span class="o">+</span><span class="n">T_sub</span><span class="p">))</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="k">return</span> <span class="n">p</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.calc_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate the full set of system states at a given time step from ODE solution states.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>t</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current time in hours.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lck</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cake thickness [cm].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the configuration parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The full set of system states at the given time step.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calc_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the full set of system states at a given time step from ODE solution states.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (float): The current time in hours.</span>
<span class="sd">        Lck (float): The cake thickness [cm].</span>
<span class="sd">        config (tuple): A tuple containing the configuration parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): The full set of system states at the given time step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pch_t</span><span class="p">,</span> <span class="n">Tsh_t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">config</span>
    <span class="n">Tsh</span> <span class="o">=</span> <span class="n">Tsh_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">Pch</span> <span class="o">=</span> <span class="n">Pch_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">Kv</span> <span class="o">=</span> <span class="n">Kv_FUN</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">],</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">],</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">],</span><span class="n">Pch</span><span class="p">)</span>  <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm**2]</span>
    <span class="n">Rp</span> <span class="o">=</span> <span class="n">Rp_FUN</span><span class="p">(</span><span class="n">Lck</span><span class="p">,</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">],</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>  <span class="c1"># Product resistance [cm**2*hr*Torr/g]</span>
    <span class="n">Tsub</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">T_sub_solver_FUN</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pch</span><span class="p">,</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">],</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span><span class="n">Kv</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Rp</span><span class="p">,</span><span class="n">Tsh</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Sublimation front temperature array [degC]</span>
    <span class="n">dmdt</span> <span class="o">=</span> <span class="n">sub_rate</span><span class="p">(</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span><span class="n">Rp</span><span class="p">,</span><span class="n">Tsub</span><span class="p">,</span><span class="n">Pch</span><span class="p">)</span>   <span class="c1"># Total sublimation rate array [kg/hr]</span>
    <span class="k">if</span> <span class="n">dmdt</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># print(&quot;Shelf temperature is too low for sublimation.&quot;)</span>
        <span class="n">dmdt</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tbot</span> <span class="o">=</span> <span class="n">T_bot_FUN</span><span class="p">(</span><span class="n">Tsub</span><span class="p">,</span><span class="n">Lpr0</span><span class="p">,</span><span class="n">Lck</span><span class="p">,</span><span class="n">Pch</span><span class="p">,</span><span class="n">Rp</span><span class="p">)</span>    <span class="c1"># Vial bottom temperature array [degC]</span>
    <span class="n">dry_frac</span> <span class="o">=</span> <span class="n">Lck</span><span class="o">/</span><span class="n">Lpr0</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">Tsub</span><span class="p">,</span> <span class="n">Tbot</span><span class="p">,</span> <span class="n">Tsh</span><span class="p">,</span> <span class="n">Pch</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">Torr_to_mTorr</span><span class="p">,</span> <span class="n">dmdt</span><span class="o">/</span><span class="p">(</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">cm_To_m</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">dry_frac</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">col</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.crystallization_time_FUN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">crystallization_time_FUN</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">Av</span><span class="p">,</span> <span class="n">Tf</span><span class="p">,</span> <span class="n">Tn</span><span class="p">,</span> <span class="n">Tsh</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the crystallization time [hr]. Inputs are fill volume [mL], heat transfer coefficient [W/m^2/K], vial area [cm**2], freezing temperature [degC], nucleation temperature [degC], shelf temperature [degC]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">crystallization_time_FUN</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">Av</span><span class="p">,</span><span class="n">Tf</span><span class="p">,</span><span class="n">Tn</span><span class="p">,</span><span class="n">Tsh</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the crystallization time [hr]. Inputs are fill volume [mL], heat transfer coefficient [W/m^2/K], vial area [cm**2], freezing temperature [degC], nucleation temperature [degC], shelf temperature [degC]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">constant</span><span class="o">.</span><span class="n">rho_solution</span><span class="o">*</span><span class="n">V</span><span class="o">*</span><span class="p">(</span><span class="n">constant</span><span class="o">.</span><span class="n">dHf</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">cal_To_J</span><span class="o">-</span><span class="n">constant</span><span class="o">.</span><span class="n">Cp_solution</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">*</span><span class="p">(</span><span class="n">Tf</span><span class="o">-</span><span class="n">Tn</span><span class="p">))</span><span class="o">/</span><span class="n">h</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">Av</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">cm_To_m</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">Tf</span><span class="o">-</span><span class="n">Tsh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.fill_output" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fill_output</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Fill the output array with the results from the ODE solver.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sol</code>
            </td>
            <td>
                  <code><span title="ODESolution">ODESolution</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The solution object returned by the ODE solver.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the configuration parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output array filled with the results from the ODE solver.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fill_output</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill the output array with the results from the ODE solver.</span>

<span class="sd">    Args:</span>
<span class="sd">        sol (ODESolution): The solution object returned by the ODE solver.</span>
<span class="sd">        config (tuple): A tuple containing the configuration parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (np.ndarray): The output array filled with the results from the ODE solver.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">config</span>
    <span class="c1"># out_t = np.arange(0, sol.t[-1], dt)   </span>
    <span class="n">out_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>   
    <span class="n">fullout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">out_t</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc_step</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_t</span><span class="p">):</span>
        <span class="n">fullout</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">calc_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fullout</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.lumped_cap_Tpr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">lumped_cap_Tpr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Tpr0</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">Cp</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">Av</span><span class="p">,</span> <span class="n">Tsh</span><span class="p">,</span> <span class="n">Tsh0</span><span class="p">,</span> <span class="n">Tsh_ramp</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the product temperature [degC]. Inputs are time [hr], initial product temperature [degC], product density [g/mL], constant pressure specific heat of the product [J/kg/K], product volume [mL], heat transfer coefficient [W/m^2/K], vial area [cm**2], current shelf temperature [degC], initial shelf temperature [degC], shelf temperature ramping rate [degC/min]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lumped_cap_Tpr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Tpr0</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">Cp</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">Av</span><span class="p">,</span><span class="n">Tsh</span><span class="p">,</span><span class="n">Tsh0</span><span class="p">,</span> <span class="n">Tsh_ramp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the product temperature [degC]. Inputs are time [hr], initial product temperature [degC], product density [g/mL], constant pressure specific heat of the product [J/kg/K], product volume [mL], heat transfer coefficient [W/m^2/K], vial area [cm**2], current shelf temperature [degC], initial shelf temperature [degC], shelf temperature ramping rate [degC/min]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tpr0</span> <span class="o">+</span> <span class="n">Tsh_ramp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">min_To_s</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">Cp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">h</span><span class="o">/</span><span class="n">Av</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">cm_To_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">Tsh0</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">*</span><span class="n">Av</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">cm_To_m</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="n">Cp</span><span class="o">*</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">/</span><span class="n">V</span><span class="p">)</span> <span class="o">-</span> <span class="n">Tsh_ramp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">min_To_s</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">Cp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">h</span><span class="o">/</span><span class="n">Av</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">cm_To_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Tsh</span>

    <span class="k">return</span> <span class="n">F</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.functions.sub_rate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sub_rate</span><span class="p">(</span><span class="n">Ap</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">T_sub</span><span class="p">,</span> <span class="n">Pch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculates the sublimation rate from each vial [kg/hr]. Inputs are
product area [cm<strong>2], product resistance [cm</strong>2<em>Torr</em>Hr/g], sublimation
front temperature [degC], and chamber pressure [Torr]</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/functions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sub_rate</span><span class="p">(</span><span class="n">Ap</span><span class="p">,</span><span class="n">Rp</span><span class="p">,</span><span class="n">T_sub</span><span class="p">,</span><span class="n">Pch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the sublimation rate from each vial [kg/hr]. Inputs are</span>
<span class="sd">    product area [cm**2], product resistance [cm**2*Torr*Hr/g], sublimation</span>
<span class="sd">    front temperature [degC], and chamber pressure [Torr]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">P_sub</span> <span class="o">=</span> <span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">T_sub</span><span class="p">)</span>   <span class="c1"># Vapor pressure at the sublimation temperature [Torr]</span>

    <span class="n">dm_dt</span> <span class="o">=</span> <span class="n">Ap</span><span class="o">/</span><span class="n">Rp</span><span class="o">/</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="o">*</span><span class="p">(</span><span class="n">P_sub</span><span class="o">-</span><span class="n">Pch</span><span class="p">)</span>  <span class="c1"># Sublimation rate [kg/hr]</span>

    <span class="k">return</span> <span class="n">dm_dt</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="lyopronto.pyomo_models" class="doc doc-heading">
            <code>pyomo_models</code>


</h2>

    <div class="doc doc-contents ">

        <p>Pyomo-based optimization models for lyophilization process optimization.</p>
<p>This module provides Pyomo NLP (Nonlinear Programming) implementations as an
alternative to the scipy-based optimizers. Both approaches coexist in LyoPRONTO,
allowing users to choose the most appropriate method for their application.</p>


<details class="key-modules" open>
  <summary>Key modules</summary>
  <ul>
<li>model: Multi-period DAE model creation with collocation</li>
<li>optimizers: User-facing optimizer functions (optimize_Tsh_pyomo, optimize_Pch_pyomo, optimize_Pch_Tsh_pyomo)</li>
<li>single_step: Single time-step optimization (replicate scipy sequential approach)</li>
<li>utils: Shared utilities for initialization, scaling, and result extraction</li>
</ul>
</details>









  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.create_multi_period_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_multi_period_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">t_final</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create multi-period Pyomo DAE model for primary drying optimization.</p>
<p>This creates a dynamic optimization model with:
- Time as a continuous variable discretized by collocation
- Differential equations for temperature evolution
- Algebraic equations for heat/mass transfer
- Path constraints on product temperature</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters (Av, Ap)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters (R0, A1, A2, Tpr_max, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of finite elements for time discretization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of collocation points per element (3-5 recommended)</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t_final</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Final time [hr] (will be optimized)</p>
              </div>
            </td>
            <td>
                  <code>10.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable/constraint scaling</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><span title="ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model ready for optimization</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="model-variables" open>
  <summary>Model Variables</summary>
  <p>Time-indexed (continuous):
- Pch(t): Chamber pressure [Torr]
- Tsh(t): Shelf temperature [C]
- Tsub(t): Sublimation front temperature [C]
- Tbot(t): Vial bottom temperature [C]
- Psub(t): Vapor pressure at sublimation front [Torr]
- log_Psub(t): Log of vapor pressure (for stability)
- dmdt(t): Sublimation rate [kg/hr]
- Kv(t): Vial heat transfer coefficient [cal/s/K/cm]
- Lck(t): Dried cake length [cm]
- Rp(t): Product resistance [cm-hr-Torr/g]</p>
<p>Scalar:
- t_final: Total drying time [hr] (optimization variable)</p>
</details>

<details class="constraints" open>
  <summary>Constraints</summary>
  <p>ODEs:
- dTsub/dt = f(heat balance, sublimation)
- dTbot/dt = f(shelf heat transfer)
- dLck/dt = dmdt * conversion_factor</p>
<p>Algebraic:
- Vapor pressure (log-transformed)
- Sublimation rate (mass transfer)
- Heat balance
- Product resistance
- Kv calculation</p>
<p>Path constraints:
- Tsub(t) &gt;= Tpr_max (product temperature limit)
- 0 &lt;= Pch(t) &lt;= 0.5 (chamber pressure bounds)
- -50 &lt;= Tsh(t) &lt;= 50 (shelf temperature bounds)</p>
</details>

<details class="objective" open>
  <summary>Objective</summary>
  <p>Minimize t_final (total drying time)</p>
</details>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Uses Radau collocation (right-biased, good for stiff systems)</li>
<li>Log transformation improves numerical stability</li>
<li>Scaling reduces condition number by 2-3 orders of magnitude</li>
<li>Warmstart from scipy trajectory recommended</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_multi_period_model</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Vfill</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">t_final</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create multi-period Pyomo DAE model for primary drying optimization.</span>

<span class="sd">    This creates a dynamic optimization model with:</span>
<span class="sd">    - Time as a continuous variable discretized by collocation</span>
<span class="sd">    - Differential equations for temperature evolution</span>
<span class="sd">    - Algebraic equations for heat/mass transfer</span>
<span class="sd">    - Path constraints on product temperature</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial parameters (Av, Ap)</span>
<span class="sd">        product (dict): Product parameters (R0, A1, A2, Tpr_max, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Vfill (float): Fill volume [mL]</span>
<span class="sd">        n_elements (int): Number of finite elements for time discretization</span>
<span class="sd">        n_collocation (int): Number of collocation points per element (3-5 recommended)</span>
<span class="sd">        t_final (float): Final time [hr] (will be optimized)</span>
<span class="sd">        apply_scaling (bool): Apply variable/constraint scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (ConcreteModel): Pyomo model ready for optimization</span>

<span class="sd">    Model Variables:</span>
<span class="sd">        Time-indexed (continuous):</span>
<span class="sd">        - Pch(t): Chamber pressure [Torr]</span>
<span class="sd">        - Tsh(t): Shelf temperature [C]</span>
<span class="sd">        - Tsub(t): Sublimation front temperature [C]</span>
<span class="sd">        - Tbot(t): Vial bottom temperature [C]</span>
<span class="sd">        - Psub(t): Vapor pressure at sublimation front [Torr]</span>
<span class="sd">        - log_Psub(t): Log of vapor pressure (for stability)</span>
<span class="sd">        - dmdt(t): Sublimation rate [kg/hr]</span>
<span class="sd">        - Kv(t): Vial heat transfer coefficient [cal/s/K/cm]</span>
<span class="sd">        - Lck(t): Dried cake length [cm]</span>
<span class="sd">        - Rp(t): Product resistance [cm-hr-Torr/g]</span>

<span class="sd">        Scalar:</span>
<span class="sd">        - t_final: Total drying time [hr] (optimization variable)</span>

<span class="sd">    Constraints:</span>
<span class="sd">        ODEs:</span>
<span class="sd">        - dTsub/dt = f(heat balance, sublimation)</span>
<span class="sd">        - dTbot/dt = f(shelf heat transfer)</span>
<span class="sd">        - dLck/dt = dmdt * conversion_factor</span>

<span class="sd">        Algebraic:</span>
<span class="sd">        - Vapor pressure (log-transformed)</span>
<span class="sd">        - Sublimation rate (mass transfer)</span>
<span class="sd">        - Heat balance</span>
<span class="sd">        - Product resistance</span>
<span class="sd">        - Kv calculation</span>

<span class="sd">        Path constraints:</span>
<span class="sd">        - Tsub(t) &gt;= Tpr_max (product temperature limit)</span>
<span class="sd">        - 0 &lt;= Pch(t) &lt;= 0.5 (chamber pressure bounds)</span>
<span class="sd">        - -50 &lt;= Tsh(t) &lt;= 50 (shelf temperature bounds)</span>

<span class="sd">    Objective:</span>
<span class="sd">        Minimize t_final (total drying time)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Uses Radau collocation (right-biased, good for stiff systems)</span>
<span class="sd">        - Log transformation improves numerical stability</span>
<span class="sd">        - Scaling reduces condition number by 2-3 orders of magnitude</span>
<span class="sd">        - Warmstart from scipy trajectory recommended</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1"># Extract parameters</span>
    <span class="n">Av</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">]</span>
    <span class="n">Ap</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
    <span class="n">Tpr_max</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tpr_max&#39;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T_pr_crit&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">25.0</span><span class="p">))</span>  <span class="c1"># Handle both naming conventions</span>
    <span class="n">cSolid</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">]</span>
    <span class="n">KC</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">]</span>
    <span class="n">KP</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">]</span>
    <span class="n">KD</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">]</span>

    <span class="c1"># Compute initial product length</span>
    <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="n">Vfill</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">cSolid</span><span class="p">)</span>

    <span class="c1"># Physical constants</span>
    <span class="n">dHs</span> <span class="o">=</span> <span class="mf">677.0</span>  <span class="c1"># Heat of sublimation [cal/g]</span>

    <span class="c1"># ======================</span>
    <span class="c1"># TIME DOMAIN</span>
    <span class="c1"># ======================</span>

    <span class="n">model</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">ContinuousSet</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Normalized time [0, 1]</span>

    <span class="c1"># Actual time scaling factor (to be optimized)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">t_final</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># STATE VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Temperatures [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">20.0</span><span class="p">)</span>

    <span class="c1"># Dried cake length [cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># CONTROL VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Chamber pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Shelf temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># ALGEBRAIC VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Vapor pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># Sublimation rate [kg/hr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>

    <span class="c1"># Product resistance [cm-hr-Torr/g]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">R0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># DERIVATIVES</span>
    <span class="c1"># ======================</span>

    <span class="n">model</span><span class="o">.</span><span class="n">dTsub_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dTbot_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dLck_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># ALGEBRAIC CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_log_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log transformation of Antoine equation for vapor pressure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6144.96</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_log</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_log_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_exp_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exponential recovery of vapor pressure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_exp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_exp_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">product_resistance_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product resistance as function of dried cake length.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">R0</span> <span class="o">+</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">product_resistance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">product_resistance_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">kv_calc_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial heat transfer coefficient.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">KC</span> <span class="o">+</span> <span class="n">KP</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">KD</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">model</span><span class="o">.</span><span class="n">kv_calc</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">kv_calc_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sublimation_rate_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mass transfer equation for sublimation rate.&quot;&quot;&quot;</span>
        <span class="c1"># dmdt in kg/hr, normalize by area</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ap</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

    <span class="n">model</span><span class="o">.</span><span class="n">sublimation_rate</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">sublimation_rate_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># DIFFERENTIAL EQUATIONS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heat_balance_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy balance at sublimation front.</span>

<span class="sd">        Heat in from shelf = Heat consumed by sublimation</span>
<span class="sd">        This determines the rate of change of Tsub.</span>

<span class="sd">        For simplicity, we use a quasi-steady approximation where</span>
<span class="sd">        the sublimation front temperature adjusts rapidly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="c1"># Heat from shelf [cal/hr]</span>
        <span class="n">Q_shelf</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">Av</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span>

        <span class="c1"># Heat for sublimation [cal/hr]</span>
        <span class="n">Q_sub</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">dHs</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># kg/hr * cal/g * 1000 g/kg</span>

        <span class="c1"># Simplified ODE: rate of Tsub change proportional to imbalance</span>
        <span class="c1"># This is a relaxation; in reality Tsub adjusts to maintain balance</span>
        <span class="n">tau_thermal</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Thermal time constant [hr]</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dTsub_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">Q_shelf</span> <span class="o">-</span> <span class="n">Q_sub</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau_thermal</span> <span class="o">*</span> <span class="n">Q_sub</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">heat_balance_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">heat_balance_ode_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vial_bottom_temp_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial bottom temperature dynamics.</span>

<span class="sd">        Tbot tracks Tsh with thermal lag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="n">tau_vial</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Vial thermal time constant [hr]</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dTbot_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="n">tau_vial</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vial_bottom_temp_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vial_bottom_temp_ode_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cake_length_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dried cake length increases with sublimation.</span>

<span class="sd">        dLck/dt = dmdt / (Ap * rho_ice * (1 - cSolid))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="n">rho_ice</span> <span class="o">=</span> <span class="mf">0.92</span>  <span class="c1"># Density of ice [g/cm]</span>

        <span class="c1"># Convert dmdt [kg/hr] to [g/hr], divide by area and density</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dLck_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ap</span> <span class="o">*</span> <span class="n">rho_ice</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cSolid</span><span class="p">))</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">cake_length_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">cake_length_ode_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># INITIAL CONDITIONS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tsub_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial sublimation temperature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">40.0</span>  <span class="c1"># Start cold</span>

    <span class="n">model</span><span class="o">.</span><span class="n">tsub_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">tsub_ic_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tbot_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial vial bottom temperature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">40.0</span>  <span class="c1"># Start at shelf temp</span>

    <span class="n">model</span><span class="o">.</span><span class="n">tbot_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">tbot_ic_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lck_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial cake length is zero.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>

    <span class="n">model</span><span class="o">.</span><span class="n">lck_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">lck_ic_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># TERMINAL CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final_dryness_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure drying is complete at final time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">Lpr0</span>  <span class="c1"># 95% dried</span>

    <span class="n">model</span><span class="o">.</span><span class="n">final_dryness</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">final_dryness_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># PATH CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temp_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product temperature must not exceed maximum.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Tpr_max</span>

    <span class="n">model</span><span class="o">.</span><span class="n">temp_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">temp_limit_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># OBJECTIVE</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Minimize total drying time</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># APPLY DISCRETIZATION</span>
    <span class="c1"># ======================</span>

    <span class="n">discretizer</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;dae.collocation&#39;</span><span class="p">)</span>
    <span class="n">discretizer</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">nfe</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">ncp</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;LAGRANGE-RADAU&#39;</span>  <span class="c1"># Right-biased, good for stiff systems</span>
    <span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># APPLY SCALING</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">apply_scaling</span><span class="p">:</span>
        <span class="c1"># Scaling factors (based on typical magnitudes)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="o">.</span><span class="n">EXPORT</span><span class="p">)</span>

        <span class="c1"># Variables</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="c1"># Temperatures already O(10)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Pressures already O(0.1-1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Sublimation rate O(1) -&gt; scale to O(1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="c1"># Kv O(1e-4) -&gt; scale to O(0.1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1000.0</span>

            <span class="c1"># Rp O(10-100) -&gt; scale to O(1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.01</span>

            <span class="c1"># Lck O(1) already good</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Derivatives (per normalized time)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dTsub_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dTbot_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dLck_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Scalar variables</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># Apply scaling transformation</span>
        <span class="n">scaling_transform</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;core.scale_model&#39;</span><span class="p">)</span>
        <span class="n">scaled_model</span> <span class="o">=</span> <span class="n">scaling_transform</span><span class="o">.</span><span class="n">create_using</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scaled_model</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.create_single_step_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create Pyomo model for single time-step lyophilization optimization.</p>
<p>This function constructs a ConcreteModel that represents the physics and
constraints of lyophilization at a single time step. The model finds optimal
chamber pressure and shelf temperature to maximize sublimation rate while
respecting equipment and product temperature constraints.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry with keys:
- 'Av' (float): Vial area [cm]
- 'Ap' (float): Product area [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties with keys:
- 'R0' (float): Base product resistance [cmhrTorr/g]
- 'A1' (float): Resistance parameter [cmhrTorr/g]
- 'A2' (float): Resistance parameter [1/cm]
- 'T_pr_crit' (float): Critical product temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters with keys:
- 'KC' (float): Vial heat transfer parameter [cal/s/K/cm]
- 'KP' (float): Vial heat transfer parameter [cal/s/K/cm/Torr]
- 'KD' (float): Vial heat transfer parameter [1/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lpr0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial product length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lck</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current dried cake length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pch_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(min, max) for chamber pressure [Torr]. 
Default: (0.05, 0.5)</p>
              </div>
            </td>
            <td>
                  <code>(0.05, 0.5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tsh_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(min, max) for shelf temperature [C].
Default: (-50, 50)</p>
              </div>
            </td>
            <td>
                  <code>(-50, 50)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability parameters with keys:
- 'a' (float): Equipment capability parameter [kg/hr]
- 'b' (float): Equipment capability parameter [kg/hr/Torr]
If None, equipment constraint is not enforced.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials in batch. Required if eq_cap provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pyo.ConcreteModel: Pyomo model ready to solve with variables, constraints,
and objective defined.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>The model uses the following physics equations (corrected Jan 2025):
- Vapor pressure: Psub = 2.698e10 * exp(-6144.96/(Tsub + 273.15))
- Product resistance: Rp = R0 + A1<em>Lck/(1 + A2</em>Lck)
- Vial heat transfer: Kv = KC + KP<em>Pch/(1 + KD</em>Pch)
- Sublimation rate: dmdt = Ap/Rp * (Psub - Pch) / kg_To_g
- Energy balance: Kv<em>Av</em>(Tsh - Tbot) = dHs<em>dmdt</em>kg_To_g/hr_To_s
- Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)<em>dHs</em>dmdt<em>kg_To_g/hr_To_s/(Ap</em>k_ice)</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vial</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.80</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ht</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">2.75e-4</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">8.93e-4</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Lck</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Half dried</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Now solve with solve_single_step(model)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_single_step_model</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">,</span> 
    <span class="n">product</span><span class="p">,</span> 
    <span class="n">ht</span><span class="p">,</span> 
    <span class="n">Lpr0</span><span class="p">,</span> 
    <span class="n">Lck</span><span class="p">,</span>
    <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create Pyomo model for single time-step lyophilization optimization.</span>

<span class="sd">    This function constructs a ConcreteModel that represents the physics and</span>
<span class="sd">    constraints of lyophilization at a single time step. The model finds optimal</span>
<span class="sd">    chamber pressure and shelf temperature to maximize sublimation rate while</span>
<span class="sd">    respecting equipment and product temperature constraints.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry with keys:</span>
<span class="sd">            - &#39;Av&#39; (float): Vial area [cm]</span>
<span class="sd">            - &#39;Ap&#39; (float): Product area [cm]</span>
<span class="sd">        product (dict): Product properties with keys:</span>
<span class="sd">            - &#39;R0&#39; (float): Base product resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;A1&#39; (float): Resistance parameter [cmhrTorr/g]</span>
<span class="sd">            - &#39;A2&#39; (float): Resistance parameter [1/cm]</span>
<span class="sd">            - &#39;T_pr_crit&#39; (float): Critical product temperature [C]</span>
<span class="sd">        ht (dict): Heat transfer parameters with keys:</span>
<span class="sd">            - &#39;KC&#39; (float): Vial heat transfer parameter [cal/s/K/cm]</span>
<span class="sd">            - &#39;KP&#39; (float): Vial heat transfer parameter [cal/s/K/cm/Torr]</span>
<span class="sd">            - &#39;KD&#39; (float): Vial heat transfer parameter [1/Torr]</span>
<span class="sd">        Lpr0 (float): Initial product length [cm]</span>
<span class="sd">        Lck (float): Current dried cake length [cm]</span>
<span class="sd">        Pch_bounds (tuple, optional): (min, max) for chamber pressure [Torr]. </span>
<span class="sd">            Default: (0.05, 0.5)</span>
<span class="sd">        Tsh_bounds (tuple, optional): (min, max) for shelf temperature [C].</span>
<span class="sd">            Default: (-50, 50)</span>
<span class="sd">        eq_cap (dict, optional): Equipment capability parameters with keys:</span>
<span class="sd">            - &#39;a&#39; (float): Equipment capability parameter [kg/hr]</span>
<span class="sd">            - &#39;b&#39; (float): Equipment capability parameter [kg/hr/Torr]</span>
<span class="sd">            If None, equipment constraint is not enforced.</span>
<span class="sd">        nVial (int, optional): Number of vials in batch. Required if eq_cap provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pyo.ConcreteModel: Pyomo model ready to solve with variables, constraints,</span>
<span class="sd">            and objective defined.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The model uses the following physics equations (corrected Jan 2025):</span>
<span class="sd">        - Vapor pressure: Psub = 2.698e10 * exp(-6144.96/(Tsub + 273.15))</span>
<span class="sd">        - Product resistance: Rp = R0 + A1*Lck/(1 + A2*Lck)</span>
<span class="sd">        - Vial heat transfer: Kv = KC + KP*Pch/(1 + KD*Pch)</span>
<span class="sd">        - Sublimation rate: dmdt = Ap/Rp * (Psub - Pch) / kg_To_g</span>
<span class="sd">        - Energy balance: Kv*Av*(Tsh - Tbot) = dHs*dmdt*kg_To_g/hr_To_s</span>
<span class="sd">        - Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)*dHs*dmdt*kg_To_g/hr_To_s/(Ap*k_ice)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from lyopronto import functions</span>
<span class="sd">        &gt;&gt;&gt; vial = {&#39;Av&#39;: 3.80, &#39;Ap&#39;: 3.14}</span>
<span class="sd">        &gt;&gt;&gt; product = {&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0}</span>
<span class="sd">        &gt;&gt;&gt; ht = {&#39;KC&#39;: 2.75e-4, &#39;KP&#39;: 8.93e-4, &#39;KD&#39;: 0.46}</span>
<span class="sd">        &gt;&gt;&gt; Lpr0 = functions.Lpr0_FUN(2.0, 3.14, 0.05)</span>
<span class="sd">        &gt;&gt;&gt; Lck = 0.5  # Half dried</span>
<span class="sd">        &gt;&gt;&gt; model = create_single_step_model(vial, product, ht, Lpr0, Lck)</span>
<span class="sd">        &gt;&gt;&gt; # Now solve with solve_single_step(model)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1"># ==================== Parameters (Fixed for this step) ====================</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lpr0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">Lpr0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">Lck</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Av</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">R0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">A1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">A2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">T_crit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;T_pr_crit&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KC</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KD</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">])</span>

    <span class="c1"># Physical constants</span>
    <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">k_ice</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="p">)</span>

    <span class="c1"># ==================== Decision Variables ====================</span>
    <span class="c1"># Chamber pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Pch_bounds</span><span class="p">)</span>

    <span class="c1"># Shelf temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Tsh_bounds</span><span class="p">)</span>

    <span class="c1"># Sublimation front temperature [C] - always below freezing</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Vial bottom temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>

    <span class="c1"># Vapor pressure at sublimation front [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Log of vapor pressure (for numerical stability in exponential constraint)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>  <span class="c1"># log(1e-6) to log(10)</span>

    <span class="c1"># Sublimation rate [kg/hr] - must be non-negative</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">PositiveReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">))</span>

    <span class="c1"># ==================== Derived Quantities (Expressions) ====================</span>
    <span class="c1"># Product resistance [cmhrTorr/g]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">A1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">A2</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Equality Constraints ====================</span>
    <span class="c1"># C1: Vapor pressure at sublimation front (Antoine equation)</span>
    <span class="c1"># Using log transformation for numerical stability:</span>
    <span class="c1"># log(Psub) = log(2.698e10) - 6144.96/(Tsub + 273.15)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_log</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6144.96</span> <span class="o">/</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C1b: Link log_Psub to Psub</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_exp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C2: Sublimation rate from mass transfer</span>
    <span class="c1"># dmdt = Ap/Rp * (Psub - Pch) / kg_To_g</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sublimation_rate</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C3: Energy balance - heat from shelf equals heat for sublimation</span>
    <span class="c1"># Q_shelf = Kv * Av * (Tsh - Tbot)</span>
    <span class="c1"># Q_sub = dHs * dmdt * kg_To_g / hr_To_s</span>
    <span class="c1"># This matches the corrected multi-period energy_balance constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">energy_balance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Av</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">)</span>
             <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span>
    <span class="p">)</span>

    <span class="c1"># C4: Vial bottom temperature from conduction through frozen layer</span>
    <span class="c1"># Tbot = Tsub + T_frozen</span>
    <span class="c1"># where T_frozen = (Lpr0 - Lck) * Q_sub / (Ap * k_ice)</span>
    <span class="c1"># This matches the corrected multi-period vial_bottom_temp constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vial_bottom_temp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">+</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lpr0</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">)</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span> <span class="o">/</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">k_ice</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C5: Vial heat transfer coefficient</span>
    <span class="c1"># Kv = KC + KP * Pch / (1 + KD * Pch)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">kv_calc</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">KC</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">KP</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">KD</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Inequality Constraints ====================</span>
    <span class="c1"># Product temperature limit: Tbot  T_crit</span>
    <span class="n">model</span><span class="o">.</span><span class="n">temp_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">T_crit</span>
    <span class="p">)</span>

    <span class="c1"># Equipment capability limit (optional)</span>
    <span class="k">if</span> <span class="n">eq_cap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nVial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">a_eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">b_eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nVial</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">nVial</span><span class="p">)</span>

        <span class="c1"># a + b*Pch - nVial*dmdt  0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">equipment_capability</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">a_eq</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">b_eq</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">nVial</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">)</span>

    <span class="c1"># ==================== Objective Function ====================</span>
    <span class="c1"># Minimize (Pch - Psub) to maximize sublimation driving force (Psub - Pch)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Scaling (Optional) ====================</span>
    <span class="k">if</span> <span class="n">apply_scaling</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
        <span class="n">scaling_factors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;log_Psub&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># log values are already scaled</span>
            <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
            <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scaling_factors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.optimize_Pch_Tsh_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Pch_Tsh_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_trust_region</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trust_radii</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Joint optimization of pressure and shelf temperature (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Pch_Tsh.dry(), optimizing both
chamber pressure and shelf temperature trajectories simultaneously.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variables: Pch(t), Tsh(t) - pressure and temperature trajectories
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit
        * Equipment sublimation capacity  total batch rate
        * Pressure bounds (min, max)
        * Shelf temperature bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Joint Control Strategy</strong>:
    - Stage 1: Feasibility (both controls fixed)
    - Stage 2: Time optimization (controls fixed)
    - Stage 3: Release Tsh (optimize shelf temp, Pch fixed)
    - Stage 4: Release Pch (optimize both)
    - Optional: Trust region around scipy for initial stages</p>
<p><strong>Physics</strong>: Same corrected 1 ODE + 2 algebraic as single-control optimizers</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (Av, Ap, Vfill)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (R0, A1, A2, T_pr_crit, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pressure bounds
- 'min' (float): Minimum pressure [Torr]
- 'max' (float): Maximum pressure [Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temperature bounds
- 'min' (float): Minimum temperature [C]
- 'max' (float): Maximum temperature [C]
- 'init' (float): Initial temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability (a, b)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=32</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity; see notes in
optimize_Tsh_pyomo for FD vs collocation equivalence.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpret
n_elements as effective density when using collocation.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use scipy for initial guess</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation mode</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_trust_region</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Add trust region around scipy</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trust_radii</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trust region radii {'Pch': 0.05, 'Tsh': 10.0}</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory (n_points, 7)
Typically 3-10% faster than single-control optimizers</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Joint optimization is more challenging numerically</li>
<li>Higher n_elements (10-12) recommended vs single-control (8)</li>
<li>Trust region can improve robustness but may limit optimality</li>
<li>Expected improvement: 3-10% over best single-control optimizer</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Joint optimization with trust region</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Pch_Tsh_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Pchamber</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Tshelf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">use_trust_region</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">trust_radii</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Pch_Tsh.dry(): Scipy baseline optimizer</li>
<li>optimize_Tsh_pyomo(): Optimize shelf temperature only</li>
<li>optimize_Pch_pyomo(): Optimize pressure only</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Pch_Tsh_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># Higher default for joint optimization (FD)</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_trust_region</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">trust_radii</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Joint optimization of pressure and shelf temperature (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Pch_Tsh.dry(), optimizing both</span>
<span class="sd">    chamber pressure and shelf temperature trajectories simultaneously.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variables: Pch(t), Tsh(t) - pressure and temperature trajectories</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Pressure bounds (min, max)</span>
<span class="sd">            * Shelf temperature bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Joint Control Strategy**:</span>
<span class="sd">        - Stage 1: Feasibility (both controls fixed)</span>
<span class="sd">        - Stage 2: Time optimization (controls fixed)</span>
<span class="sd">        - Stage 3: Release Tsh (optimize shelf temp, Pch fixed)</span>
<span class="sd">        - Stage 4: Release Pch (optimize both)</span>
<span class="sd">        - Optional: Trust region around scipy for initial stages</span>

<span class="sd">    **Physics**: Same corrected 1 ODE + 2 algebraic as single-control optimizers</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (Av, Ap, Vfill)</span>
<span class="sd">        product (dict): Product properties (R0, A1, A2, T_pr_crit, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Pchamber (dict): Pressure bounds</span>
<span class="sd">            - &#39;min&#39; (float): Minimum pressure [Torr]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum pressure [Torr]</span>
<span class="sd">        Tshelf (dict): Temperature bounds</span>
<span class="sd">            - &#39;min&#39; (float): Minimum temperature [C]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum temperature [C]</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment capability (a, b)</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        n_elements (int, default=32): Discretization granularity; see notes in</span>
<span class="sd">            optimize_Tsh_pyomo for FD vs collocation equivalence.</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per element.</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): Interpret</span>
<span class="sd">            n_elements as effective density when using collocation.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Use scipy for initial guess</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>
<span class="sd">        simulation_mode (bool, default=False): Validation mode</span>
<span class="sd">        use_trust_region (bool, default=False): Add trust region around scipy</span>
<span class="sd">        trust_radii (dict, optional): Trust region radii {&#39;Pch&#39;: 0.05, &#39;Tsh&#39;: 10.0}</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory (n_points, 7)</span>
<span class="sd">            Typically 3-10% faster than single-control optimizers</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Joint optimization is more challenging numerically</span>
<span class="sd">        - Higher n_elements (10-12) recommended vs single-control (8)</span>
<span class="sd">        - Trust region can improve robustness but may limit optimality</span>
<span class="sd">        - Expected improvement: 3-10% over best single-control optimizer</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Joint optimization with trust region</span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Pch_Tsh_pyomo(</span>
<span class="sd">        ...     vial, product, ht,</span>
<span class="sd">        ...     Pchamber={&#39;min&#39;: 0.06, &#39;max&#39;: 0.20},</span>
<span class="sd">        ...     Tshelf={&#39;min&#39;: -45, &#39;max&#39;: 30, &#39;init&#39;: -35},</span>
<span class="sd">        ...     dt=0.01, eq_cap=eq_cap, nVial=398,</span>
<span class="sd">        ...     n_elements=10,</span>
<span class="sd">        ...     use_trust_region=True,</span>
<span class="sd">        ...     trust_radii={&#39;Pch&#39;: 0.03, &#39;Tsh&#39;: 8.0}</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Pch_Tsh.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Tsh_pyomo(): Optimize shelf temperature only</span>
<span class="sd">        - optimize_Pch_pyomo(): Optimize pressure only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Pch_Tsh</span>

    <span class="c1"># Create model with both controls active</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>
    <span class="p">)</span>

    <span class="c1"># Warmstart from scipy</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Pch_Tsh</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Add trust region if requested</span>
        <span class="k">if</span> <span class="n">use_trust_region</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trust_radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trust_radii</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">}</span>  <span class="c1"># Default radii</span>

            <span class="c1"># Build reference values from scipy</span>
            <span class="n">reference_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">t_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
            <span class="n">t_final_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">t_actual</span> <span class="o">=</span> <span class="n">t_normalized</span> <span class="o">*</span> <span class="n">t_final_scipy</span>

            <span class="n">time_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Tsh_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">Pch_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># mTorr  Torr</span>

            <span class="n">scipy_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time_scipy</span><span class="p">,</span> <span class="n">t_actual</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">scipy_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">scipy_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_scipy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">Pch_scipy</span><span class="p">[</span><span class="n">scipy_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> 
                                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))}</span>
            <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">Tsh_scipy</span><span class="p">[</span><span class="n">scipy_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))}</span>

            <span class="n">add_trust_region</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reference_values</span><span class="p">,</span> <span class="n">trust_radii</span><span class="p">)</span>

        <span class="c1"># Validate</span>
        <span class="k">if</span> <span class="n">tee</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver with tighter tolerances for joint optimization</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8000</span>  <span class="c1"># More iterations for joint</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>  <span class="c1"># Slightly tighter</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># Tighter</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-7</span>  <span class="c1"># Tighter</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>

    <span class="c1"># Solve with sequential control release</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.optimize_Pch_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Pch_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Optimize chamber pressure trajectory for minimum drying time (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Pch.dry(), optimizing chamber
pressure trajectory while keeping shelf temperature fixed.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variable: Pch(t) - chamber pressure trajectory [Torr]
    - Fixed parameter: Tsh(t) - shelf temperature profile [C]
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit
        * Equipment sublimation capacity  total batch rate
        * Pressure bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Physics</strong>: Same corrected 1 ODE + 2 algebraic as opt_Tsh_pyomo</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (Av, Ap, Vfill)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (R0, A1, A2, T_pr_crit, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pressure bounds for optimization
- 'min' (float): Minimum pressure [Torr]
- 'max' (float): Maximum pressure [Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fixed shelf temperature profile
- 'init' (float): Initial temperature [C]
- 'setpt' (list): Temperature setpoints [C]
- 'dt_setpt' (list): Time at each setpoint [min]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability (a, b)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=24</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity. With FD, this
is the number of finite elements. With collocation and
treat_n_elements_as_effective=True, apply nfe=ceil(n_elements/ncp).</p>
              </div>
            </td>
            <td>
                  <code>24</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpret
n_elements as an effective density for comparability.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use scipy for initial guess</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation mode</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory (n_points, 7)
Same format as opt_Tsh_pyomo</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Pch_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> 
<span class="gp">... </span>    <span class="n">Pchamber</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Tshelf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="s1">&#39;setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="s1">&#39;dt_setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">1800</span><span class="p">]},</span>
<span class="gp">... </span>    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Pch.dry(): Scipy baseline optimizer</li>
<li>optimize_Tsh_pyomo(): Optimize shelf temperature only</li>
<li>optimize_Pch_Tsh_pyomo(): Optimize both controls</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Pch_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize chamber pressure trajectory for minimum drying time (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Pch.dry(), optimizing chamber</span>
<span class="sd">    pressure trajectory while keeping shelf temperature fixed.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variable: Pch(t) - chamber pressure trajectory [Torr]</span>
<span class="sd">        - Fixed parameter: Tsh(t) - shelf temperature profile [C]</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Pressure bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Physics**: Same corrected 1 ODE + 2 algebraic as opt_Tsh_pyomo</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (Av, Ap, Vfill)</span>
<span class="sd">        product (dict): Product properties (R0, A1, A2, T_pr_crit, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Pchamber (dict): Pressure bounds for optimization</span>
<span class="sd">            - &#39;min&#39; (float): Minimum pressure [Torr]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum pressure [Torr]</span>
<span class="sd">        Tshelf (dict): Fixed shelf temperature profile</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">            - &#39;setpt&#39; (list): Temperature setpoints [C]</span>
<span class="sd">            - &#39;dt_setpt&#39; (list): Time at each setpoint [min]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment capability (a, b)</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        n_elements (int, default=24): Discretization granularity. With FD, this</span>
<span class="sd">            is the number of finite elements. With collocation and</span>
<span class="sd">            treat_n_elements_as_effective=True, apply nfe=ceil(n_elements/ncp).</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per element.</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): Interpret</span>
<span class="sd">            n_elements as an effective density for comparability.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Use scipy for initial guess</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>
<span class="sd">        simulation_mode (bool, default=False): Validation mode</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory (n_points, 7)</span>
<span class="sd">            Same format as opt_Tsh_pyomo</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Pch_pyomo(</span>
<span class="sd">        ...     vial, product, ht, </span>
<span class="sd">        ...     Pchamber={&#39;min&#39;: 0.06, &#39;max&#39;: 0.20},</span>
<span class="sd">        ...     Tshelf={&#39;init&#39;: -35, &#39;setpt&#39;: [-20, 20], &#39;dt_setpt&#39;: [180, 1800]},</span>
<span class="sd">        ...     dt=0.01, eq_cap=eq_cap, nVial=398</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Pch.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Tsh_pyomo(): Optimize shelf temperature only</span>
<span class="sd">        - optimize_Pch_Tsh_pyomo(): Optimize both controls</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Pch</span>

    <span class="c1"># Create model with Pch optimization mode</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>
    <span class="p">)</span>

    <span class="c1"># Warmstart from scipy</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Pch</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Fix shelf temperature to scipy trajectory</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

        <span class="c1"># Validate</span>
        <span class="k">if</span> <span class="n">tee</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="c1"># Solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.optimize_Tsh_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Tsh_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Optimize shelf temperature trajectory for minimum drying time (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Tsh.dry(), providing a multi-period
optimization formulation with improved physics (1 ODE + 2 algebraic constraints).</p>
<p>Following the coexistence philosophy: this complements (not replaces) the scipy optimizer.
Scipy optimizer uses quasi-steady-state with fsolve at each timestep.
Pyomo uses simultaneous discretization with algebraic energy balance.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variable: Tsh(t) - shelf temperature trajectory [C]
    - Fixed parameter: Pch - chamber pressure [Torr]
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit (collapse prevention)
        * Equipment sublimation capacity  total batch rate
        * Shelf temperature bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Staged Solve Framework</strong> (if warmstart_scipy=True):
    1. Feasibility: Find consistent states with fixed controls
    2. Time minimization: Optimize t_final with fixed controls
    3. Control optimization: Release Tsh for optimization
    4. Full optimization: All DOFs optimized simultaneously</p>
<p><strong>Model Structure</strong> (corrected Jan 2025):
    - 1 ODE: dLck/dt (dried cake length)
    - 2 Algebraic: energy_balance, vial_bottom_temp
    - NO ODEs for Tsub or Tbot (they are algebraic variables)
    - Validated: scipy solutions satisfy Pyomo constraints at machine precision</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry
- 'Av' (float): Vial area [cm]
- 'Ap' (float): Product area [cm]
- 'Vfill' (float): Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties
- 'R0' (float): Base resistance [cmhrTorr/g]
- 'A1' (float): Resistance parameter [cmhrTorr/g/cm]
- 'A2' (float): Resistance parameter [1/cm]
- 'T_pr_crit' (float): Critical temperature [C]
- 'cSolid' (float): Solid fraction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer (Pikal correlation)
- 'KC' (float): Contact conduction [cal/s/K/cm]
- 'KP' (float): Gas conduction [cal/s/K/cm/Torr]
- 'KD' (float): Pressure correction [1/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fixed chamber pressure settings
- 'setpt' (list): Pressure setpoint(s) [Torr]
- 'dt_setpt' (list): Time at each setpoint [min]
- 'ramp_rate' (float): Ramp rate [Torr/min] (optional)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shelf temperature bounds for optimization
- 'min' (float): Minimum temperature [C]
- 'max' (float): Maximum temperature [C]
- 'init' (float): Initial temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment sublimation capacity
- 'a' (float): Intercept [kg/hr]
- 'b' (float): Slope [kg/hr/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials in batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=24</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity. With finite
differences, this is the number of finite elements. With
collocation and treat_n_elements_as_effective=True, this value is
treated as the effective density and the applied nfe becomes
ceil(n_elements/n_collocation).</p>
              </div>
            </td>
            <td>
                  <code>24</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per finite element
(unused for finite differences).</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use
LAGRANGE-RADAU collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When using
collocation, interpret n_elements as effective density so that the
total number of discretization points (nfe*ncp) is comparable to
finite differences with nfe.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialize from scipy opt_Tsh solution</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, fix all vars and just validate</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory with shape (n_points, 7)
- Column 0: Time [hr]
- Column 1: Sublimation temperature Tsub [C]
- Column 2: Vial bottom temperature Tbot [C]
- Column 3: Shelf temperature Tsh [C]
- Column 4: Chamber pressure Pch [mTorr] (note: milli-Torr!)
- Column 5: Sublimation flux [kg/hr/m]
- Column 6: Fraction dried [0-1] (note: NOT percentage!)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If optimization fails and no solution available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li><strong>Warmstart strongly recommended</strong>: Set warmstart_scipy=True for robust convergence</li>
<li>Model validates scipy solutions at residuals ~1e-7 (machine precision)</li>
<li>Recommended mesh for FD: 24 elements (8 is too coarse)</li>
<li>For collocation, enable treat_n_elements_as_effective to keep total points comparable to FD</li>
<li>Typical speedup: 5-10% faster than scipy (discretization vs integration)</li>
<li>Staged solve improves robustness vs. direct full optimization</li>
<li>simulation_mode validates model without optimization (debugging)</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Optimize shelf temperature with fixed pressure</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vial</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.8</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">,</span> <span class="s1">&#39;Vfill&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;cSolid&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ht</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">0.000275</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">0.000893</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Pchamber</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">],</span> <span class="s1">&#39;dt_setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1800</span><span class="p">],</span> <span class="s1">&#39;ramp_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tshelf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq_cap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.182</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">11.7</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Tsh_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drying time: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final dryness: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Tsh.dry(): Scipy baseline optimizer</li>
<li>optimize_Pch_pyomo(): Optimize pressure only</li>
<li>optimize_Pch_Tsh_pyomo(): Optimize both controls</li>
<li>create_optimizer_model(): Create Pyomo model</li>
<li>staged_solve(): 4-stage convergence framework</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Tsh_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize shelf temperature trajectory for minimum drying time (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Tsh.dry(), providing a multi-period</span>
<span class="sd">    optimization formulation with improved physics (1 ODE + 2 algebraic constraints).</span>

<span class="sd">    Following the coexistence philosophy: this complements (not replaces) the scipy optimizer.</span>
<span class="sd">    Scipy optimizer uses quasi-steady-state with fsolve at each timestep.</span>
<span class="sd">    Pyomo uses simultaneous discretization with algebraic energy balance.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variable: Tsh(t) - shelf temperature trajectory [C]</span>
<span class="sd">        - Fixed parameter: Pch - chamber pressure [Torr]</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit (collapse prevention)</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Shelf temperature bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Staged Solve Framework** (if warmstart_scipy=True):</span>
<span class="sd">        1. Feasibility: Find consistent states with fixed controls</span>
<span class="sd">        2. Time minimization: Optimize t_final with fixed controls</span>
<span class="sd">        3. Control optimization: Release Tsh for optimization</span>
<span class="sd">        4. Full optimization: All DOFs optimized simultaneously</span>

<span class="sd">    **Model Structure** (corrected Jan 2025):</span>
<span class="sd">        - 1 ODE: dLck/dt (dried cake length)</span>
<span class="sd">        - 2 Algebraic: energy_balance, vial_bottom_temp</span>
<span class="sd">        - NO ODEs for Tsub or Tbot (they are algebraic variables)</span>
<span class="sd">        - Validated: scipy solutions satisfy Pyomo constraints at machine precision</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry</span>
<span class="sd">            - &#39;Av&#39; (float): Vial area [cm]</span>
<span class="sd">            - &#39;Ap&#39; (float): Product area [cm]</span>
<span class="sd">            - &#39;Vfill&#39; (float): Fill volume [mL]</span>
<span class="sd">        product (dict): Product properties</span>
<span class="sd">            - &#39;R0&#39; (float): Base resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;A1&#39; (float): Resistance parameter [cmhrTorr/g/cm]</span>
<span class="sd">            - &#39;A2&#39; (float): Resistance parameter [1/cm]</span>
<span class="sd">            - &#39;T_pr_crit&#39; (float): Critical temperature [C]</span>
<span class="sd">            - &#39;cSolid&#39; (float): Solid fraction</span>
<span class="sd">        ht (dict): Heat transfer (Pikal correlation)</span>
<span class="sd">            - &#39;KC&#39; (float): Contact conduction [cal/s/K/cm]</span>
<span class="sd">            - &#39;KP&#39; (float): Gas conduction [cal/s/K/cm/Torr]</span>
<span class="sd">            - &#39;KD&#39; (float): Pressure correction [1/Torr]</span>
<span class="sd">        Pchamber (dict): Fixed chamber pressure settings</span>
<span class="sd">            - &#39;setpt&#39; (list): Pressure setpoint(s) [Torr]</span>
<span class="sd">            - &#39;dt_setpt&#39; (list): Time at each setpoint [min]</span>
<span class="sd">            - &#39;ramp_rate&#39; (float): Ramp rate [Torr/min] (optional)</span>
<span class="sd">        Tshelf (dict): Shelf temperature bounds for optimization</span>
<span class="sd">            - &#39;min&#39; (float): Minimum temperature [C]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum temperature [C]</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment sublimation capacity</span>
<span class="sd">            - &#39;a&#39; (float): Intercept [kg/hr]</span>
<span class="sd">            - &#39;b&#39; (float): Slope [kg/hr/Torr]</span>
<span class="sd">        nVial (int): Number of vials in batch</span>
<span class="sd">        n_elements (int, default=24): Discretization granularity. With finite</span>
<span class="sd">            differences, this is the number of finite elements. With</span>
<span class="sd">            collocation and treat_n_elements_as_effective=True, this value is</span>
<span class="sd">            treated as the effective density and the applied nfe becomes</span>
<span class="sd">            ceil(n_elements/n_collocation).</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per finite element</span>
<span class="sd">            (unused for finite differences).</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use</span>
<span class="sd">            LAGRANGE-RADAU collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): When using</span>
<span class="sd">            collocation, interpret n_elements as effective density so that the</span>
<span class="sd">            total number of discretization points (nfe*ncp) is comparable to</span>
<span class="sd">            finite differences with nfe.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Initialize from scipy opt_Tsh solution</span>
<span class="sd">        simulation_mode (bool, default=False): If True, fix all vars and just validate</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory with shape (n_points, 7)</span>
<span class="sd">            - Column 0: Time [hr]</span>
<span class="sd">            - Column 1: Sublimation temperature Tsub [C]</span>
<span class="sd">            - Column 2: Vial bottom temperature Tbot [C]</span>
<span class="sd">            - Column 3: Shelf temperature Tsh [C]</span>
<span class="sd">            - Column 4: Chamber pressure Pch [mTorr] (note: milli-Torr!)</span>
<span class="sd">            - Column 5: Sublimation flux [kg/hr/m]</span>
<span class="sd">            - Column 6: Fraction dried [0-1] (note: NOT percentage!)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If optimization fails and no solution available</span>

<span class="sd">    Notes:</span>
<span class="sd">        - **Warmstart strongly recommended**: Set warmstart_scipy=True for robust convergence</span>
<span class="sd">        - Model validates scipy solutions at residuals ~1e-7 (machine precision)</span>
<span class="sd">        - Recommended mesh for FD: 24 elements (8 is too coarse)</span>
<span class="sd">        - For collocation, enable treat_n_elements_as_effective to keep total points comparable to FD</span>
<span class="sd">        - Typical speedup: 5-10% faster than scipy (discretization vs integration)</span>
<span class="sd">        - Staged solve improves robustness vs. direct full optimization</span>
<span class="sd">        - simulation_mode validates model without optimization (debugging)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Optimize shelf temperature with fixed pressure</span>
<span class="sd">        &gt;&gt;&gt; vial = {&#39;Av&#39;: 3.8, &#39;Ap&#39;: 3.14, &#39;Vfill&#39;: 2.0}</span>
<span class="sd">        &gt;&gt;&gt; product = {&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0, &#39;cSolid&#39;: 0.05}</span>
<span class="sd">        &gt;&gt;&gt; ht = {&#39;KC&#39;: 0.000275, &#39;KP&#39;: 0.000893, &#39;KD&#39;: 0.46}</span>
<span class="sd">        &gt;&gt;&gt; Pchamber = {&#39;setpt&#39;: [0.15], &#39;dt_setpt&#39;: [1800], &#39;ramp_rate&#39;: 0.5}</span>
<span class="sd">        &gt;&gt;&gt; Tshelf = {&#39;min&#39;: -45, &#39;max&#39;: 120, &#39;init&#39;: -35}</span>
<span class="sd">        &gt;&gt;&gt; eq_cap = {&#39;a&#39;: -0.182, &#39;b&#39;: 11.7}</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Tsh_pyomo(</span>
<span class="sd">        ...     vial, product, ht, Pchamber, Tshelf, dt=0.01, eq_cap=eq_cap, nVial=398,</span>
<span class="sd">        ...     warmstart_scipy=True, tee=False</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Drying time: {result[-1, 0]:.2f} hr&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Final dryness: {result[-1, 6]*100:.1f}%&quot;)</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Tsh.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Pch_pyomo(): Optimize pressure only</span>
<span class="sd">        - optimize_Pch_Tsh_pyomo(): Optimize both controls</span>
<span class="sd">        - create_optimizer_model(): Create Pyomo model</span>
<span class="sd">        - staged_solve(): 4-stage convergence framework</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Tsh</span>

    <span class="c1"># Create model with Tsh optimization mode</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>  <span class="c1"># FD default; collocation optional</span>
    <span class="p">)</span>

    <span class="c1"># Fix chamber pressure to setpoint</span>
    <span class="n">Pch_fixed</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="p">[</span><span class="s1">&#39;setpt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">Pch_fixed</span><span class="p">)</span>

    <span class="c1"># Warmstart from scipy if requested</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Tsh</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Validate scipy trajectory on Pyomo mesh</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

        <span class="c1"># In simulation mode, fix all variables to scipy values</span>
        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver with robust options</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="c1"># Set robust IPOPT options for DAE optimization</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="c1"># Execute staged solve or direct solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Direct solve (simulation mode or no warmstart)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Check constraint violations in simulation mode</span>
    <span class="k">if</span> <span class="n">simulation_mode</span> <span class="ow">and</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Constraint Violation Check (Simulation Mode) ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver status: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Termination condition: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_infeasible_constraints</span><span class="p">:</span>
            <span class="n">log_infeasible_constraints</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual constraint check</span>
            <span class="n">violation_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">constr</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lhs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">rhs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

                        <span class="n">viol_lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">body</span><span class="p">)</span>
                        <span class="n">viol_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">body</span> <span class="o">-</span> <span class="n">rhs</span><span class="p">)</span>
                        <span class="n">viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">viol_lower</span><span class="p">,</span> <span class="n">viol_upper</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">viol</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                            <span class="n">violation_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">violation_count</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Only print first 10</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Violation in </span><span class="si">{</span><span class="n">constr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">viol</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    LHS: </span><span class="si">{</span><span class="n">lhs</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Body: </span><span class="si">{</span><span class="n">body</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, RHS: </span><span class="si">{</span><span class="n">rhs</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">if</span> <span class="n">violation_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   All constraints satisfied!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total violations: </span><span class="si">{</span><span class="n">violation_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>

    <span class="c1"># Extract solution in same format as scipy optimizer</span>
    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.optimize_multi_period" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_multi_period</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Optimize multi-period primary drying process.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of finite elements</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scipy trajectory from calc_knownRp.dry()</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver to use ('ipopt' recommended)</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable scaling</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>solution</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimized trajectories and final time
- 't': Time points [hr]
- 'Pch': Chamber pressure trajectory [Torr]
- 'Tsh': Shelf temperature trajectory [C]
- 'Tsub': Sublimation temperature trajectory [C]
- 'Tbot': Vial bottom temperature trajectory [C]
- 'Lck': Dried cake length trajectory [cm]
- 'dmdt': Sublimation rate trajectory [kg/hr]
- 't_final': Total drying time [hr]
- 'status': Solver termination status</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="lyopronto.pyomo_models.optimize_multi_period--get-scipy-warmstart">Get scipy warmstart</h4>
<p>scipy_traj = calc_knownRp.dry(vial, product, ht, 2.0, -10.0, 0.1)
solution = optimize_multi_period(
...     vial, product, ht, Vfill=2.0, warmstart_data=scipy_traj
... )
print(f"Optimal drying time: {solution['t_final']:.2f} hr")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_multi_period</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Vfill</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">warmstart_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize multi-period primary drying process.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial parameters</span>
<span class="sd">        product (dict): Product parameters</span>
<span class="sd">        ht (dict): Heat transfer parameters</span>
<span class="sd">        Vfill (float): Fill volume [mL]</span>
<span class="sd">        n_elements (int): Number of finite elements</span>
<span class="sd">        n_collocation (int): Collocation points per element</span>
<span class="sd">        warmstart_data (ndarray, optional): Scipy trajectory from calc_knownRp.dry()</span>
<span class="sd">        solver (str): Solver to use (&#39;ipopt&#39; recommended)</span>
<span class="sd">        tee (bool): Print solver output</span>
<span class="sd">        apply_scaling (bool): Apply variable scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        solution (dict): Optimized trajectories and final time</span>
<span class="sd">            - &#39;t&#39;: Time points [hr]</span>
<span class="sd">            - &#39;Pch&#39;: Chamber pressure trajectory [Torr]</span>
<span class="sd">            - &#39;Tsh&#39;: Shelf temperature trajectory [C]</span>
<span class="sd">            - &#39;Tsub&#39;: Sublimation temperature trajectory [C]</span>
<span class="sd">            - &#39;Tbot&#39;: Vial bottom temperature trajectory [C]</span>
<span class="sd">            - &#39;Lck&#39;: Dried cake length trajectory [cm]</span>
<span class="sd">            - &#39;dmdt&#39;: Sublimation rate trajectory [kg/hr]</span>
<span class="sd">            - &#39;t_final&#39;: Total drying time [hr]</span>
<span class="sd">            - &#39;status&#39;: Solver termination status</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Get scipy warmstart</span>
<span class="sd">        &gt;&gt;&gt; scipy_traj = calc_knownRp.dry(vial, product, ht, 2.0, -10.0, 0.1)</span>
<span class="sd">        &gt;&gt;&gt; solution = optimize_multi_period(</span>
<span class="sd">        ...     vial, product, ht, Vfill=2.0, warmstart_data=scipy_traj</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal drying time: {solution[&#39;t_final&#39;]:.2f} hr&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_multi_period_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="n">apply_scaling</span>
    <span class="p">)</span>

    <span class="c1"># Apply warmstart if provided</span>
    <span class="k">if</span> <span class="n">warmstart_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warmstart_from_scipy_trajectory</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

    <span class="c1"># Solve</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;sb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>  <span class="c1"># Skip barrier initialization</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Extract solution</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="p">),</span>
        <span class="s1">&#39;t_final&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Extract trajectories</span>
    <span class="n">t_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span> <span class="o">*</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;t_final&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Lck&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Rp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.optimize_single_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_single_step</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convenience function to create and solve single-step model in one call.</p>
<p>This function combines create_single_step_model() and solve_single_step()
for ease of use when you don't need to inspect the model structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lpr0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial product length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lck</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current dried cake length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pch_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chamber pressure bounds [Torr]</p>
              </div>
            </td>
            <td>
                  <code>(0.05, 0.5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tsh_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shelf temperature bounds [C]</p>
              </div>
            </td>
            <td>
                  <code>(-50, 50)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability parameters</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial variable values</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name (default: 'ipopt')</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable scaling (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution dictionary (see solve_single_step)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">optimize_single_step</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.8</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">product</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">ht</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">2.75e-4</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">8.93e-4</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Lpr0</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Lck</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">tee</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_single_step</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span>
                        <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
                        <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
                        <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to create and solve single-step model in one call.</span>

<span class="sd">    This function combines create_single_step_model() and solve_single_step()</span>
<span class="sd">    for ease of use when you don&#39;t need to inspect the model structure.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (see create_single_step_model)</span>
<span class="sd">        product (dict): Product properties (see create_single_step_model)</span>
<span class="sd">        ht (dict): Heat transfer parameters (see create_single_step_model)</span>
<span class="sd">        Lpr0 (float): Initial product length [cm]</span>
<span class="sd">        Lck (float): Current dried cake length [cm]</span>
<span class="sd">        Pch_bounds (tuple): Chamber pressure bounds [Torr]</span>
<span class="sd">        Tsh_bounds (tuple): Shelf temperature bounds [C]</span>
<span class="sd">        eq_cap (dict): Equipment capability parameters</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        warmstart_data (dict): Initial variable values</span>
<span class="sd">        solver (str): Solver name (default: &#39;ipopt&#39;)</span>
<span class="sd">        tee (bool): Print solver output (default: False)</span>
<span class="sd">        apply_scaling (bool): Apply variable scaling (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Solution dictionary (see solve_single_step)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; solution = optimize_single_step(</span>
<span class="sd">        ...     vial={&#39;Av&#39;: 3.8, &#39;Ap&#39;: 3.14},</span>
<span class="sd">        ...     product={&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0},</span>
<span class="sd">        ...     ht={&#39;KC&#39;: 2.75e-4, &#39;KP&#39;: 8.93e-4, &#39;KD&#39;: 0.46},</span>
<span class="sd">        ...     Lpr0=1.5,</span>
<span class="sd">        ...     Lck=0.5,</span>
<span class="sd">        ...     tee=True</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create and solve</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span>
        <span class="n">Pch_bounds</span><span class="o">=</span><span class="n">Pch_bounds</span><span class="p">,</span>
        <span class="n">Tsh_bounds</span><span class="o">=</span><span class="n">Tsh_bounds</span><span class="p">,</span>
        <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span>
        <span class="n">nVial</span><span class="o">=</span><span class="n">nVial</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="n">apply_scaling</span>
    <span class="p">)</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
        <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">,</span>
        <span class="n">warmstart_data</span><span class="o">=</span><span class="n">warmstart_data</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.solve_single_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Solve Pyomo single-step model and extract results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model created by create_single_step_model()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name. Default: 'ipopt'</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print solver output. Default: False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values for variables with keys:
'Pch', 'Tsh', 'Tsub', 'Tbot', 'Psub', 'dmdt', 'Kv'.
If provided, these values are used to initialize the model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution dictionary with keys:
- 'status' (str): Solver termination condition
- 'Pch' (float): Chamber pressure [Torr]
- 'Tsh' (float): Shelf temperature [C]
- 'Tsub' (float): Sublimation front temperature [C]
- 'Tbot' (float): Vial bottom temperature [C]
- 'Psub' (float): Vapor pressure [Torr]
- 'dmdt' (float): Sublimation rate [kg/hr]
- 'Kv' (float): Vial heat transfer coefficient [cal/s/K/cm]
- 'Rp' (float): Product resistance [cmhrTorr/g]
- 'obj' (float): Objective value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If solver is not available or fails to solve.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>For IPOPT solver, the following options are used:
- max_iter: 3000
- tol: 1e-6
- mu_strategy: 'adaptive'
- print_level: 5 (if tee=True), 0 (if tee=False)</p>
<p>If IPOPT is not in PATH, will attempt to use IDAES-provided IPOPT.</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal Pch: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> Torr&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal Tsh: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> C&quot;</span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve Pyomo single-step model and extract results.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (pyo.ConcreteModel): Pyomo model created by create_single_step_model()</span>
<span class="sd">        solver (str, optional): Solver name. Default: &#39;ipopt&#39;</span>
<span class="sd">        tee (bool, optional): If True, print solver output. Default: False</span>
<span class="sd">        warmstart_data (dict, optional): Initial values for variables with keys:</span>
<span class="sd">            &#39;Pch&#39;, &#39;Tsh&#39;, &#39;Tsub&#39;, &#39;Tbot&#39;, &#39;Psub&#39;, &#39;dmdt&#39;, &#39;Kv&#39;.</span>
<span class="sd">            If provided, these values are used to initialize the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Solution dictionary with keys:</span>
<span class="sd">            - &#39;status&#39; (str): Solver termination condition</span>
<span class="sd">            - &#39;Pch&#39; (float): Chamber pressure [Torr]</span>
<span class="sd">            - &#39;Tsh&#39; (float): Shelf temperature [C]</span>
<span class="sd">            - &#39;Tsub&#39; (float): Sublimation front temperature [C]</span>
<span class="sd">            - &#39;Tbot&#39; (float): Vial bottom temperature [C]</span>
<span class="sd">            - &#39;Psub&#39; (float): Vapor pressure [Torr]</span>
<span class="sd">            - &#39;dmdt&#39; (float): Sublimation rate [kg/hr]</span>
<span class="sd">            - &#39;Kv&#39; (float): Vial heat transfer coefficient [cal/s/K/cm]</span>
<span class="sd">            - &#39;Rp&#39; (float): Product resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;obj&#39; (float): Objective value</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If solver is not available or fails to solve.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For IPOPT solver, the following options are used:</span>
<span class="sd">        - max_iter: 3000</span>
<span class="sd">        - tol: 1e-6</span>
<span class="sd">        - mu_strategy: &#39;adaptive&#39;</span>
<span class="sd">        - print_level: 5 (if tee=True), 0 (if tee=False)</span>

<span class="sd">        If IPOPT is not in PATH, will attempt to use IDAES-provided IPOPT.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; model = create_single_step_model(vial, product, ht, Lpr0, Lck)</span>
<span class="sd">        &gt;&gt;&gt; solution = solve_single_step(model, tee=True)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal Pch: {solution[&#39;Pch&#39;]:.4f} Torr&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal Tsh: {solution[&#39;Tsh&#39;]:.2f} C&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply warmstart values if provided</span>
    <span class="k">if</span> <span class="n">warmstart_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Pch&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tsh&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tsub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tbot&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Psub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;log_Psub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;log_Psub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;dmdt&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Kv&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Kv&#39;</span><span class="p">])</span>

    <span class="c1"># Create solver - try IDAES first if available, then standard Pyomo</span>
    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="c1"># Fall back to standard Pyomo solver</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="c1"># Configure IPOPT options</span>
    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Check convergence</span>
    <span class="n">termination</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span>
    <span class="n">status_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">termination</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">termination</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">,</span> 
                           <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">locallyOptimal</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Solver status: </span><span class="si">{</span><span class="n">termination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract solution</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status_str</span><span class="p">,</span>
        <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">),</span>
        <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">),</span>
        <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">),</span>
        <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">),</span>
        <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">),</span>
        <span class="s1">&#39;log_Psub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">),</span>
        <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">),</span>
        <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">),</span>
        <span class="s1">&#39;Rp&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">),</span>
        <span class="s1">&#39;obj&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="lyopronto.pyomo_models.warmstart_from_scipy_trajectory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">warmstart_from_scipy_trajectory</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_trajectory</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize Pyomo DAE model from scipy trajectory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model to initialize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scipy_trajectory</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output from calc_knownRp.dry()
Columns: [time, Tsub, Tbot, Tsh, Pch, flux, frac_dried]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters (needed for Lck calculation)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters (needed for Lck calculation)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">warmstart_from_scipy_trajectory</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">scipy_trajectory</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Pyomo DAE model from scipy trajectory.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ConcreteModel): Pyomo model to initialize</span>
<span class="sd">        scipy_trajectory (ndarray): Output from calc_knownRp.dry()</span>
<span class="sd">            Columns: [time, Tsub, Tbot, Tsh, Pch, flux, frac_dried]</span>
<span class="sd">        vial (dict): Vial parameters (needed for Lck calculation)</span>
<span class="sd">        product (dict): Product parameters (needed for Lck calculation)</span>
<span class="sd">        ht (dict): Heat transfer parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract data from scipy trajectory</span>
    <span class="n">t_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Time [hr]</span>
    <span class="n">Tsub_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Tsub [C]</span>
    <span class="n">Tbot_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Tbot [C]</span>
    <span class="n">Tsh_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Tsh [C]</span>
    <span class="n">Pch_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># Pch [Torr] (from mTorr)</span>
    <span class="n">frac_dried_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># Fraction dried [0-1]</span>

    <span class="c1"># Get Pyomo time points (normalized to [0, 1])</span>
    <span class="n">t_pyomo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Compute initial product length from vial parameters</span>
    <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span>
        <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span>
        <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Initialize t_final</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">t_scipy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Interpolate scipy data to Pyomo time points</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t_norm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t_pyomo</span><span class="p">):</span>
        <span class="n">t_actual</span> <span class="o">=</span> <span class="n">t_norm</span> <span class="o">*</span> <span class="n">t_scipy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Interpolate scipy data</span>
        <span class="n">Tsub_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tsub_scipy</span><span class="p">)</span>
        <span class="n">Tbot_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tbot_scipy</span><span class="p">)</span>
        <span class="n">Tsh_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tsh_scipy</span><span class="p">)</span>
        <span class="n">Pch_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Pch_scipy</span><span class="p">)</span>
        <span class="n">frac_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">frac_dried_scipy</span><span class="p">)</span>

        <span class="c1"># Set variable values</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tsub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tbot_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tsh_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Pch_interp</span><span class="p">)</span>

        <span class="c1"># Compute Lck from fraction dried</span>
        <span class="n">Lck_interp</span> <span class="o">=</span> <span class="n">frac_interp</span> <span class="o">*</span> <span class="n">Lpr0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Lck_interp</span><span class="p">)</span>

        <span class="c1"># Compute algebraic variables</span>
        <span class="n">Psub_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">Tsub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Psub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Psub_interp</span><span class="p">))</span>

        <span class="n">Kv_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Kv_FUN</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">],</span> <span class="n">Pch_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Kv_interp</span><span class="p">)</span>

        <span class="n">Rp_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Rp_FUN</span><span class="p">(</span><span class="n">Lck_interp</span><span class="p">,</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Rp_interp</span><span class="p">)</span>

        <span class="c1"># Estimate dmdt from heat balance</span>
        <span class="k">if</span> <span class="n">Rp_interp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dmdt_interp</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Psub_interp</span> <span class="o">-</span> <span class="n">Pch_interp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Rp_interp</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dmdt_interp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>


<div class="doc doc-object doc-module">



<h3 id="lyopronto.pyomo_models.model" class="doc doc-heading">
            <code>model</code>


</h3>

    <div class="doc doc-contents ">

        <p>Multi-period lyophilization optimization using Pyomo DAE with orthogonal collocation.</p>
<p>This module implements dynamic optimization of the primary drying phase using:
- Pyomo's DAE (Differential-Algebraic Equations) framework
- Orthogonal collocation on finite elements for time discretization
- Log-transformed vapor pressure for numerical stability
- Variable scaling for improved conditioning</p>
<p>The model optimizes chamber pressure Pch(t) and shelf temperature Tsh(t)
trajectories over time to minimize drying time while respecting temperature
constraints.</p>
<p>Reference:
- Pyomo DAE documentation: https://pyomo.readthedocs.io/en/stable/modeling_extensions/dae.html
- Orthogonal collocation: Biegler (2010), Nonlinear Programming</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.model.create_multi_period_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_multi_period_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">t_final</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create multi-period Pyomo DAE model for primary drying optimization.</p>
<p>This creates a dynamic optimization model with:
- Time as a continuous variable discretized by collocation
- Differential equations for temperature evolution
- Algebraic equations for heat/mass transfer
- Path constraints on product temperature</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters (Av, Ap)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters (R0, A1, A2, Tpr_max, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of finite elements for time discretization</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of collocation points per element (3-5 recommended)</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>t_final</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Final time [hr] (will be optimized)</p>
              </div>
            </td>
            <td>
                  <code>10.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable/constraint scaling</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><span title="ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model ready for optimization</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="model-variables" open>
  <summary>Model Variables</summary>
  <p>Time-indexed (continuous):
- Pch(t): Chamber pressure [Torr]
- Tsh(t): Shelf temperature [C]
- Tsub(t): Sublimation front temperature [C]
- Tbot(t): Vial bottom temperature [C]
- Psub(t): Vapor pressure at sublimation front [Torr]
- log_Psub(t): Log of vapor pressure (for stability)
- dmdt(t): Sublimation rate [kg/hr]
- Kv(t): Vial heat transfer coefficient [cal/s/K/cm]
- Lck(t): Dried cake length [cm]
- Rp(t): Product resistance [cm-hr-Torr/g]</p>
<p>Scalar:
- t_final: Total drying time [hr] (optimization variable)</p>
</details>

<details class="constraints" open>
  <summary>Constraints</summary>
  <p>ODEs:
- dTsub/dt = f(heat balance, sublimation)
- dTbot/dt = f(shelf heat transfer)
- dLck/dt = dmdt * conversion_factor</p>
<p>Algebraic:
- Vapor pressure (log-transformed)
- Sublimation rate (mass transfer)
- Heat balance
- Product resistance
- Kv calculation</p>
<p>Path constraints:
- Tsub(t) &gt;= Tpr_max (product temperature limit)
- 0 &lt;= Pch(t) &lt;= 0.5 (chamber pressure bounds)
- -50 &lt;= Tsh(t) &lt;= 50 (shelf temperature bounds)</p>
</details>

<details class="objective" open>
  <summary>Objective</summary>
  <p>Minimize t_final (total drying time)</p>
</details>

<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Uses Radau collocation (right-biased, good for stiff systems)</li>
<li>Log transformation improves numerical stability</li>
<li>Scaling reduces condition number by 2-3 orders of magnitude</li>
<li>Warmstart from scipy trajectory recommended</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_multi_period_model</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Vfill</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">t_final</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create multi-period Pyomo DAE model for primary drying optimization.</span>

<span class="sd">    This creates a dynamic optimization model with:</span>
<span class="sd">    - Time as a continuous variable discretized by collocation</span>
<span class="sd">    - Differential equations for temperature evolution</span>
<span class="sd">    - Algebraic equations for heat/mass transfer</span>
<span class="sd">    - Path constraints on product temperature</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial parameters (Av, Ap)</span>
<span class="sd">        product (dict): Product parameters (R0, A1, A2, Tpr_max, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Vfill (float): Fill volume [mL]</span>
<span class="sd">        n_elements (int): Number of finite elements for time discretization</span>
<span class="sd">        n_collocation (int): Number of collocation points per element (3-5 recommended)</span>
<span class="sd">        t_final (float): Final time [hr] (will be optimized)</span>
<span class="sd">        apply_scaling (bool): Apply variable/constraint scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (ConcreteModel): Pyomo model ready for optimization</span>

<span class="sd">    Model Variables:</span>
<span class="sd">        Time-indexed (continuous):</span>
<span class="sd">        - Pch(t): Chamber pressure [Torr]</span>
<span class="sd">        - Tsh(t): Shelf temperature [C]</span>
<span class="sd">        - Tsub(t): Sublimation front temperature [C]</span>
<span class="sd">        - Tbot(t): Vial bottom temperature [C]</span>
<span class="sd">        - Psub(t): Vapor pressure at sublimation front [Torr]</span>
<span class="sd">        - log_Psub(t): Log of vapor pressure (for stability)</span>
<span class="sd">        - dmdt(t): Sublimation rate [kg/hr]</span>
<span class="sd">        - Kv(t): Vial heat transfer coefficient [cal/s/K/cm]</span>
<span class="sd">        - Lck(t): Dried cake length [cm]</span>
<span class="sd">        - Rp(t): Product resistance [cm-hr-Torr/g]</span>

<span class="sd">        Scalar:</span>
<span class="sd">        - t_final: Total drying time [hr] (optimization variable)</span>

<span class="sd">    Constraints:</span>
<span class="sd">        ODEs:</span>
<span class="sd">        - dTsub/dt = f(heat balance, sublimation)</span>
<span class="sd">        - dTbot/dt = f(shelf heat transfer)</span>
<span class="sd">        - dLck/dt = dmdt * conversion_factor</span>

<span class="sd">        Algebraic:</span>
<span class="sd">        - Vapor pressure (log-transformed)</span>
<span class="sd">        - Sublimation rate (mass transfer)</span>
<span class="sd">        - Heat balance</span>
<span class="sd">        - Product resistance</span>
<span class="sd">        - Kv calculation</span>

<span class="sd">        Path constraints:</span>
<span class="sd">        - Tsub(t) &gt;= Tpr_max (product temperature limit)</span>
<span class="sd">        - 0 &lt;= Pch(t) &lt;= 0.5 (chamber pressure bounds)</span>
<span class="sd">        - -50 &lt;= Tsh(t) &lt;= 50 (shelf temperature bounds)</span>

<span class="sd">    Objective:</span>
<span class="sd">        Minimize t_final (total drying time)</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Uses Radau collocation (right-biased, good for stiff systems)</span>
<span class="sd">        - Log transformation improves numerical stability</span>
<span class="sd">        - Scaling reduces condition number by 2-3 orders of magnitude</span>
<span class="sd">        - Warmstart from scipy trajectory recommended</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1"># Extract parameters</span>
    <span class="n">Av</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">]</span>
    <span class="n">Ap</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span>
    <span class="n">R0</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
    <span class="n">Tpr_max</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tpr_max&#39;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T_pr_crit&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">25.0</span><span class="p">))</span>  <span class="c1"># Handle both naming conventions</span>
    <span class="n">cSolid</span> <span class="o">=</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">]</span>
    <span class="n">KC</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">]</span>
    <span class="n">KP</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">]</span>
    <span class="n">KD</span> <span class="o">=</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">]</span>

    <span class="c1"># Compute initial product length</span>
    <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="n">Vfill</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">cSolid</span><span class="p">)</span>

    <span class="c1"># Physical constants</span>
    <span class="n">dHs</span> <span class="o">=</span> <span class="mf">677.0</span>  <span class="c1"># Heat of sublimation [cal/g]</span>

    <span class="c1"># ======================</span>
    <span class="c1"># TIME DOMAIN</span>
    <span class="c1"># ======================</span>

    <span class="n">model</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">ContinuousSet</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Normalized time [0, 1]</span>

    <span class="c1"># Actual time scaling factor (to be optimized)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">t_final</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># STATE VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Temperatures [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">20.0</span><span class="p">)</span>

    <span class="c1"># Dried cake length [cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># CONTROL VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Chamber pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Shelf temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># ALGEBRAIC VARIABLES</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Vapor pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># Sublimation rate [kg/hr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>

    <span class="c1"># Product resistance [cm-hr-Torr/g]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="n">R0</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># DERIVATIVES</span>
    <span class="c1"># ======================</span>

    <span class="n">model</span><span class="o">.</span><span class="n">dTsub_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dTbot_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dLck_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># ALGEBRAIC CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_log_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log transformation of Antoine equation for vapor pressure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6144.96</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_log</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_log_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_exp_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exponential recovery of vapor pressure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_exp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_exp_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">product_resistance_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product resistance as function of dried cake length.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">R0</span> <span class="o">+</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">product_resistance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">product_resistance_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">kv_calc_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial heat transfer coefficient.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">KC</span> <span class="o">+</span> <span class="n">KP</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">KD</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">model</span><span class="o">.</span><span class="n">kv_calc</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">kv_calc_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sublimation_rate_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mass transfer equation for sublimation rate.&quot;&quot;&quot;</span>
        <span class="c1"># dmdt in kg/hr, normalize by area</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ap</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

    <span class="n">model</span><span class="o">.</span><span class="n">sublimation_rate</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">sublimation_rate_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># DIFFERENTIAL EQUATIONS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heat_balance_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy balance at sublimation front.</span>

<span class="sd">        Heat in from shelf = Heat consumed by sublimation</span>
<span class="sd">        This determines the rate of change of Tsub.</span>

<span class="sd">        For simplicity, we use a quasi-steady approximation where</span>
<span class="sd">        the sublimation front temperature adjusts rapidly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="c1"># Heat from shelf [cal/hr]</span>
        <span class="n">Q_shelf</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">Av</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span>

        <span class="c1"># Heat for sublimation [cal/hr]</span>
        <span class="n">Q_sub</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">dHs</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># kg/hr * cal/g * 1000 g/kg</span>

        <span class="c1"># Simplified ODE: rate of Tsub change proportional to imbalance</span>
        <span class="c1"># This is a relaxation; in reality Tsub adjusts to maintain balance</span>
        <span class="n">tau_thermal</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Thermal time constant [hr]</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dTsub_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">Q_shelf</span> <span class="o">-</span> <span class="n">Q_sub</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau_thermal</span> <span class="o">*</span> <span class="n">Q_sub</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">heat_balance_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">heat_balance_ode_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vial_bottom_temp_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial bottom temperature dynamics.</span>

<span class="sd">        Tbot tracks Tsh with thermal lag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="n">tau_vial</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Vial thermal time constant [hr]</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dTbot_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">/</span> <span class="n">tau_vial</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">vial_bottom_temp_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vial_bottom_temp_ode_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cake_length_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dried cake length increases with sublimation.</span>

<span class="sd">        dLck/dt = dmdt / (Ap * rho_ice * (1 - cSolid))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="o">.</span><span class="n">Skip</span>

        <span class="n">rho_ice</span> <span class="o">=</span> <span class="mf">0.92</span>  <span class="c1"># Density of ice [g/cm]</span>

        <span class="c1"># Convert dmdt [kg/hr] to [g/hr], divide by area and density</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dLck_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ap</span> <span class="o">*</span> <span class="n">rho_ice</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cSolid</span><span class="p">))</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span>

    <span class="n">model</span><span class="o">.</span><span class="n">cake_length_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">cake_length_ode_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># INITIAL CONDITIONS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tsub_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial sublimation temperature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">40.0</span>  <span class="c1"># Start cold</span>

    <span class="n">model</span><span class="o">.</span><span class="n">tsub_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">tsub_ic_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tbot_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial vial bottom temperature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">40.0</span>  <span class="c1"># Start at shelf temp</span>

    <span class="n">model</span><span class="o">.</span><span class="n">tbot_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">tbot_ic_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lck_ic_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initial cake length is zero.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>

    <span class="n">model</span><span class="o">.</span><span class="n">lck_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">lck_ic_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># TERMINAL CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final_dryness_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure drying is complete at final time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">Lpr0</span>  <span class="c1"># 95% dried</span>

    <span class="n">model</span><span class="o">.</span><span class="n">final_dryness</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">final_dryness_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># PATH CONSTRAINTS</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temp_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product temperature must not exceed maximum.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Tpr_max</span>

    <span class="n">model</span><span class="o">.</span><span class="n">temp_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">temp_limit_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># OBJECTIVE</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Minimize total drying time</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># APPLY DISCRETIZATION</span>
    <span class="c1"># ======================</span>

    <span class="n">discretizer</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;dae.collocation&#39;</span><span class="p">)</span>
    <span class="n">discretizer</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">nfe</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">ncp</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;LAGRANGE-RADAU&#39;</span>  <span class="c1"># Right-biased, good for stiff systems</span>
    <span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># APPLY SCALING</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">apply_scaling</span><span class="p">:</span>
        <span class="c1"># Scaling factors (based on typical magnitudes)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="o">.</span><span class="n">EXPORT</span><span class="p">)</span>

        <span class="c1"># Variables</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="c1"># Temperatures already O(10)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Pressures already O(0.1-1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Sublimation rate O(1) -&gt; scale to O(1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="c1"># Kv O(1e-4) -&gt; scale to O(0.1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1000.0</span>

            <span class="c1"># Rp O(10-100) -&gt; scale to O(1)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.01</span>

            <span class="c1"># Lck O(1) already good</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Derivatives (per normalized time)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dTsub_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dTbot_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dLck_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Scalar variables</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># Apply scaling transformation</span>
        <span class="n">scaling_transform</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;core.scale_model&#39;</span><span class="p">)</span>
        <span class="n">scaled_model</span> <span class="o">=</span> <span class="n">scaling_transform</span><span class="o">.</span><span class="n">create_using</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scaled_model</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.model.optimize_multi_period" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_multi_period</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize multi-period primary drying process.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of finite elements</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scipy trajectory from calc_knownRp.dry()</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver to use ('ipopt' recommended)</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable scaling</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>solution</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimized trajectories and final time
- 't': Time points [hr]
- 'Pch': Chamber pressure trajectory [Torr]
- 'Tsh': Shelf temperature trajectory [C]
- 'Tsub': Sublimation temperature trajectory [C]
- 'Tbot': Vial bottom temperature trajectory [C]
- 'Lck': Dried cake length trajectory [cm]
- 'dmdt': Sublimation rate trajectory [kg/hr]
- 't_final': Total drying time [hr]
- 'status': Solver termination status</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h5 id="lyopronto.pyomo_models.model.optimize_multi_period--get-scipy-warmstart">Get scipy warmstart</h5>
<p>scipy_traj = calc_knownRp.dry(vial, product, ht, 2.0, -10.0, 0.1)
solution = optimize_multi_period(
...     vial, product, ht, Vfill=2.0, warmstart_data=scipy_traj
... )
print(f"Optimal drying time: {solution['t_final']:.2f} hr")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_multi_period</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Vfill</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">warmstart_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize multi-period primary drying process.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial parameters</span>
<span class="sd">        product (dict): Product parameters</span>
<span class="sd">        ht (dict): Heat transfer parameters</span>
<span class="sd">        Vfill (float): Fill volume [mL]</span>
<span class="sd">        n_elements (int): Number of finite elements</span>
<span class="sd">        n_collocation (int): Collocation points per element</span>
<span class="sd">        warmstart_data (ndarray, optional): Scipy trajectory from calc_knownRp.dry()</span>
<span class="sd">        solver (str): Solver to use (&#39;ipopt&#39; recommended)</span>
<span class="sd">        tee (bool): Print solver output</span>
<span class="sd">        apply_scaling (bool): Apply variable scaling</span>

<span class="sd">    Returns:</span>
<span class="sd">        solution (dict): Optimized trajectories and final time</span>
<span class="sd">            - &#39;t&#39;: Time points [hr]</span>
<span class="sd">            - &#39;Pch&#39;: Chamber pressure trajectory [Torr]</span>
<span class="sd">            - &#39;Tsh&#39;: Shelf temperature trajectory [C]</span>
<span class="sd">            - &#39;Tsub&#39;: Sublimation temperature trajectory [C]</span>
<span class="sd">            - &#39;Tbot&#39;: Vial bottom temperature trajectory [C]</span>
<span class="sd">            - &#39;Lck&#39;: Dried cake length trajectory [cm]</span>
<span class="sd">            - &#39;dmdt&#39;: Sublimation rate trajectory [kg/hr]</span>
<span class="sd">            - &#39;t_final&#39;: Total drying time [hr]</span>
<span class="sd">            - &#39;status&#39;: Solver termination status</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Get scipy warmstart</span>
<span class="sd">        &gt;&gt;&gt; scipy_traj = calc_knownRp.dry(vial, product, ht, 2.0, -10.0, 0.1)</span>
<span class="sd">        &gt;&gt;&gt; solution = optimize_multi_period(</span>
<span class="sd">        ...     vial, product, ht, Vfill=2.0, warmstart_data=scipy_traj</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal drying time: {solution[&#39;t_final&#39;]:.2f} hr&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_multi_period_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="n">apply_scaling</span>
    <span class="p">)</span>

    <span class="c1"># Apply warmstart if provided</span>
    <span class="k">if</span> <span class="n">warmstart_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warmstart_from_scipy_trajectory</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

    <span class="c1"># Solve</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;sb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>  <span class="c1"># Skip barrier initialization</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Extract solution</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="p">),</span>
        <span class="s1">&#39;t_final&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Extract trajectories</span>
    <span class="n">t_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span> <span class="o">*</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;t_final&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Lck&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>
    <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Rp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_points</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.model.warmstart_from_scipy_trajectory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">warmstart_from_scipy_trajectory</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_trajectory</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize Pyomo DAE model from scipy trajectory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model to initialize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scipy_trajectory</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output from calc_knownRp.dry()
Columns: [time, Tsub, Tbot, Tsh, Pch, flux, frac_dried]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters (needed for Lck calculation)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters (needed for Lck calculation)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">warmstart_from_scipy_trajectory</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">scipy_trajectory</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Pyomo DAE model from scipy trajectory.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ConcreteModel): Pyomo model to initialize</span>
<span class="sd">        scipy_trajectory (ndarray): Output from calc_knownRp.dry()</span>
<span class="sd">            Columns: [time, Tsub, Tbot, Tsh, Pch, flux, frac_dried]</span>
<span class="sd">        vial (dict): Vial parameters (needed for Lck calculation)</span>
<span class="sd">        product (dict): Product parameters (needed for Lck calculation)</span>
<span class="sd">        ht (dict): Heat transfer parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract data from scipy trajectory</span>
    <span class="n">t_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Time [hr]</span>
    <span class="n">Tsub_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Tsub [C]</span>
    <span class="n">Tbot_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Tbot [C]</span>
    <span class="n">Tsh_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Tsh [C]</span>
    <span class="n">Pch_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># Pch [Torr] (from mTorr)</span>
    <span class="n">frac_dried_scipy</span> <span class="o">=</span> <span class="n">scipy_trajectory</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># Fraction dried [0-1]</span>

    <span class="c1"># Get Pyomo time points (normalized to [0, 1])</span>
    <span class="n">t_pyomo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Compute initial product length from vial parameters</span>
    <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span>
        <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span>
        <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Initialize t_final</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">t_scipy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Interpolate scipy data to Pyomo time points</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t_norm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t_pyomo</span><span class="p">):</span>
        <span class="n">t_actual</span> <span class="o">=</span> <span class="n">t_norm</span> <span class="o">*</span> <span class="n">t_scipy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Interpolate scipy data</span>
        <span class="n">Tsub_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tsub_scipy</span><span class="p">)</span>
        <span class="n">Tbot_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tbot_scipy</span><span class="p">)</span>
        <span class="n">Tsh_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Tsh_scipy</span><span class="p">)</span>
        <span class="n">Pch_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">Pch_scipy</span><span class="p">)</span>
        <span class="n">frac_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_actual</span><span class="p">,</span> <span class="n">t_scipy</span><span class="p">,</span> <span class="n">frac_dried_scipy</span><span class="p">)</span>

        <span class="c1"># Set variable values</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tsub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tbot_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Tsh_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Pch_interp</span><span class="p">)</span>

        <span class="c1"># Compute Lck from fraction dried</span>
        <span class="n">Lck_interp</span> <span class="o">=</span> <span class="n">frac_interp</span> <span class="o">*</span> <span class="n">Lpr0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Lck_interp</span><span class="p">)</span>

        <span class="c1"># Compute algebraic variables</span>
        <span class="n">Psub_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">Tsub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Psub_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Psub_interp</span><span class="p">))</span>

        <span class="n">Kv_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Kv_FUN</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">],</span> <span class="n">Pch_interp</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Kv_interp</span><span class="p">)</span>

        <span class="n">Rp_interp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Rp_FUN</span><span class="p">(</span><span class="n">Lck_interp</span><span class="p">,</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">Rp_interp</span><span class="p">)</span>

        <span class="c1"># Estimate dmdt from heat balance</span>
        <span class="k">if</span> <span class="n">Rp_interp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dmdt_interp</span> <span class="o">=</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Psub_interp</span> <span class="o">-</span> <span class="n">Pch_interp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Rp_interp</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dmdt_interp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t_norm</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="lyopronto.pyomo_models.optimizers" class="doc doc-heading">
            <code>optimizers</code>


</h3>

    <div class="doc doc-contents ">

        <p>Pyomo-based optimizers equivalent to scipy opt_Tsh, opt_Pch, opt_Pch_Tsh.</p>
<p>This module provides Pyomo multi-period optimization counterparts to the existing
scipy-based optimizers, with equipment capability constraints and control mode selection.</p>
<p>Following the coexistence philosophy: these complement (not replace) the scipy optimizers.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.add_control_tracking_penalty" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_control_tracking_penalty</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">control_refs</span><span class="p">,</span> <span class="n">tracking_weight</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add quadratic tracking penalty for controls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>control_refs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with {control_name: {t: ref_value}}</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tracking_weight</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight for tracking term</p>
              </div>
            </td>
            <td>
                  <code>100.0</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_control_tracking_penalty</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">control_refs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">tracking_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add quadratic tracking penalty for controls.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Pyomo model</span>
<span class="sd">        control_refs: Dict with {control_name: {t: ref_value}}</span>
<span class="sd">        tracking_weight: Weight for tracking term</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tracking_expr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">ctrl_name</span><span class="p">,</span> <span class="n">ref_vals</span> <span class="ow">in</span> <span class="n">control_refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ctrl_name</span><span class="p">):</span>
            <span class="n">ctrl_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ctrl_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ref_vals</span><span class="p">:</span>
                    <span class="n">tracking_expr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ctrl_var</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_vals</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Modify objective to include tracking</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;obj&#39;</span><span class="p">):</span>
        <span class="n">old_expr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">expr</span>
        <span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">obj_with_tracking</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">old_expr</span> <span class="o">+</span> <span class="n">tracking_weight</span> <span class="o">*</span> <span class="n">tracking_expr</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">tracking_obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">tracking_weight</span> <span class="o">*</span> <span class="n">tracking_expr</span><span class="p">,</span>
            <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.add_slack_variables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_slack_variables</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">constraint_names</span><span class="p">,</span> <span class="n">slack_penalty</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add slack variables to selected constraints for robustness.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>constraint_names</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of constraint names to relax</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slack_penalty</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Penalty weight for slack in objective</p>
              </div>
            </td>
            <td>
                  <code>1000.0</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_slack_variables</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">constraint_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">slack_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add slack variables to selected constraints for robustness.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Pyomo model</span>
<span class="sd">        constraint_names: List of constraint names to relax</span>
<span class="sd">        slack_penalty: Penalty weight for slack in objective</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">slacks</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">constraint_names</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">slack_penalties</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConstraintList</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">constr_name</span> <span class="ow">in</span> <span class="n">constraint_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">):</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">)</span>
            <span class="c1"># Deactivate original, add relaxed version</span>
            <span class="n">constr</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">constr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">equality</span><span class="p">:</span>
                    <span class="c1"># For equality: -slack &lt;= expr &lt;= slack</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">slack_penalties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">body</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">slacks</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">)</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">slack_penalties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">slacks</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For inequality: relax upper/lower bound</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
                    <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">slack_penalties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">body</span> <span class="o">&lt;=</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">slacks</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">slack_penalties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">body</span> <span class="o">&gt;=</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">slacks</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">])</span>

    <span class="c1"># Add penalty to objective</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;obj&#39;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>

    <span class="n">slack_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">slacks</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraint_names</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj_with_slacks</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span> <span class="o">+</span> <span class="n">slack_penalty</span> <span class="o">*</span> <span class="n">slack_sum</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.add_trust_region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_trust_region</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reference_values</span><span class="p">,</span> <span class="n">trust_radii</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add trust region constraints around reference trajectory.</p>
<p>Creates soft trust region constraints to keep controls near a reference
trajectory (typically from scipy). Useful for stabilizing joint optimization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model with control variables (Pch, Tsh)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_values</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="float">float</span>, <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reference trajectories
{'Pch': {t1: val1, t2: val2, ...}, 'Tsh': {...}}</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trust_radii</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum deviation from reference
{'Pch': radius_torr, 'Tsh': radius_degC}</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Adds constraints model.trust_region_Pch[t] and model.trust_region_Tsh[t]</li>
<li>Can be deactivated later with model.trust_region_*.deactivate()</li>
<li>Does not enforce strictly; solver may violate slightly</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_trust_region</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">reference_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">trust_radii</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add trust region constraints around reference trajectory.</span>

<span class="sd">    Creates soft trust region constraints to keep controls near a reference</span>
<span class="sd">    trajectory (typically from scipy). Useful for stabilizing joint optimization.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Pyomo model with control variables (Pch, Tsh)</span>
<span class="sd">        reference_values: Reference trajectories</span>
<span class="sd">            {&#39;Pch&#39;: {t1: val1, t2: val2, ...}, &#39;Tsh&#39;: {...}}</span>
<span class="sd">        trust_radii: Maximum deviation from reference</span>
<span class="sd">            {&#39;Pch&#39;: radius_torr, &#39;Tsh&#39;: radius_degC}</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Adds constraints model.trust_region_Pch[t] and model.trust_region_Tsh[t]</span>
<span class="sd">        - Can be deactivated later with model.trust_region_*.deactivate()</span>
<span class="sd">        - Does not enforce strictly; solver may violate slightly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;Pch&#39;</span> <span class="ow">in</span> <span class="n">reference_values</span> <span class="ow">and</span> <span class="s1">&#39;Pch&#39;</span> <span class="ow">in</span> <span class="n">trust_radii</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">trust_region_Pch_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">trust_radii</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ref</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ref</span> <span class="o">+</span> <span class="n">radius</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">trust_region_Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">trust_region_Pch_rule</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;Tsh&#39;</span> <span class="ow">in</span> <span class="n">reference_values</span> <span class="ow">and</span> <span class="s1">&#39;Tsh&#39;</span> <span class="ow">in</span> <span class="n">trust_radii</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">trust_region_Tsh_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">trust_radii</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ref</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ref</span> <span class="o">+</span> <span class="n">radius</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">trust_region_Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">trust_region_Tsh_rule</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.create_optimizer_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_optimizer_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Vfill</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">Pchamber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tshelf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">initial_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create Pyomo.DAE model for lyophilization primary drying optimization.</p>
<p>This function creates a Pyomo optimization model with corrected physics:
- <strong>1 ODE</strong>: dLck/dt (dried cake length growth)
- <strong>2 Algebraic constraints</strong>: energy_balance, vial_bottom_temp
- <strong>No ODE states for Tsub or Tbot</strong> (they are algebraic variables)</p>
<p>This structure matches the scipy implementation which uses quasi-steady-state:
scipy solves energy balance and vial temp algebraically at each timestep via fsolve.</p>
<p>Key Physics Corrections (Jan 2025):
- Removed dTsub/dt and dTbot/dt ODEs (caused singularity at mass_ice0)
- Fixed Kv formula: Kv<em>(1+KD</em>Pch) = KC<em>(1+KD</em>Pch) + KP<em>Pch
- Corrected k_ice: 0.0053  0.0059 cal/s/cm/K
- Energy balance: dHs</em>(Psub-Pch)<em>Ap/Rp/hr_To_s = Kv</em>Av<em>(Tsh-Tbot)
- Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)</em>(Psub-Pch)*dHs/Rp/hr_To_s/k_ice</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry parameters
- 'Av' (float): Vial cross-sectional area [cm]
- 'Ap' (float): Product cross-sectional area [cm]
- 'Vfill' (float): Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product thermophysical properties
- 'R0' (float): Base product resistance [cmhrTorr/g]
- 'A1' (float): Product resistance parameter 1 [cmhrTorr/g/cm]
- 'A2' (float): Product resistance parameter 2 [1/cm]
- 'T_pr_crit' (float): Critical product temperature [C]
- 'cSolid' (float): Solid fraction (mass/mass)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer correlation coefficients (Pikal correlation)
- 'KC' (float): Coefficient for contact conduction [cal/s/K/cm]
- 'KP' (float): Coefficient for gas conduction [cal/s/K/cm/Torr]
- 'KD' (float): Pressure correction factor [1/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Vfill</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fill volume [mL] (used to calculate Lpr0)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability constraint: capacity = a + b*Pch
- 'a' (float): Intercept [kg/hr]
- 'b' (float): Slope [kg/hr/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials in batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chamber pressure settings
- control_mode='Tsh': {'setpt': [0.1], ...} - fixed pressure trajectory
- control_mode='Pch' or 'both': {'min': 0.05, 'max': 0.5} - bounds</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shelf temperature settings<br />
- control_mode='Pch': {'init': -35, 'setpt': [20], ...} - fixed trajectory
- control_mode='Tsh' or 'both': {'min': -45, 'max': 120} - bounds</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=8</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity. If using finite
differences, this is the number of finite elements (time intervals).
If using collocation and treat_n_elements_as_effective=True, this is
the target effective element count and the applied number of finite
elements will be ceil(n_elements / n_collocation) to keep the total
collocation points roughly comparable to finite differences.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per finite element
(unused when use_finite_differences=True).</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When using
collocation, interpret n_elements as an effective density to match
finite-difference resolution, i.e., apply nfe = ceil(n_elements / ncp).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>control_mode</code>
            </td>
            <td>
                  <code>str, default=&#39;both&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optimization mode
- 'Tsh': Optimize shelf temperature only (Pch fixed)
- 'Pch': Optimize chamber pressure only (Tsh fixed)
- 'both': Optimize both Pch and Tsh</p>
              </div>
            </td>
            <td>
                  <code>&#39;both&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable scaling for numerical stability</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>initial_conditions</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override default initial conditions
- 'Lck' (float): Initial dried cake length [cm] (default: 0.0)
Note: Tsub and Tbot are algebraic (determined by constraints)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use backward Euler FD discretization</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pyo.ConcreteModel: Pyomo model with the following structure:
- <strong>Sets</strong>: t (time), nfe (finite elements if FD)
- <strong>State Variables</strong> (1 ODE):
    - Lck(t): Dried cake length [cm]
- <strong>Algebraic Variables</strong>:
    - Tsub(t): Sublimation temperature [C]
    - Tbot(t): Vial bottom temperature [C]
- <strong>Control Variables</strong>:
    - Pch(t): Chamber pressure [Torr] (if control_mode in ['Pch', 'both'])
    - Tsh(t): Shelf temperature [C] (if control_mode in ['Tsh', 'both'])
- <strong>Optimization Variables</strong>:
    - t_final: Total drying time [hr] (objective to minimize)
- <strong>Key Constraints</strong>:
    - cake_length_ode: dLck/dt = t_final * dmdt * conversion_factor
    - energy_balance: Q_sublimation = Q_from_shelf
    - vial_bottom_temp: Tbot = Tsub + frozen_layer_temperature_rise
    - critical_temp: Tsub  T_pr_crit
    - equipment_capability: total_sublimation_rate  capacity
- <strong>Objective</strong>: minimize t_final</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Model uses backward Euler finite differences (default) or collocation</li>
<li>All constraints validate scipy solutions at machine precision (~1e-7)</li>
<li>No singularity at drying completion (Tsub and Tbot are algebraic)</li>
<li>Initial guess from scipy warmstart strongly recommended</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Optimize shelf temperature only</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.8</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">,</span> <span class="s1">&#39;Vfill&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">product</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;cSolid&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">ht</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">0.000275</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">0.000893</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Vfill</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">eq_cap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.182</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">11.7</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Pchamber</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">],</span> <span class="s1">&#39;dt_setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1800</span><span class="p">]},</span>
<span class="gp">... </span>    <span class="n">Tshelf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>optimize_Tsh_pyomo(): High-level optimizer with staged solve</li>
<li>validate_scipy_residuals(): Validate scipy solutions on Pyomo mesh</li>
<li>staged_solve(): 4-stage convergence framework<ul>
<li>'Lck': Dried cake length [cm] (default: 0.0)
use_finite_differences (bool): Use backward Euler FD instead of collocation (default: True)</li>
</ul>
</li>
</ul>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><span title="ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model with equipment constraints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_optimizer_model</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Vfill</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">control_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">initial_conditions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create Pyomo.DAE model for lyophilization primary drying optimization.</span>

<span class="sd">    This function creates a Pyomo optimization model with corrected physics:</span>
<span class="sd">    - **1 ODE**: dLck/dt (dried cake length growth)</span>
<span class="sd">    - **2 Algebraic constraints**: energy_balance, vial_bottom_temp</span>
<span class="sd">    - **No ODE states for Tsub or Tbot** (they are algebraic variables)</span>

<span class="sd">    This structure matches the scipy implementation which uses quasi-steady-state:</span>
<span class="sd">    scipy solves energy balance and vial temp algebraically at each timestep via fsolve.</span>

<span class="sd">    Key Physics Corrections (Jan 2025):</span>
<span class="sd">    - Removed dTsub/dt and dTbot/dt ODEs (caused singularity at mass_ice0)</span>
<span class="sd">    - Fixed Kv formula: Kv*(1+KD*Pch) = KC*(1+KD*Pch) + KP*Pch</span>
<span class="sd">    - Corrected k_ice: 0.0053  0.0059 cal/s/cm/K</span>
<span class="sd">    - Energy balance: dHs*(Psub-Pch)*Ap/Rp/hr_To_s = Kv*Av*(Tsh-Tbot)</span>
<span class="sd">    - Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)*(Psub-Pch)*dHs/Rp/hr_To_s/k_ice</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry parameters</span>
<span class="sd">            - &#39;Av&#39; (float): Vial cross-sectional area [cm]</span>
<span class="sd">            - &#39;Ap&#39; (float): Product cross-sectional area [cm]</span>
<span class="sd">            - &#39;Vfill&#39; (float): Fill volume [mL]</span>
<span class="sd">        product (dict): Product thermophysical properties</span>
<span class="sd">            - &#39;R0&#39; (float): Base product resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;A1&#39; (float): Product resistance parameter 1 [cmhrTorr/g/cm]</span>
<span class="sd">            - &#39;A2&#39; (float): Product resistance parameter 2 [1/cm]</span>
<span class="sd">            - &#39;T_pr_crit&#39; (float): Critical product temperature [C]</span>
<span class="sd">            - &#39;cSolid&#39; (float): Solid fraction (mass/mass)</span>
<span class="sd">        ht (dict): Heat transfer correlation coefficients (Pikal correlation)</span>
<span class="sd">            - &#39;KC&#39; (float): Coefficient for contact conduction [cal/s/K/cm]</span>
<span class="sd">            - &#39;KP&#39; (float): Coefficient for gas conduction [cal/s/K/cm/Torr]</span>
<span class="sd">            - &#39;KD&#39; (float): Pressure correction factor [1/Torr]</span>
<span class="sd">        Vfill (float): Fill volume [mL] (used to calculate Lpr0)</span>
<span class="sd">        eq_cap (dict): Equipment capability constraint: capacity = a + b*Pch</span>
<span class="sd">            - &#39;a&#39; (float): Intercept [kg/hr]</span>
<span class="sd">            - &#39;b&#39; (float): Slope [kg/hr/Torr]</span>
<span class="sd">        nVial (int): Number of vials in batch</span>
<span class="sd">        Pchamber (dict, optional): Chamber pressure settings</span>
<span class="sd">            - control_mode=&#39;Tsh&#39;: {&#39;setpt&#39;: [0.1], ...} - fixed pressure trajectory</span>
<span class="sd">            - control_mode=&#39;Pch&#39; or &#39;both&#39;: {&#39;min&#39;: 0.05, &#39;max&#39;: 0.5} - bounds</span>
<span class="sd">        Tshelf (dict, optional): Shelf temperature settings  </span>
<span class="sd">            - control_mode=&#39;Pch&#39;: {&#39;init&#39;: -35, &#39;setpt&#39;: [20], ...} - fixed trajectory</span>
<span class="sd">            - control_mode=&#39;Tsh&#39; or &#39;both&#39;: {&#39;min&#39;: -45, &#39;max&#39;: 120} - bounds</span>
<span class="sd">        n_elements (int, default=8): Discretization granularity. If using finite</span>
<span class="sd">            differences, this is the number of finite elements (time intervals).</span>
<span class="sd">            If using collocation and treat_n_elements_as_effective=True, this is</span>
<span class="sd">            the target effective element count and the applied number of finite</span>
<span class="sd">            elements will be ceil(n_elements / n_collocation) to keep the total</span>
<span class="sd">            collocation points roughly comparable to finite differences.</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per finite element</span>
<span class="sd">            (unused when use_finite_differences=True).</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): When using</span>
<span class="sd">            collocation, interpret n_elements as an effective density to match</span>
<span class="sd">            finite-difference resolution, i.e., apply nfe = ceil(n_elements / ncp).</span>
<span class="sd">        control_mode (str, default=&#39;both&#39;): Optimization mode</span>
<span class="sd">            - &#39;Tsh&#39;: Optimize shelf temperature only (Pch fixed)</span>
<span class="sd">            - &#39;Pch&#39;: Optimize chamber pressure only (Tsh fixed)</span>
<span class="sd">            - &#39;both&#39;: Optimize both Pch and Tsh</span>
<span class="sd">        apply_scaling (bool, default=True): Apply variable scaling for numerical stability</span>
<span class="sd">        initial_conditions (dict, optional): Override default initial conditions</span>
<span class="sd">            - &#39;Lck&#39; (float): Initial dried cake length [cm] (default: 0.0)</span>
<span class="sd">            Note: Tsub and Tbot are algebraic (determined by constraints)</span>
<span class="sd">        use_finite_differences (bool, default=True): Use backward Euler FD discretization</span>

<span class="sd">    Returns:</span>
<span class="sd">        pyo.ConcreteModel: Pyomo model with the following structure:</span>
<span class="sd">            - **Sets**: t (time), nfe (finite elements if FD)</span>
<span class="sd">            - **State Variables** (1 ODE):</span>
<span class="sd">                - Lck(t): Dried cake length [cm]</span>
<span class="sd">            - **Algebraic Variables**:</span>
<span class="sd">                - Tsub(t): Sublimation temperature [C]</span>
<span class="sd">                - Tbot(t): Vial bottom temperature [C]</span>
<span class="sd">            - **Control Variables**:</span>
<span class="sd">                - Pch(t): Chamber pressure [Torr] (if control_mode in [&#39;Pch&#39;, &#39;both&#39;])</span>
<span class="sd">                - Tsh(t): Shelf temperature [C] (if control_mode in [&#39;Tsh&#39;, &#39;both&#39;])</span>
<span class="sd">            - **Optimization Variables**:</span>
<span class="sd">                - t_final: Total drying time [hr] (objective to minimize)</span>
<span class="sd">            - **Key Constraints**:</span>
<span class="sd">                - cake_length_ode: dLck/dt = t_final * dmdt * conversion_factor</span>
<span class="sd">                - energy_balance: Q_sublimation = Q_from_shelf</span>
<span class="sd">                - vial_bottom_temp: Tbot = Tsub + frozen_layer_temperature_rise</span>
<span class="sd">                - critical_temp: Tsub  T_pr_crit</span>
<span class="sd">                - equipment_capability: total_sublimation_rate  capacity</span>
<span class="sd">            - **Objective**: minimize t_final</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Model uses backward Euler finite differences (default) or collocation</span>
<span class="sd">        - All constraints validate scipy solutions at machine precision (~1e-7)</span>
<span class="sd">        - No singularity at drying completion (Tsub and Tbot are algebraic)</span>
<span class="sd">        - Initial guess from scipy warmstart strongly recommended</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Optimize shelf temperature only</span>
<span class="sd">        &gt;&gt;&gt; model = create_optimizer_model(</span>
<span class="sd">        ...     vial={&#39;Av&#39;: 3.8, &#39;Ap&#39;: 3.14, &#39;Vfill&#39;: 2.0},</span>
<span class="sd">        ...     product={&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0, &#39;cSolid&#39;: 0.05},</span>
<span class="sd">        ...     ht={&#39;KC&#39;: 0.000275, &#39;KP&#39;: 0.000893, &#39;KD&#39;: 0.46},</span>
<span class="sd">        ...     Vfill=2.0,</span>
<span class="sd">        ...     eq_cap={&#39;a&#39;: -0.182, &#39;b&#39;: 11.7},</span>
<span class="sd">        ...     nVial=398,</span>
<span class="sd">        ...     Pchamber={&#39;setpt&#39;: [0.15], &#39;dt_setpt&#39;: [1800]},</span>
<span class="sd">        ...     Tshelf={&#39;min&#39;: -45, &#39;max&#39;: 120},</span>
<span class="sd">        ...     control_mode=&#39;Tsh&#39;</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">        - optimize_Tsh_pyomo(): High-level optimizer with staged solve</span>
<span class="sd">        - validate_scipy_residuals(): Validate scipy solutions on Pyomo mesh</span>
<span class="sd">        - staged_solve(): 4-stage convergence framework</span>
<span class="sd">            - &#39;Lck&#39;: Dried cake length [cm] (default: 0.0)</span>
<span class="sd">        use_finite_differences (bool): Use backward Euler FD instead of collocation (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (ConcreteModel): Pyomo model with equipment constraints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ======================</span>
    <span class="c1"># Parameter Validation</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Validate control_mode</span>
    <span class="n">valid_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_modes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode must be one of </span><span class="si">{</span><span class="n">valid_modes</span><span class="si">}</span><span class="s2">, got &#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Validate Pchamber based on control_mode</span>
    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="c1"># Pressure optimization mode - need bounds</span>
        <span class="k">if</span> <span class="n">Pchamber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Pchamber with &#39;min&#39; and &#39;max&#39; bounds&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Pchamber</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Pchamber[&#39;min&#39;]&quot;</span><span class="p">)</span>

        <span class="c1"># Validate bounds (max has default of 0.5)</span>
        <span class="n">Pch_min</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
        <span class="n">Pch_max</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Default max if not specified</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">Pch_min</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pchamber[&#39;min&#39;]=</span><span class="si">{</span><span class="n">Pch_min</span><span class="si">}</span><span class="s2"> out of valid range [0.01, 1.0] Torr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">Pch_max</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pchamber[&#39;max&#39;]=</span><span class="si">{</span><span class="n">Pch_max</span><span class="si">}</span><span class="s2"> out of valid range [0.01, 1.0] Torr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Pch_min</span> <span class="o">&gt;=</span> <span class="n">Pch_max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pchamber[&#39;min&#39;]=</span><span class="si">{</span><span class="n">Pch_min</span><span class="si">}</span><span class="s2"> must be &lt; Pchamber[&#39;max&#39;]=</span><span class="si">{</span><span class="n">Pch_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fixed pressure mode (control_mode=&#39;Tsh&#39;) - need setpoints</span>
        <span class="k">if</span> <span class="n">Pchamber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Pchamber with &#39;setpt&#39; profile&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;setpt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Pchamber</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Pchamber[&#39;setpt&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># Validate Tshelf based on control_mode</span>
    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="c1"># Temperature optimization mode - need bounds</span>
        <span class="k">if</span> <span class="n">Tshelf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Tshelf with &#39;min&#39; and &#39;max&#39; bounds&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Tshelf</span> <span class="ow">or</span> <span class="s1">&#39;max&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Tshelf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Tshelf[&#39;min&#39;] and Tshelf[&#39;max&#39;]&quot;</span><span class="p">)</span>

        <span class="c1"># Validate bounds</span>
        <span class="n">Tsh_min</span> <span class="o">=</span> <span class="n">Tshelf</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
        <span class="n">Tsh_max</span> <span class="o">=</span> <span class="n">Tshelf</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">Tsh_min</span> <span class="o">&lt;=</span> <span class="mi">150</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tshelf[&#39;min&#39;]=</span><span class="si">{</span><span class="n">Tsh_min</span><span class="si">}</span><span class="s2"> out of valid range [-50, 150] C&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">Tsh_max</span> <span class="o">&lt;=</span> <span class="mi">150</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tshelf[&#39;max&#39;]=</span><span class="si">{</span><span class="n">Tsh_max</span><span class="si">}</span><span class="s2"> out of valid range [-50, 150] C&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Tsh_min</span> <span class="o">&gt;=</span> <span class="n">Tsh_max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tshelf[&#39;min&#39;]=</span><span class="si">{</span><span class="n">Tsh_min</span><span class="si">}</span><span class="s2"> must be &lt; Tshelf[&#39;max&#39;]=</span><span class="si">{</span><span class="n">Tsh_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fixed temperature mode (control_mode=&#39;Pch&#39;) - need setpoints</span>
        <span class="k">if</span> <span class="n">Tshelf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Tshelf with &#39;setpt&#39; profile&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;setpt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Tshelf</span> <span class="ow">and</span> <span class="s1">&#39;init&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Tshelf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;control_mode=&#39;</span><span class="si">{</span><span class="n">control_mode</span><span class="si">}</span><span class="s2">&#39; requires Tshelf[&#39;setpt&#39;] or Tshelf[&#39;init&#39;]&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1"># Set default initial conditions if not provided</span>
    <span class="k">if</span> <span class="n">initial_conditions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">,</span>
            <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">,</span>
            <span class="s1">&#39;Lck&#39;</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fill in any missing values with defaults</span>
        <span class="n">initial_conditions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Tsub&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">)</span>
        <span class="n">initial_conditions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Tbot&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.0</span><span class="p">)</span>
        <span class="n">initial_conditions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;Lck&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Normalized time domain [0, 1]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">ContinuousSet</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Actual drying time [hr] - optimization variable</span>
    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

    <span class="c1"># Physical parameters</span>
    <span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="n">Vfill</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">])</span>
    <span class="n">Tpr_max</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tpr_max&#39;</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T_pr_crit&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">25.0</span><span class="p">))</span>

    <span class="c1"># ======================</span>
    <span class="c1"># State Variables</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Dried cake length [cm] - ONLY state variable (ODE)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Lpr0</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dLck_dt</span> <span class="o">=</span> <span class="n">dae</span><span class="o">.</span><span class="n">DerivativeVar</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">,</span> <span class="n">wrt</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="c1"># Temperatures [C] - Algebraic variables (NOT ODE states)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mi">30</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Control Variables (mode-dependent)</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="c1"># Optimize shelf temperature</span>
        <span class="n">Tsh_min</span> <span class="o">=</span> <span class="n">Tshelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">)</span>
        <span class="n">Tsh_max</span> <span class="o">=</span> <span class="n">Tshelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">Tsh_min</span><span class="p">,</span> <span class="n">Tsh_max</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fixed shelf temperature profile (will be set in warmstart)</span>
        <span class="c1"># Use wide bounds; actual values from warmstart</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=-</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="c1"># Optimize chamber pressure</span>
        <span class="n">Pch_min</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">Pch_max</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Standard max pressure</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">Pch_min</span><span class="p">,</span> <span class="n">Pch_max</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fixed chamber pressure (will be set in warmstart)</span>
        <span class="c1"># Use wide bounds; actual values from warmstart</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Algebraic Variables</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Vapor pressure [Torr] - using log transform for stability</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Sublimation rate [kg/hr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">)</span>

    <span class="c1"># Product resistance [cm-hr-Torr/g]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">initialize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Algebraic Constraints</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_log_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log-transformed vapor pressure (Antoine equation).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6144.96</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_log</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_log_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vapor_pressure_exp_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exponential relationship.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_exp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vapor_pressure_exp_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">product_resistance_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product resistance as function of dried cake length.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">product_resistance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">product_resistance_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">kv_calc_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial heat transfer coefficient.</span>

<span class="sd">        Kv = KC + KP*Pch / (1 + KD*Pch)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">==</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">kv_calc</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">kv_calc_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sublimation_rate_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mass transfer rate [kg/hr].&quot;&quot;&quot;</span>
        <span class="c1"># dmdt [kg/hr] = Ap[cm] / Rp[cmTorrhr/g] / kg_To_g * P[Torr]</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">==</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sublimation_rate</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">sublimation_rate_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Differential Equations (ODEs) - Only Lck is a differential variable</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Physical constants</span>
    <span class="n">dHs_J</span> <span class="o">=</span> <span class="mf">2838.4</span>  <span class="c1"># J/g (heat of sublimation)</span>
    <span class="n">dHs_cal</span> <span class="o">=</span> <span class="mf">678.0</span>  <span class="c1"># cal/g</span>
    <span class="n">rho_ice</span> <span class="o">=</span> <span class="mf">0.917</span>  <span class="c1"># g/cm</span>
    <span class="n">k_ice</span> <span class="o">=</span> <span class="mf">0.0059</span>  <span class="c1"># cal/s/cm/K (thermal conductivity of ice)</span>
    <span class="n">hr_To_s</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># hr to seconds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cake_length_ode_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dried cake length growth - ONLY ODE in the system.&quot;&quot;&quot;</span>
        <span class="n">kg_To_g</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">rho_solution</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># g/cm</span>
        <span class="n">rho_solute</span> <span class="o">=</span> <span class="mf">1.13</span>  <span class="c1"># g/cm</span>

        <span class="n">conversion</span> <span class="o">=</span> <span class="n">kg_To_g</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;cSolid&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_solution</span> <span class="o">/</span> <span class="n">rho_solute</span><span class="p">)</span> <span class="o">*</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_ice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">dLck_dt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">t_final</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">conversion</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cake_length_ode</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">cake_length_ode_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Algebraic Constraints (Energy Balances)</span>
    <span class="c1"># ======================</span>

    <span class="c1"># Scipy solves this coupled system implicitly via fsolve:</span>
    <span class="c1"># 1. Qsub = dHs * (Psub - Pch) * Ap / Rp / hr_To_s</span>
    <span class="c1"># 2. Tbot = Tsub + Qsub / Ap / k_ice * (Lpr0 - Lck)</span>
    <span class="c1"># 3. Qsh = Kv * Av * (Tsh - Tbot)</span>
    <span class="c1"># 4. Find Tsub such that Qsh = Qsub</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vial_bottom_temp_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vial bottom temperature from temperature gradient across frozen layer.</span>

<span class="sd">        This directly implements scipy&#39;s T_bot_FUN:</span>
<span class="sd">        Tbot = Tsub + (Lpr0 - Lck) * (Psub - Pch) * dHs / Rp / hr_To_s / k_ice</span>

<span class="sd">        When Lck  Lpr0 (fully dried), Tbot  Tsub (no frozen layer).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frozen_thickness</span> <span class="o">=</span> <span class="n">Lpr0</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="n">temp_gradient</span> <span class="o">=</span> <span class="n">frozen_thickness</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">*</span> <span class="n">dHs_cal</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="n">hr_To_s</span> <span class="o">/</span> <span class="n">k_ice</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">temp_gradient</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vial_bottom_temp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">vial_bottom_temp_rule</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy_balance_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Energy balance: heat from shelf = heat for sublimation.</span>

<span class="sd">        This implements scipy&#39;s T_sub_solver_FUN residual:</span>
<span class="sd">        Qsh = Kv * Av * (Tsh - Tbot)</span>
<span class="sd">        Qsub = dHs * (Psub - Pch) * Ap / Rp / hr_To_s</span>
<span class="sd">        Residual: Qsub - Qsh = 0</span>

<span class="sd">        Note: Tbot is determined by vial_bottom_temp constraint above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Heat from shelf [cal/s]</span>
        <span class="n">Q_shelf</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Kv</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>

        <span class="c1"># Heat for sublimation [cal/s] - use exact scipy formula</span>
        <span class="n">Q_sub</span> <span class="o">=</span> <span class="n">dHs_cal</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">*</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">/</span> <span class="n">hr_To_s</span>

        <span class="c1"># Energy balance</span>
        <span class="k">return</span> <span class="n">Q_sub</span> <span class="o">==</span> <span class="n">Q_shelf</span>
    <span class="n">model</span><span class="o">.</span><span class="n">energy_balance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">energy_balance_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Initial Conditions - Only for ODE state (Lck)</span>
    <span class="c1"># ======================</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">lck_ic</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t0</span><span class="p">]</span> <span class="o">==</span> <span class="n">initial_conditions</span><span class="p">[</span><span class="s1">&#39;Lck&#39;</span><span class="p">])</span>

    <span class="c1"># Note: Tsub and Tbot are algebraic, determined by energy_balance and vial_bottom_temp constraints</span>
    <span class="c1"># No initial conditions needed for algebraic variables</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Path Constraints</span>
    <span class="c1"># ======================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temp_limit_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product temperature must stay at or below critical temperature.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Tpr_max</span>
    <span class="n">model</span><span class="o">.</span><span class="n">temp_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">temp_limit_rule</span><span class="p">)</span>

    <span class="c1"># Equipment capability constraint</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">equipment_capability_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total sublimation rate must not exceed equipment capacity.</span>

<span class="sd">        Equipment capacity [kg/hr] = a + b * Pch[Torr]</span>
<span class="sd">        Total rate [kg/hr] = dmdt[kg/hr] * nVial</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nVial</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">capacity</span>
    <span class="n">model</span><span class="o">.</span><span class="n">equipment_capability</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">equipment_capability_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Terminal Constraint</span>
    <span class="c1"># ======================</span>

    <span class="n">tf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final_dryness_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure drying reaches at least 99% completion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">Lpr0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">final_dryness</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="n">final_dryness_rule</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Discretization</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">use_finite_differences</span><span class="p">:</span>
        <span class="c1"># Backward Euler finite differences - simpler and easier to initialize</span>
        <span class="c1"># Uses Pyomo&#39;s built-in transformation</span>
        <span class="n">discretizer</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;dae.finite_difference&#39;</span><span class="p">)</span>
        <span class="n">discretizer</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
            <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;BACKWARD&#39;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Collocation approach (higher order, but harder to initialize)</span>
        <span class="n">discretizer</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TransformationFactory</span><span class="p">(</span><span class="s1">&#39;dae.collocation&#39;</span><span class="p">)</span>
        <span class="c1"># If requested, interpret n_elements as an effective density comparable</span>
        <span class="c1"># to finite-difference nfe by distributing across n_collocation points.</span>
        <span class="n">nfe_apply</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_elements</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_collocation</span><span class="p">)))</span> <span class="k">if</span> <span class="n">treat_n_elements_as_effective</span> <span class="k">else</span> <span class="n">n_elements</span>
        <span class="n">discretizer</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">nfe_apply</span><span class="p">,</span>
            <span class="n">ncp</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
            <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;LAGRANGE-RADAU&#39;</span>
        <span class="p">)</span>

    <span class="c1"># Record mesh info for downstream metadata/debugging</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_mesh_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;fd&#39;</span> <span class="k">if</span> <span class="n">use_finite_differences</span> <span class="k">else</span> <span class="s1">&#39;collocation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nfe_requested&#39;</span><span class="p">:</span> <span class="n">n_elements</span><span class="p">,</span>
            <span class="s1">&#39;ncp&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">use_finite_differences</span> <span class="k">else</span> <span class="n">n_collocation</span><span class="p">,</span>
            <span class="s1">&#39;treat_effective&#39;</span><span class="p">:</span> <span class="n">treat_n_elements_as_effective</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">use_finite_differences</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Objective: Minimize Drying Time</span>
    <span class="c1"># ======================</span>

    <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">,</span> <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>

    <span class="c1"># ======================</span>
    <span class="c1"># Scaling (optional but recommended)</span>
    <span class="c1"># ======================</span>

    <span class="k">if</span> <span class="n">apply_scaling</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="o">.</span><span class="n">EXPORT</span><span class="p">)</span>

        <span class="c1"># Variable scaling</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">5.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">Lpr0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">5.0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.optimize_Pch_Tsh_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Pch_Tsh_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_trust_region</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trust_radii</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Joint optimization of pressure and shelf temperature (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Pch_Tsh.dry(), optimizing both
chamber pressure and shelf temperature trajectories simultaneously.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variables: Pch(t), Tsh(t) - pressure and temperature trajectories
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit
        * Equipment sublimation capacity  total batch rate
        * Pressure bounds (min, max)
        * Shelf temperature bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Joint Control Strategy</strong>:
    - Stage 1: Feasibility (both controls fixed)
    - Stage 2: Time optimization (controls fixed)
    - Stage 3: Release Tsh (optimize shelf temp, Pch fixed)
    - Stage 4: Release Pch (optimize both)
    - Optional: Trust region around scipy for initial stages</p>
<p><strong>Physics</strong>: Same corrected 1 ODE + 2 algebraic as single-control optimizers</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (Av, Ap, Vfill)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (R0, A1, A2, T_pr_crit, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pressure bounds
- 'min' (float): Minimum pressure [Torr]
- 'max' (float): Maximum pressure [Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Temperature bounds
- 'min' (float): Minimum temperature [C]
- 'max' (float): Maximum temperature [C]
- 'init' (float): Initial temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability (a, b)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=32</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity; see notes in
optimize_Tsh_pyomo for FD vs collocation equivalence.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpret
n_elements as effective density when using collocation.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use scipy for initial guess</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation mode</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_trust_region</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Add trust region around scipy</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trust_radii</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trust region radii {'Pch': 0.05, 'Tsh': 10.0}</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory (n_points, 7)
Typically 3-10% faster than single-control optimizers</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Joint optimization is more challenging numerically</li>
<li>Higher n_elements (10-12) recommended vs single-control (8)</li>
<li>Trust region can improve robustness but may limit optimality</li>
<li>Expected improvement: 3-10% over best single-control optimizer</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Joint optimization with trust region</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Pch_Tsh_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Pchamber</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Tshelf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">n_elements</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">use_trust_region</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">trust_radii</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Pch_Tsh.dry(): Scipy baseline optimizer</li>
<li>optimize_Tsh_pyomo(): Optimize shelf temperature only</li>
<li>optimize_Pch_pyomo(): Optimize pressure only</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Pch_Tsh_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># Higher default for joint optimization (FD)</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_trust_region</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">trust_radii</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Joint optimization of pressure and shelf temperature (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Pch_Tsh.dry(), optimizing both</span>
<span class="sd">    chamber pressure and shelf temperature trajectories simultaneously.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variables: Pch(t), Tsh(t) - pressure and temperature trajectories</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Pressure bounds (min, max)</span>
<span class="sd">            * Shelf temperature bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Joint Control Strategy**:</span>
<span class="sd">        - Stage 1: Feasibility (both controls fixed)</span>
<span class="sd">        - Stage 2: Time optimization (controls fixed)</span>
<span class="sd">        - Stage 3: Release Tsh (optimize shelf temp, Pch fixed)</span>
<span class="sd">        - Stage 4: Release Pch (optimize both)</span>
<span class="sd">        - Optional: Trust region around scipy for initial stages</span>

<span class="sd">    **Physics**: Same corrected 1 ODE + 2 algebraic as single-control optimizers</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (Av, Ap, Vfill)</span>
<span class="sd">        product (dict): Product properties (R0, A1, A2, T_pr_crit, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Pchamber (dict): Pressure bounds</span>
<span class="sd">            - &#39;min&#39; (float): Minimum pressure [Torr]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum pressure [Torr]</span>
<span class="sd">        Tshelf (dict): Temperature bounds</span>
<span class="sd">            - &#39;min&#39; (float): Minimum temperature [C]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum temperature [C]</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment capability (a, b)</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        n_elements (int, default=32): Discretization granularity; see notes in</span>
<span class="sd">            optimize_Tsh_pyomo for FD vs collocation equivalence.</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per element.</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): Interpret</span>
<span class="sd">            n_elements as effective density when using collocation.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Use scipy for initial guess</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>
<span class="sd">        simulation_mode (bool, default=False): Validation mode</span>
<span class="sd">        use_trust_region (bool, default=False): Add trust region around scipy</span>
<span class="sd">        trust_radii (dict, optional): Trust region radii {&#39;Pch&#39;: 0.05, &#39;Tsh&#39;: 10.0}</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory (n_points, 7)</span>
<span class="sd">            Typically 3-10% faster than single-control optimizers</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Joint optimization is more challenging numerically</span>
<span class="sd">        - Higher n_elements (10-12) recommended vs single-control (8)</span>
<span class="sd">        - Trust region can improve robustness but may limit optimality</span>
<span class="sd">        - Expected improvement: 3-10% over best single-control optimizer</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Joint optimization with trust region</span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Pch_Tsh_pyomo(</span>
<span class="sd">        ...     vial, product, ht,</span>
<span class="sd">        ...     Pchamber={&#39;min&#39;: 0.06, &#39;max&#39;: 0.20},</span>
<span class="sd">        ...     Tshelf={&#39;min&#39;: -45, &#39;max&#39;: 30, &#39;init&#39;: -35},</span>
<span class="sd">        ...     dt=0.01, eq_cap=eq_cap, nVial=398,</span>
<span class="sd">        ...     n_elements=10,</span>
<span class="sd">        ...     use_trust_region=True,</span>
<span class="sd">        ...     trust_radii={&#39;Pch&#39;: 0.03, &#39;Tsh&#39;: 8.0}</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Pch_Tsh.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Tsh_pyomo(): Optimize shelf temperature only</span>
<span class="sd">        - optimize_Pch_pyomo(): Optimize pressure only</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Pch_Tsh</span>

    <span class="c1"># Create model with both controls active</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>
    <span class="p">)</span>

    <span class="c1"># Warmstart from scipy</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Pch_Tsh</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Add trust region if requested</span>
        <span class="k">if</span> <span class="n">use_trust_region</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trust_radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trust_radii</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">}</span>  <span class="c1"># Default radii</span>

            <span class="c1"># Build reference values from scipy</span>
            <span class="n">reference_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">t_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
            <span class="n">t_final_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">t_actual</span> <span class="o">=</span> <span class="n">t_normalized</span> <span class="o">*</span> <span class="n">t_final_scipy</span>

            <span class="n">time_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Tsh_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">Pch_scipy</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># mTorr  Torr</span>

            <span class="n">scipy_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">time_scipy</span><span class="p">,</span> <span class="n">t_actual</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">scipy_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">scipy_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_scipy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">Pch_scipy</span><span class="p">[</span><span class="n">scipy_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> 
                                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))}</span>
            <span class="n">reference_values</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">Tsh_scipy</span><span class="p">[</span><span class="n">scipy_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                                       <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))}</span>

            <span class="n">add_trust_region</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reference_values</span><span class="p">,</span> <span class="n">trust_radii</span><span class="p">)</span>

        <span class="c1"># Validate</span>
        <span class="k">if</span> <span class="n">tee</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver with tighter tolerances for joint optimization</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8000</span>  <span class="c1"># More iterations for joint</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>  <span class="c1"># Slightly tighter</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># Tighter</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-7</span>  <span class="c1"># Tighter</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>

    <span class="c1"># Solve with sequential control release</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.optimize_Pch_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Pch_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize chamber pressure trajectory for minimum drying time (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Pch.dry(), optimizing chamber
pressure trajectory while keeping shelf temperature fixed.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variable: Pch(t) - chamber pressure trajectory [Torr]
    - Fixed parameter: Tsh(t) - shelf temperature profile [C]
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit
        * Equipment sublimation capacity  total batch rate
        * Pressure bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Physics</strong>: Same corrected 1 ODE + 2 algebraic as opt_Tsh_pyomo</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (Av, Ap, Vfill)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (R0, A1, A2, T_pr_crit, cSolid)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (KC, KP, KD)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pressure bounds for optimization
- 'min' (float): Minimum pressure [Torr]
- 'max' (float): Maximum pressure [Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fixed shelf temperature profile
- 'init' (float): Initial temperature [C]
- 'setpt' (list): Temperature setpoints [C]
- 'dt_setpt' (list): Time at each setpoint [min]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability (a, b)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=24</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity. With FD, this
is the number of finite elements. With collocation and
treat_n_elements_as_effective=True, apply nfe=ceil(n_elements/ncp).</p>
              </div>
            </td>
            <td>
                  <code>24</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per element.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Interpret
n_elements as an effective density for comparability.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use scipy for initial guess</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validation mode</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory (n_points, 7)
Same format as opt_Tsh_pyomo</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Pch_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> 
<span class="gp">... </span>    <span class="n">Pchamber</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Tshelf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="s1">&#39;setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="s1">&#39;dt_setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="mi">1800</span><span class="p">]},</span>
<span class="gp">... </span>    <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Pch.dry(): Scipy baseline optimizer</li>
<li>optimize_Tsh_pyomo(): Optimize shelf temperature only</li>
<li>optimize_Pch_Tsh_pyomo(): Optimize both controls</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Pch_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize chamber pressure trajectory for minimum drying time (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Pch.dry(), optimizing chamber</span>
<span class="sd">    pressure trajectory while keeping shelf temperature fixed.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variable: Pch(t) - chamber pressure trajectory [Torr]</span>
<span class="sd">        - Fixed parameter: Tsh(t) - shelf temperature profile [C]</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Pressure bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Physics**: Same corrected 1 ODE + 2 algebraic as opt_Tsh_pyomo</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (Av, Ap, Vfill)</span>
<span class="sd">        product (dict): Product properties (R0, A1, A2, T_pr_crit, cSolid)</span>
<span class="sd">        ht (dict): Heat transfer parameters (KC, KP, KD)</span>
<span class="sd">        Pchamber (dict): Pressure bounds for optimization</span>
<span class="sd">            - &#39;min&#39; (float): Minimum pressure [Torr]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum pressure [Torr]</span>
<span class="sd">        Tshelf (dict): Fixed shelf temperature profile</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">            - &#39;setpt&#39; (list): Temperature setpoints [C]</span>
<span class="sd">            - &#39;dt_setpt&#39; (list): Time at each setpoint [min]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment capability (a, b)</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        n_elements (int, default=24): Discretization granularity. With FD, this</span>
<span class="sd">            is the number of finite elements. With collocation and</span>
<span class="sd">            treat_n_elements_as_effective=True, apply nfe=ceil(n_elements/ncp).</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per element.</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): Interpret</span>
<span class="sd">            n_elements as an effective density for comparability.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Use scipy for initial guess</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>
<span class="sd">        simulation_mode (bool, default=False): Validation mode</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory (n_points, 7)</span>
<span class="sd">            Same format as opt_Tsh_pyomo</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Pch_pyomo(</span>
<span class="sd">        ...     vial, product, ht, </span>
<span class="sd">        ...     Pchamber={&#39;min&#39;: 0.06, &#39;max&#39;: 0.20},</span>
<span class="sd">        ...     Tshelf={&#39;init&#39;: -35, &#39;setpt&#39;: [-20, 20], &#39;dt_setpt&#39;: [180, 1800]},</span>
<span class="sd">        ...     dt=0.01, eq_cap=eq_cap, nVial=398</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Pch.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Tsh_pyomo(): Optimize shelf temperature only</span>
<span class="sd">        - optimize_Pch_Tsh_pyomo(): Optimize both controls</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Pch</span>

    <span class="c1"># Create model with Pch optimization mode</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>
    <span class="p">)</span>

    <span class="c1"># Warmstart from scipy</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Pch</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Fix shelf temperature to scipy trajectory</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

        <span class="c1"># Validate</span>
        <span class="k">if</span> <span class="n">tee</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="c1"># Solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.optimize_Tsh_pyomo" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_Tsh_pyomo</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span> <span class="n">n_elements</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">n_collocation</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_finite_differences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simulation_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize shelf temperature trajectory for minimum drying time (Pyomo implementation).</p>
<p>This is the Pyomo equivalent of lyopronto.opt_Tsh.dry(), providing a multi-period
optimization formulation with improved physics (1 ODE + 2 algebraic constraints).</p>
<p>Following the coexistence philosophy: this complements (not replaces) the scipy optimizer.
Scipy optimizer uses quasi-steady-state with fsolve at each timestep.
Pyomo uses simultaneous discretization with algebraic energy balance.</p>
<p><strong>Optimization Problem</strong>:
    - Decision variable: Tsh(t) - shelf temperature trajectory [C]
    - Fixed parameter: Pch - chamber pressure [Torr]
    - Objective: Minimize drying time t_final
    - Constraints:
        * Product temperature  T_pr_crit (collapse prevention)
        * Equipment sublimation capacity  total batch rate
        * Shelf temperature bounds (min, max)
        * 99% dried at completion</p>
<p><strong>Staged Solve Framework</strong> (if warmstart_scipy=True):
    1. Feasibility: Find consistent states with fixed controls
    2. Time minimization: Optimize t_final with fixed controls
    3. Control optimization: Release Tsh for optimization
    4. Full optimization: All DOFs optimized simultaneously</p>
<p><strong>Model Structure</strong> (corrected Jan 2025):
    - 1 ODE: dLck/dt (dried cake length)
    - 2 Algebraic: energy_balance, vial_bottom_temp
    - NO ODEs for Tsub or Tbot (they are algebraic variables)
    - Validated: scipy solutions satisfy Pyomo constraints at machine precision</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry
- 'Av' (float): Vial area [cm]
- 'Ap' (float): Product area [cm]
- 'Vfill' (float): Fill volume [mL]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties
- 'R0' (float): Base resistance [cmhrTorr/g]
- 'A1' (float): Resistance parameter [cmhrTorr/g/cm]
- 'A2' (float): Resistance parameter [1/cm]
- 'T_pr_crit' (float): Critical temperature [C]
- 'cSolid' (float): Solid fraction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer (Pikal correlation)
- 'KC' (float): Contact conduction [cal/s/K/cm]
- 'KP' (float): Gas conduction [cal/s/K/cm/Torr]
- 'KD' (float): Pressure correction [1/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pchamber</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fixed chamber pressure settings
- 'setpt' (list): Pressure setpoint(s) [Torr]
- 'dt_setpt' (list): Time at each setpoint [min]
- 'ramp_rate' (float): Ramp rate [Torr/min] (optional)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tshelf</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shelf temperature bounds for optimization
- 'min' (float): Minimum temperature [C]
- 'max' (float): Maximum temperature [C]
- 'init' (float): Initial temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dt</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time step for scipy warmstart [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment sublimation capacity
- 'a' (float): Intercept [kg/hr]
- 'b' (float): Slope [kg/hr/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials in batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_elements</code>
            </td>
            <td>
                  <code>int, default=24</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discretization granularity. With finite
differences, this is the number of finite elements. With
collocation and treat_n_elements_as_effective=True, this value is
treated as the effective density and the applied nfe becomes
ceil(n_elements/n_collocation).</p>
              </div>
            </td>
            <td>
                  <code>24</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_collocation</code>
            </td>
            <td>
                  <code>int, default=3</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collocation points per finite element
(unused for finite differences).</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_finite_differences</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If False, use
LAGRANGE-RADAU collocation.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>treat_n_elements_as_effective</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When using
collocation, interpret n_elements as effective density so that the
total number of discretization points (nfe*ncp) is comparable to
finite differences with nfe.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_scipy</code>
            </td>
            <td>
                  <code>bool, default=True</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initialize from scipy opt_Tsh solution</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>simulation_mode</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, fix all vars and just validate</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code>str, default=&#39;ipopt&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Optimized trajectory with shape (n_points, 7)
- Column 0: Time [hr]
- Column 1: Sublimation temperature Tsub [C]
- Column 2: Vial bottom temperature Tbot [C]
- Column 3: Shelf temperature Tsh [C]
- Column 4: Chamber pressure Pch [mTorr] (note: milli-Torr!)
- Column 5: Sublimation flux [kg/hr/m]
- Column 6: Fraction dried [0-1] (note: NOT percentage!)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If optimization fails and no solution available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li><strong>Warmstart strongly recommended</strong>: Set warmstart_scipy=True for robust convergence</li>
<li>Model validates scipy solutions at residuals ~1e-7 (machine precision)</li>
<li>Recommended mesh for FD: 24 elements (8 is too coarse)</li>
<li>For collocation, enable treat_n_elements_as_effective to keep total points comparable to FD</li>
<li>Typical speedup: 5-10% faster than scipy (discretization vs integration)</li>
<li>Staged solve improves robustness vs. direct full optimization</li>
<li>simulation_mode validates model without optimization (debugging)</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Optimize shelf temperature with fixed pressure</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vial</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.8</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">,</span> <span class="s1">&#39;Vfill&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;cSolid&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ht</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">0.000275</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">0.000893</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Pchamber</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">],</span> <span class="s1">&#39;dt_setpt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1800</span><span class="p">],</span> <span class="s1">&#39;ramp_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tshelf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">35</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eq_cap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.182</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">11.7</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">optimize_Tsh_pyomo</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="mi">398</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">warmstart_scipy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Drying time: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final dryness: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>lyopronto.opt_Tsh.dry(): Scipy baseline optimizer</li>
<li>optimize_Pch_pyomo(): Optimize pressure only</li>
<li>optimize_Pch_Tsh_pyomo(): Optimize both controls</li>
<li>create_optimizer_model(): Create Pyomo model</li>
<li>staged_solve(): 4-stage convergence framework</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_Tsh_pyomo</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">Pchamber</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tshelf</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eq_cap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">nVial</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_elements</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">n_collocation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">use_finite_differences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">treat_n_elements_as_effective</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">warmstart_scipy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">simulation_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize shelf temperature trajectory for minimum drying time (Pyomo implementation).</span>

<span class="sd">    This is the Pyomo equivalent of lyopronto.opt_Tsh.dry(), providing a multi-period</span>
<span class="sd">    optimization formulation with improved physics (1 ODE + 2 algebraic constraints).</span>

<span class="sd">    Following the coexistence philosophy: this complements (not replaces) the scipy optimizer.</span>
<span class="sd">    Scipy optimizer uses quasi-steady-state with fsolve at each timestep.</span>
<span class="sd">    Pyomo uses simultaneous discretization with algebraic energy balance.</span>

<span class="sd">    **Optimization Problem**:</span>
<span class="sd">        - Decision variable: Tsh(t) - shelf temperature trajectory [C]</span>
<span class="sd">        - Fixed parameter: Pch - chamber pressure [Torr]</span>
<span class="sd">        - Objective: Minimize drying time t_final</span>
<span class="sd">        - Constraints:</span>
<span class="sd">            * Product temperature  T_pr_crit (collapse prevention)</span>
<span class="sd">            * Equipment sublimation capacity  total batch rate</span>
<span class="sd">            * Shelf temperature bounds (min, max)</span>
<span class="sd">            * 99% dried at completion</span>

<span class="sd">    **Staged Solve Framework** (if warmstart_scipy=True):</span>
<span class="sd">        1. Feasibility: Find consistent states with fixed controls</span>
<span class="sd">        2. Time minimization: Optimize t_final with fixed controls</span>
<span class="sd">        3. Control optimization: Release Tsh for optimization</span>
<span class="sd">        4. Full optimization: All DOFs optimized simultaneously</span>

<span class="sd">    **Model Structure** (corrected Jan 2025):</span>
<span class="sd">        - 1 ODE: dLck/dt (dried cake length)</span>
<span class="sd">        - 2 Algebraic: energy_balance, vial_bottom_temp</span>
<span class="sd">        - NO ODEs for Tsub or Tbot (they are algebraic variables)</span>
<span class="sd">        - Validated: scipy solutions satisfy Pyomo constraints at machine precision</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry</span>
<span class="sd">            - &#39;Av&#39; (float): Vial area [cm]</span>
<span class="sd">            - &#39;Ap&#39; (float): Product area [cm]</span>
<span class="sd">            - &#39;Vfill&#39; (float): Fill volume [mL]</span>
<span class="sd">        product (dict): Product properties</span>
<span class="sd">            - &#39;R0&#39; (float): Base resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;A1&#39; (float): Resistance parameter [cmhrTorr/g/cm]</span>
<span class="sd">            - &#39;A2&#39; (float): Resistance parameter [1/cm]</span>
<span class="sd">            - &#39;T_pr_crit&#39; (float): Critical temperature [C]</span>
<span class="sd">            - &#39;cSolid&#39; (float): Solid fraction</span>
<span class="sd">        ht (dict): Heat transfer (Pikal correlation)</span>
<span class="sd">            - &#39;KC&#39; (float): Contact conduction [cal/s/K/cm]</span>
<span class="sd">            - &#39;KP&#39; (float): Gas conduction [cal/s/K/cm/Torr]</span>
<span class="sd">            - &#39;KD&#39; (float): Pressure correction [1/Torr]</span>
<span class="sd">        Pchamber (dict): Fixed chamber pressure settings</span>
<span class="sd">            - &#39;setpt&#39; (list): Pressure setpoint(s) [Torr]</span>
<span class="sd">            - &#39;dt_setpt&#39; (list): Time at each setpoint [min]</span>
<span class="sd">            - &#39;ramp_rate&#39; (float): Ramp rate [Torr/min] (optional)</span>
<span class="sd">        Tshelf (dict): Shelf temperature bounds for optimization</span>
<span class="sd">            - &#39;min&#39; (float): Minimum temperature [C]</span>
<span class="sd">            - &#39;max&#39; (float): Maximum temperature [C]</span>
<span class="sd">            - &#39;init&#39; (float): Initial temperature [C]</span>
<span class="sd">        dt (float): Time step for scipy warmstart [hr]</span>
<span class="sd">        eq_cap (dict): Equipment sublimation capacity</span>
<span class="sd">            - &#39;a&#39; (float): Intercept [kg/hr]</span>
<span class="sd">            - &#39;b&#39; (float): Slope [kg/hr/Torr]</span>
<span class="sd">        nVial (int): Number of vials in batch</span>
<span class="sd">        n_elements (int, default=24): Discretization granularity. With finite</span>
<span class="sd">            differences, this is the number of finite elements. With</span>
<span class="sd">            collocation and treat_n_elements_as_effective=True, this value is</span>
<span class="sd">            treated as the effective density and the applied nfe becomes</span>
<span class="sd">            ceil(n_elements/n_collocation).</span>
<span class="sd">        n_collocation (int, default=3): Collocation points per finite element</span>
<span class="sd">            (unused for finite differences).</span>
<span class="sd">        use_finite_differences (bool, default=True): If False, use</span>
<span class="sd">            LAGRANGE-RADAU collocation.</span>
<span class="sd">        treat_n_elements_as_effective (bool, default=False): When using</span>
<span class="sd">            collocation, interpret n_elements as effective density so that the</span>
<span class="sd">            total number of discretization points (nfe*ncp) is comparable to</span>
<span class="sd">            finite differences with nfe.</span>
<span class="sd">        warmstart_scipy (bool, default=True): Initialize from scipy opt_Tsh solution</span>
<span class="sd">        simulation_mode (bool, default=False): If True, fix all vars and just validate</span>
<span class="sd">        solver (str, default=&#39;ipopt&#39;): Solver name</span>
<span class="sd">        tee (bool, default=False): Print solver output</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: Optimized trajectory with shape (n_points, 7)</span>
<span class="sd">            - Column 0: Time [hr]</span>
<span class="sd">            - Column 1: Sublimation temperature Tsub [C]</span>
<span class="sd">            - Column 2: Vial bottom temperature Tbot [C]</span>
<span class="sd">            - Column 3: Shelf temperature Tsh [C]</span>
<span class="sd">            - Column 4: Chamber pressure Pch [mTorr] (note: milli-Torr!)</span>
<span class="sd">            - Column 5: Sublimation flux [kg/hr/m]</span>
<span class="sd">            - Column 6: Fraction dried [0-1] (note: NOT percentage!)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If optimization fails and no solution available</span>

<span class="sd">    Notes:</span>
<span class="sd">        - **Warmstart strongly recommended**: Set warmstart_scipy=True for robust convergence</span>
<span class="sd">        - Model validates scipy solutions at residuals ~1e-7 (machine precision)</span>
<span class="sd">        - Recommended mesh for FD: 24 elements (8 is too coarse)</span>
<span class="sd">        - For collocation, enable treat_n_elements_as_effective to keep total points comparable to FD</span>
<span class="sd">        - Typical speedup: 5-10% faster than scipy (discretization vs integration)</span>
<span class="sd">        - Staged solve improves robustness vs. direct full optimization</span>
<span class="sd">        - simulation_mode validates model without optimization (debugging)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Optimize shelf temperature with fixed pressure</span>
<span class="sd">        &gt;&gt;&gt; vial = {&#39;Av&#39;: 3.8, &#39;Ap&#39;: 3.14, &#39;Vfill&#39;: 2.0}</span>
<span class="sd">        &gt;&gt;&gt; product = {&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0, &#39;cSolid&#39;: 0.05}</span>
<span class="sd">        &gt;&gt;&gt; ht = {&#39;KC&#39;: 0.000275, &#39;KP&#39;: 0.000893, &#39;KD&#39;: 0.46}</span>
<span class="sd">        &gt;&gt;&gt; Pchamber = {&#39;setpt&#39;: [0.15], &#39;dt_setpt&#39;: [1800], &#39;ramp_rate&#39;: 0.5}</span>
<span class="sd">        &gt;&gt;&gt; Tshelf = {&#39;min&#39;: -45, &#39;max&#39;: 120, &#39;init&#39;: -35}</span>
<span class="sd">        &gt;&gt;&gt; eq_cap = {&#39;a&#39;: -0.182, &#39;b&#39;: 11.7}</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; result = optimize_Tsh_pyomo(</span>
<span class="sd">        ...     vial, product, ht, Pchamber, Tshelf, dt=0.01, eq_cap=eq_cap, nVial=398,</span>
<span class="sd">        ...     warmstart_scipy=True, tee=False</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Drying time: {result[-1, 0]:.2f} hr&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Final dryness: {result[-1, 6]*100:.1f}%&quot;)</span>

<span class="sd">    See Also:</span>
<span class="sd">        - lyopronto.opt_Tsh.dry(): Scipy baseline optimizer</span>
<span class="sd">        - optimize_Pch_pyomo(): Optimize pressure only</span>
<span class="sd">        - optimize_Pch_Tsh_pyomo(): Optimize both controls</span>
<span class="sd">        - create_optimizer_model(): Create Pyomo model</span>
<span class="sd">        - staged_solve(): 4-stage convergence framework</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Tsh</span>

    <span class="c1"># Create model with Tsh optimization mode</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_optimizer_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Vfill&#39;</span><span class="p">],</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">,</span>
        <span class="n">Pchamber</span><span class="o">=</span><span class="n">Pchamber</span><span class="p">,</span>
        <span class="n">Tshelf</span><span class="o">=</span><span class="n">Tshelf</span><span class="p">,</span>
        <span class="n">n_elements</span><span class="o">=</span><span class="n">n_elements</span><span class="p">,</span>
        <span class="n">n_collocation</span><span class="o">=</span><span class="n">n_collocation</span><span class="p">,</span>
        <span class="n">treat_n_elements_as_effective</span><span class="o">=</span><span class="n">treat_n_elements_as_effective</span><span class="p">,</span>
        <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_finite_differences</span><span class="o">=</span><span class="n">use_finite_differences</span>  <span class="c1"># FD default; collocation optional</span>
    <span class="p">)</span>

    <span class="c1"># Fix chamber pressure to setpoint</span>
    <span class="n">Pch_fixed</span> <span class="o">=</span> <span class="n">Pchamber</span><span class="p">[</span><span class="s1">&#39;setpt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">Pch_fixed</span><span class="p">)</span>

    <span class="c1"># Warmstart from scipy if requested</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="n">scipy_output</span> <span class="o">=</span> <span class="n">opt_Tsh</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pchamber</span><span class="p">,</span> <span class="n">Tshelf</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
        <span class="n">_warmstart_from_scipy_output</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span>

        <span class="c1"># Validate scipy trajectory on Pyomo mesh</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

        <span class="c1"># In simulation mode, fix all variables to scipy values</span>
        <span class="k">if</span> <span class="n">simulation_mode</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;fix&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="c1"># Configure solver with robust options</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="c1"># Set robust IPOPT options for DAE optimization</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">):</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;acceptable_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;bound_relax_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;constr_viol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
            <span class="c1"># Warm start options (only when warmstart requested)</span>
            <span class="k">if</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_init_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;warm_start_mult_bound_push&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

    <span class="c1"># Execute staged solve or direct solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">warmstart_scipy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">simulation_mode</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Staged solve incomplete: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting direct solve as fallback...&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Direct solve (simulation mode or no warmstart)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Check constraint violations in simulation mode</span>
    <span class="k">if</span> <span class="n">simulation_mode</span> <span class="ow">and</span> <span class="n">warmstart_scipy</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Constraint Violation Check (Simulation Mode) ===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver status: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Termination condition: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_infeasible_constraints</span><span class="p">:</span>
            <span class="n">log_infeasible_constraints</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual constraint check</span>
            <span class="n">violation_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">constr</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lhs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">rhs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

                        <span class="n">viol_lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">body</span><span class="p">)</span>
                        <span class="n">viol_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">body</span> <span class="o">-</span> <span class="n">rhs</span><span class="p">)</span>
                        <span class="n">viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">viol_lower</span><span class="p">,</span> <span class="n">viol_upper</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">viol</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                            <span class="n">violation_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">violation_count</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Only print first 10</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Violation in </span><span class="si">{</span><span class="n">constr</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">viol</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    LHS: </span><span class="si">{</span><span class="n">lhs</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Body: </span><span class="si">{</span><span class="n">body</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, RHS: </span><span class="si">{</span><span class="n">rhs</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">if</span> <span class="n">violation_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   All constraints satisfied!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total violations: </span><span class="si">{</span><span class="n">violation_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>

    <span class="c1"># Extract solution in same format as scipy optimizer</span>
    <span class="n">output_arr</span> <span class="o">=</span> <span class="n">_extract_output_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_metadata</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">results</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_last_solver_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;termination_condition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;objective_time_hr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;termination_condition&quot;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s2">&quot;ipopt_iterations&quot;</span><span class="p">:</span> <span class="n">iters</span><span class="p">,</span>
            <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">))),</span>
            <span class="s2">&quot;staged_solve_success&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;_staged_solve_success&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output_arr</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">output_arr</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.staged_solve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute 4-stage solve framework for robust convergence.</p>
<p>This function implements a staged optimization approach that progressively
releases degrees of freedom to improve convergence:</p>
<p><strong>Stage 1 - Feasibility</strong>: Fix controls and t_final, find consistent states
    - Objective deactivated
    - Terminal constraint (99% drying) deactivated
    - Establishes feasible starting point</p>
<p><strong>Stage 2 - Time Minimization</strong>: Unfix t_final, optimize time only
    - Objective activated: minimize t_final
    - Controls remain fixed at scipy values
    - Enforces 99% drying constraint</p>
<p><strong>Stage 3 - Control Optimization</strong>: Unfix controls (piecewise-constant)
    - Controls released but simplified
    - Maintains time optimization</p>
<p><strong>Stage 4 - Full Optimization</strong>: All DOFs released
    - Full optimal control problem
    - Both time and controls optimized
    - All constraints active</p>
<p>This approach provides:
- Better convergence vs. solving full problem directly
- Clear diagnostics at each stage
- Recovery options if later stages fail</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model with scipy warmstart</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.SolverFactory">SolverFactory</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configured IPOPT solver instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>control_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls to optimize
- 'Tsh': Optimize shelf temperature (Pch fixed)
- 'Pch': Optimize chamber pressure (Tsh fixed)
- 'both': Optimize both controls</p>
              </div>
            </td>
            <td>
                  <code>&#39;Tsh&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code>bool, default=False</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print IPOPT solver output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="bool">bool</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[bool, str]: (success, message)
- success: True if all 4 stages completed successfully
- message: Status description or error message</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Model MUST be warmstarted from scipy solution before calling</li>
<li>Stage 1 failure usually indicates model formulation error</li>
<li>Stage 2-4 failures may recover by adjusting solver tolerances</li>
<li>If stage 3-4 fail, stage 2 solution still valid (controls fixed)</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># After creating and warmstarting model</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolverFactory</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span> <span class="o">=</span> <span class="n">SolverFactory</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">staged_solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">control_mode</span><span class="o">=</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization complete: </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
</code></pre></div>


<details class="see-also" open>
  <summary>See Also</summary>
  <ul>
<li>create_optimizer_model(): Creates model structure</li>
<li>_warmstart_from_scipy_output(): Initializes from scipy solution</li>
<li>optimize_Tsh_pyomo(): High-level optimizer using this framework</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">staged_solve</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">solver</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">,</span>
    <span class="n">control_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">,</span>
    <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute 4-stage solve framework for robust convergence.</span>

<span class="sd">    This function implements a staged optimization approach that progressively</span>
<span class="sd">    releases degrees of freedom to improve convergence:</span>

<span class="sd">    **Stage 1 - Feasibility**: Fix controls and t_final, find consistent states</span>
<span class="sd">        - Objective deactivated</span>
<span class="sd">        - Terminal constraint (99% drying) deactivated</span>
<span class="sd">        - Establishes feasible starting point</span>

<span class="sd">    **Stage 2 - Time Minimization**: Unfix t_final, optimize time only</span>
<span class="sd">        - Objective activated: minimize t_final</span>
<span class="sd">        - Controls remain fixed at scipy values</span>
<span class="sd">        - Enforces 99% drying constraint</span>

<span class="sd">    **Stage 3 - Control Optimization**: Unfix controls (piecewise-constant)</span>
<span class="sd">        - Controls released but simplified</span>
<span class="sd">        - Maintains time optimization</span>

<span class="sd">    **Stage 4 - Full Optimization**: All DOFs released</span>
<span class="sd">        - Full optimal control problem</span>
<span class="sd">        - Both time and controls optimized</span>
<span class="sd">        - All constraints active</span>

<span class="sd">    This approach provides:</span>
<span class="sd">    - Better convergence vs. solving full problem directly</span>
<span class="sd">    - Clear diagnostics at each stage</span>
<span class="sd">    - Recovery options if later stages fail</span>

<span class="sd">    Args:</span>
<span class="sd">        model (pyo.ConcreteModel): Pyomo model with scipy warmstart</span>
<span class="sd">        solver (pyo.SolverFactory): Configured IPOPT solver instance</span>
<span class="sd">        control_mode (str): Controls to optimize</span>
<span class="sd">            - &#39;Tsh&#39;: Optimize shelf temperature (Pch fixed)</span>
<span class="sd">            - &#39;Pch&#39;: Optimize chamber pressure (Tsh fixed)</span>
<span class="sd">            - &#39;both&#39;: Optimize both controls</span>
<span class="sd">        tee (bool, default=False): Print IPOPT solver output</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[bool, str]: (success, message)</span>
<span class="sd">            - success: True if all 4 stages completed successfully</span>
<span class="sd">            - message: Status description or error message</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Model MUST be warmstarted from scipy solution before calling</span>
<span class="sd">        - Stage 1 failure usually indicates model formulation error</span>
<span class="sd">        - Stage 2-4 failures may recover by adjusting solver tolerances</span>
<span class="sd">        - If stage 3-4 fail, stage 2 solution still valid (controls fixed)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # After creating and warmstarting model</span>
<span class="sd">        &gt;&gt;&gt; from pyomo.environ import SolverFactory</span>
<span class="sd">        &gt;&gt;&gt; solver = SolverFactory(&#39;ipopt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; solver.options[&#39;max_iter&#39;] = 5000</span>
<span class="sd">        &gt;&gt;&gt; solver.options[&#39;tol&#39;] = 1e-6</span>
<span class="sd">        &gt;&gt;&gt; success, msg = staged_solve(model, solver, control_mode=&#39;Tsh&#39;, tee=False)</span>
<span class="sd">        &gt;&gt;&gt; if success:</span>
<span class="sd">        ...     print(f&quot;Optimization complete: {pyo.value(model.t_final):.2f} hr&quot;)</span>

<span class="sd">    See Also:</span>
<span class="sd">        - create_optimizer_model(): Creates model structure</span>
<span class="sd">        - _warmstart_from_scipy_output(): Initializes from scipy solution</span>
<span class="sd">        - optimize_Tsh_pyomo(): High-level optimizer using this framework</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STAGED SOLVE FRAMEWORK&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="c1"># Initialize metadata holders on the model for external access</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_solver_stages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_last_solver_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_staged_solve_success</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># ========== Stage 1: Feasibility (controls + t_final fixed) ==========</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Stage 1/4] Feasibility solve (controls and t_final fixed)...&quot;</span><span class="p">)</span>

    <span class="c1"># Fix controls</span>
    <span class="n">controls_to_fix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="n">controls_to_fix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Tsh&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">control_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">]:</span>
        <span class="n">controls_to_fix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pch&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">controls_to_fix</span><span class="p">:</span>
        <span class="n">ctrl_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ctrl_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl_var</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                <span class="n">ctrl_var</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>

    <span class="c1"># Deactivate terminal constraint (will be enforced during optimization)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">final_dryness</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>

    <span class="c1"># Solve feasibility</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_last_solver_result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_solver_stages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;feasibility&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Feasibility solve successful&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Feasibility solve failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_infeasible_constraints</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Diagnosing infeasible constraints...&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pyomo.util.infeasible&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">log_infeasible_constraints</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">log_expression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_variables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manual diagnosis</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Checking constraint violations manually...&quot;</span><span class="p">)</span>
            <span class="n">viol_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">component_objects</span><span class="p">(</span><span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">con</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">body_val</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">con</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">lb</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">con</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="k">if</span> <span class="n">con</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">con</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="k">if</span> <span class="n">con</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">body_val</span><span class="p">,</span> <span class="n">body_val</span> <span class="o">-</span> <span class="n">ub</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">viol</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                            <span class="n">viol_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">viol_count</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">con</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">]: viol=</span><span class="si">{</span><span class="n">viol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, body=</span><span class="si">{</span><span class="n">body_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, bounds=[</span><span class="si">{</span><span class="n">lb</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ub</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">if</span> <span class="n">viol_count</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ... and </span><span class="si">{</span><span class="n">viol_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more violations&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Stage 1 (feasibility) failed&quot;</span>

    <span class="c1"># ========== Stage 2: Time optimization (controls fixed) ==========</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Stage 2/4] Time minimization (controls fixed)...&quot;</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="o">.</span><span class="n">unfix</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">final_dryness</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>  <span class="c1"># Reactivate terminal constraint</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_last_solver_result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_solver_stages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;time_optimization&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">,</span>
                                                 <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">locallyOptimal</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Time optimization successful, t_final = </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
        <span class="n">time_only_solution</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Time optimization failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Stage 2 (time optimization) failed&quot;</span>

    <span class="c1"># ========== Stage 3: Release controls with piecewise-constant ==========</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Stage 3/4] Releasing controls (piecewise-constant)...&quot;</span><span class="p">)</span>

    <span class="c1"># Unfix controls</span>
    <span class="k">for</span> <span class="n">ctrl_name</span> <span class="ow">in</span> <span class="n">controls_to_fix</span><span class="p">:</span>
        <span class="n">ctrl_var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ctrl_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ctrl_var</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                <span class="n">ctrl_var</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">unfix</span><span class="p">()</span>

    <span class="c1"># Apply piecewise-constant via reduce_collocation_points</span>
    <span class="c1"># Note: This requires the discretization transformation handle</span>
    <span class="c1"># For now, we&#39;ll skip this and go directly to full control optimization</span>
    <span class="c1"># TODO: Implement reduce_collocation_points if needed</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_last_solver_result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_solver_stages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;control_release&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">,</span>
                                                 <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">locallyOptimal</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Control optimization successful, t_final = </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Control optimization: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Attempting recovery...&quot;</span><span class="p">)</span>

    <span class="c1"># ========== Stage 4: Full optimal control ==========</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Stage 4/4] Full optimization (all DOFs released)...&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_last_solver_result</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_solver_stages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;full_optimization&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">,</span>
                                                 <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">locallyOptimal</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Full optimization successful, t_final = </span><span class="si">{</span><span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">t_final</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> hr&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_staged_solve_success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;All stages completed successfully&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Full optimization: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_staged_solve_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Stage 4 failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.optimizers.validate_scipy_residuals" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_scipy_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scipy_output</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Validate scipy trajectory on Pyomo mesh and compute residuals.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model with scipy-initialized variables</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scipy_output</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scipy optimizer output</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print detailed residuals</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>residuals</code></td>            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with max/mean residuals for each constraint family</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/optimizers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_scipy_residuals</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">,</span>
    <span class="n">scipy_output</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">vial</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">product</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">ht</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate scipy trajectory on Pyomo mesh and compute residuals.</span>

<span class="sd">    Args:</span>
<span class="sd">        model: Pyomo model with scipy-initialized variables</span>
<span class="sd">        scipy_output: Scipy optimizer output</span>
<span class="sd">        vial: Vial parameters</span>
<span class="sd">        product: Product parameters</span>
<span class="sd">        ht: Heat transfer parameters</span>
<span class="sd">        verbose: Print detailed residuals</span>

<span class="sd">    Returns:</span>
<span class="sd">        residuals: Dict with max/mean residuals for each constraint family</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SCIPY TRAJECTORY VALIDATION ON PYOMO MESH&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="c1"># Evaluate constraint residuals at all discretization points</span>
    <span class="c1"># Note: Skip ODE constraints with DerivativeVars (handled by DAE discretization)</span>
    <span class="n">algebraic_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vapor_pressure_log&#39;</span><span class="p">,</span> <span class="s1">&#39;vapor_pressure_exp&#39;</span><span class="p">,</span> <span class="s1">&#39;product_resistance&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;kv_calc&#39;</span><span class="p">,</span> <span class="s1">&#39;sublimation_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;energy_balance&#39;</span><span class="p">,</span> <span class="s1">&#39;vial_bottom_temp&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;temp_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;equipment_capability&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">constr_name</span> <span class="ow">in</span> <span class="n">algebraic_constraints</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">):</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">constr_name</span><span class="p">)</span>
            <span class="n">viols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">constr</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">equality</span><span class="p">:</span>
                        <span class="n">body_val</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
                        <span class="n">viol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">body_val</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Inequality</span>
                        <span class="n">body_val</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                        <span class="n">lb</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="k">if</span> <span class="n">constr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                        <span class="n">viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lb</span> <span class="o">-</span> <span class="n">body_val</span><span class="p">,</span> <span class="n">body_val</span> <span class="o">-</span> <span class="n">ub</span><span class="p">)</span>
                    <span class="n">viols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">viol</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">viols</span><span class="p">:</span>
                <span class="n">max_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">viols</span><span class="p">)</span>
                <span class="n">mean_viol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">viols</span><span class="p">)</span>
                <span class="n">residuals</span><span class="p">[</span><span class="n">constr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">max_viol</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean_viol</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">constr_name</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2">: max=</span><span class="si">{</span><span class="n">max_viol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, mean=</span><span class="si">{</span><span class="n">mean_viol</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residuals</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="lyopronto.pyomo_models.single_step" class="doc doc-heading">
            <code>single_step</code>


</h3>

    <div class="doc doc-contents ">

        <p>Single time-step Pyomo optimization for lyophilization primary drying.</p>
<p>This module provides a Pyomo-based NLP formulation that replicates one time step
of the scipy sequential optimization approach. It solves for optimal chamber
pressure (Pch) and shelf temperature (Tsh) at a given dried cake length (Lck).</p>
<p>Physics Corrections (Jan 2025):
    - Energy balance: Corrected to match multi-period model (Q_shelf = Q_sublimation)
    - Vial bottom temp: Added proper constraint for frozen layer temperature gradient
    - Matches corrected multi-period formulation</p>


<details class="the-model-includes" open>
  <summary>The model includes</summary>
  <ul>
<li>7 decision variables: Pch, Tsh, Tsub, Tbot, Psub, dmdt, Kv</li>
<li>5 equality constraints: vapor pressure, sublimation rate, energy balance, 
  vial bottom temperature, vial heat transfer</li>
<li>2 inequality constraints: equipment capability, product temperature limit</li>
<li>Objective: maximize sublimation driving force (minimize Pch - Psub)</li>
</ul>
</details>









  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.single_step.create_single_step_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create Pyomo model for single time-step lyophilization optimization.</p>
<p>This function constructs a ConcreteModel that represents the physics and
constraints of lyophilization at a single time step. The model finds optimal
chamber pressure and shelf temperature to maximize sublimation rate while
respecting equipment and product temperature constraints.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry with keys:
- 'Av' (float): Vial area [cm]
- 'Ap' (float): Product area [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties with keys:
- 'R0' (float): Base product resistance [cmhrTorr/g]
- 'A1' (float): Resistance parameter [cmhrTorr/g]
- 'A2' (float): Resistance parameter [1/cm]
- 'T_pr_crit' (float): Critical product temperature [C]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters with keys:
- 'KC' (float): Vial heat transfer parameter [cal/s/K/cm]
- 'KP' (float): Vial heat transfer parameter [cal/s/K/cm/Torr]
- 'KD' (float): Vial heat transfer parameter [1/Torr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lpr0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial product length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lck</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current dried cake length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pch_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(min, max) for chamber pressure [Torr]. 
Default: (0.05, 0.5)</p>
              </div>
            </td>
            <td>
                  <code>(0.05, 0.5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tsh_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(min, max) for shelf temperature [C].
Default: (-50, 50)</p>
              </div>
            </td>
            <td>
                  <code>(-50, 50)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability parameters with keys:
- 'a' (float): Equipment capability parameter [kg/hr]
- 'b' (float): Equipment capability parameter [kg/hr/Torr]
If None, equipment constraint is not enforced.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials in batch. Required if eq_cap provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pyo.ConcreteModel: Pyomo model ready to solve with variables, constraints,
and objective defined.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>The model uses the following physics equations (corrected Jan 2025):
- Vapor pressure: Psub = 2.698e10 * exp(-6144.96/(Tsub + 273.15))
- Product resistance: Rp = R0 + A1<em>Lck/(1 + A2</em>Lck)
- Vial heat transfer: Kv = KC + KP<em>Pch/(1 + KD</em>Pch)
- Sublimation rate: dmdt = Ap/Rp * (Psub - Pch) / kg_To_g
- Energy balance: Kv<em>Av</em>(Tsh - Tbot) = dHs<em>dmdt</em>kg_To_g/hr_To_s
- Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)<em>dHs</em>dmdt<em>kg_To_g/hr_To_s/(Ap</em>k_ice)</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">vial</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.80</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ht</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">2.75e-4</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">8.93e-4</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Lpr0</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Lpr0_FUN</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Lck</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Half dried</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Now solve with solve_single_step(model)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_single_step_model</span><span class="p">(</span>
    <span class="n">vial</span><span class="p">,</span> 
    <span class="n">product</span><span class="p">,</span> 
    <span class="n">ht</span><span class="p">,</span> 
    <span class="n">Lpr0</span><span class="p">,</span> 
    <span class="n">Lck</span><span class="p">,</span>
    <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create Pyomo model for single time-step lyophilization optimization.</span>

<span class="sd">    This function constructs a ConcreteModel that represents the physics and</span>
<span class="sd">    constraints of lyophilization at a single time step. The model finds optimal</span>
<span class="sd">    chamber pressure and shelf temperature to maximize sublimation rate while</span>
<span class="sd">    respecting equipment and product temperature constraints.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry with keys:</span>
<span class="sd">            - &#39;Av&#39; (float): Vial area [cm]</span>
<span class="sd">            - &#39;Ap&#39; (float): Product area [cm]</span>
<span class="sd">        product (dict): Product properties with keys:</span>
<span class="sd">            - &#39;R0&#39; (float): Base product resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;A1&#39; (float): Resistance parameter [cmhrTorr/g]</span>
<span class="sd">            - &#39;A2&#39; (float): Resistance parameter [1/cm]</span>
<span class="sd">            - &#39;T_pr_crit&#39; (float): Critical product temperature [C]</span>
<span class="sd">        ht (dict): Heat transfer parameters with keys:</span>
<span class="sd">            - &#39;KC&#39; (float): Vial heat transfer parameter [cal/s/K/cm]</span>
<span class="sd">            - &#39;KP&#39; (float): Vial heat transfer parameter [cal/s/K/cm/Torr]</span>
<span class="sd">            - &#39;KD&#39; (float): Vial heat transfer parameter [1/Torr]</span>
<span class="sd">        Lpr0 (float): Initial product length [cm]</span>
<span class="sd">        Lck (float): Current dried cake length [cm]</span>
<span class="sd">        Pch_bounds (tuple, optional): (min, max) for chamber pressure [Torr]. </span>
<span class="sd">            Default: (0.05, 0.5)</span>
<span class="sd">        Tsh_bounds (tuple, optional): (min, max) for shelf temperature [C].</span>
<span class="sd">            Default: (-50, 50)</span>
<span class="sd">        eq_cap (dict, optional): Equipment capability parameters with keys:</span>
<span class="sd">            - &#39;a&#39; (float): Equipment capability parameter [kg/hr]</span>
<span class="sd">            - &#39;b&#39; (float): Equipment capability parameter [kg/hr/Torr]</span>
<span class="sd">            If None, equipment constraint is not enforced.</span>
<span class="sd">        nVial (int, optional): Number of vials in batch. Required if eq_cap provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pyo.ConcreteModel: Pyomo model ready to solve with variables, constraints,</span>
<span class="sd">            and objective defined.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The model uses the following physics equations (corrected Jan 2025):</span>
<span class="sd">        - Vapor pressure: Psub = 2.698e10 * exp(-6144.96/(Tsub + 273.15))</span>
<span class="sd">        - Product resistance: Rp = R0 + A1*Lck/(1 + A2*Lck)</span>
<span class="sd">        - Vial heat transfer: Kv = KC + KP*Pch/(1 + KD*Pch)</span>
<span class="sd">        - Sublimation rate: dmdt = Ap/Rp * (Psub - Pch) / kg_To_g</span>
<span class="sd">        - Energy balance: Kv*Av*(Tsh - Tbot) = dHs*dmdt*kg_To_g/hr_To_s</span>
<span class="sd">        - Vial bottom temp: Tbot = Tsub + (Lpr0-Lck)*dHs*dmdt*kg_To_g/hr_To_s/(Ap*k_ice)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from lyopronto import functions</span>
<span class="sd">        &gt;&gt;&gt; vial = {&#39;Av&#39;: 3.80, &#39;Ap&#39;: 3.14}</span>
<span class="sd">        &gt;&gt;&gt; product = {&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0}</span>
<span class="sd">        &gt;&gt;&gt; ht = {&#39;KC&#39;: 2.75e-4, &#39;KP&#39;: 8.93e-4, &#39;KD&#39;: 0.46}</span>
<span class="sd">        &gt;&gt;&gt; Lpr0 = functions.Lpr0_FUN(2.0, 3.14, 0.05)</span>
<span class="sd">        &gt;&gt;&gt; Lck = 0.5  # Half dried</span>
<span class="sd">        &gt;&gt;&gt; model = create_single_step_model(vial, product, ht, Lpr0, Lck)</span>
<span class="sd">        &gt;&gt;&gt; # Now solve with solve_single_step(model)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">ConcreteModel</span><span class="p">()</span>

    <span class="c1"># ==================== Parameters (Fixed for this step) ====================</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lpr0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">Lpr0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">Lck</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Av</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Av&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">R0</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">A1</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">A2</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">T_crit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">product</span><span class="p">[</span><span class="s1">&#39;T_pr_crit&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KC</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KP</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">KD</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">])</span>

    <span class="c1"># Physical constants</span>
    <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">kg_To_g</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">hr_To_s</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">k_ice</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">k_ice</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">constant</span><span class="o">.</span><span class="n">dHs</span><span class="p">)</span>

    <span class="c1"># ==================== Decision Variables ====================</span>
    <span class="c1"># Chamber pressure [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Pch_bounds</span><span class="p">)</span>

    <span class="c1"># Shelf temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Tsh_bounds</span><span class="p">)</span>

    <span class="c1"># Sublimation front temperature [C] - always below freezing</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Vial bottom temperature [C]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>

    <span class="c1"># Vapor pressure at sublimation front [Torr]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Log of vapor pressure (for numerical stability in exponential constraint)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Reals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>  <span class="c1"># log(1e-6) to log(10)</span>

    <span class="c1"># Sublimation rate [kg/hr] - must be non-negative</span>
    <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">NonNegativeReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Vial heat transfer coefficient [cal/s/K/cm]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">PositiveReals</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">))</span>

    <span class="c1"># ==================== Derived Quantities (Expressions) ====================</span>
    <span class="c1"># Product resistance [cmhrTorr/g]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">R0</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">A1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">A2</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Equality Constraints ====================</span>
    <span class="c1"># C1: Vapor pressure at sublimation front (Antoine equation)</span>
    <span class="c1"># Using log transformation for numerical stability:</span>
    <span class="c1"># log(Psub) = log(2.698e10) - 6144.96/(Tsub + 273.15)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_log</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.698e10</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6144.96</span> <span class="o">/</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C1b: Link log_Psub to Psub</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vapor_pressure_exp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">==</span> <span class="n">pyo</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C2: Sublimation rate from mass transfer</span>
    <span class="c1"># dmdt = Ap/Rp * (Psub - Pch) / kg_To_g</span>
    <span class="n">model</span><span class="o">.</span><span class="n">sublimation_rate</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">Rp</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C3: Energy balance - heat from shelf equals heat for sublimation</span>
    <span class="c1"># Q_shelf = Kv * Av * (Tsh - Tbot)</span>
    <span class="c1"># Q_sub = dHs * dmdt * kg_To_g / hr_To_s</span>
    <span class="c1"># This matches the corrected multi-period energy_balance constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">energy_balance</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Av</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">)</span>
             <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span>
    <span class="p">)</span>

    <span class="c1"># C4: Vial bottom temperature from conduction through frozen layer</span>
    <span class="c1"># Tbot = Tsub + T_frozen</span>
    <span class="c1"># where T_frozen = (Lpr0 - Lck) * Q_sub / (Ap * k_ice)</span>
    <span class="c1"># This matches the corrected multi-period vial_bottom_temp constraint</span>
    <span class="n">model</span><span class="o">.</span><span class="n">vial_bottom_temp</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span> <span class="o">+</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lpr0</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Lck</span><span class="p">)</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dHs</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">kg_To_g</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">hr_To_s</span> <span class="o">/</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Ap</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">k_ice</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># C5: Vial heat transfer coefficient</span>
    <span class="c1"># Kv = KC + KP * Pch / (1 + KD * Pch)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">kv_calc</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">KC</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">KP</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">KD</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Inequality Constraints ====================</span>
    <span class="c1"># Product temperature limit: Tbot  T_crit</span>
    <span class="n">model</span><span class="o">.</span><span class="n">temp_limit</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">T_crit</span>
    <span class="p">)</span>

    <span class="c1"># Equipment capability limit (optional)</span>
    <span class="k">if</span> <span class="n">eq_cap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nVial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">a_eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">b_eq</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">nVial</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Param</span><span class="p">(</span><span class="n">initialize</span><span class="o">=</span><span class="n">nVial</span><span class="p">)</span>

        <span class="c1"># a + b*Pch - nVial*dmdt  0</span>
        <span class="n">model</span><span class="o">.</span><span class="n">equipment_capability</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Constraint</span><span class="p">(</span>
            <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">a_eq</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">b_eq</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">nVial</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">)</span>

    <span class="c1"># ==================== Objective Function ====================</span>
    <span class="c1"># Minimize (Pch - Psub) to maximize sublimation driving force (Psub - Pch)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Objective</span><span class="p">(</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">,</span>
        <span class="n">sense</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">minimize</span>
    <span class="p">)</span>

    <span class="c1"># ==================== Scaling (Optional) ====================</span>
    <span class="k">if</span> <span class="n">apply_scaling</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
        <span class="n">scaling_factors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;log_Psub&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># log values are already scaled</span>
            <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
            <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scaling_factors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.single_step.optimize_single_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_single_step</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span> <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convenience function to create and solve single-step model in one call.</p>
<p>This function combines create_single_step_model() and solve_single_step()
for ease of use when you don't need to inspect the model structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters (see create_single_step_model)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lpr0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial product length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lck</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current dried cake length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Pch_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chamber pressure bounds [Torr]</p>
              </div>
            </td>
            <td>
                  <code>(0.05, 0.5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Tsh_bounds</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shelf temperature bounds [C]</p>
              </div>
            </td>
            <td>
                  <code>(-50, 50)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eq_cap</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Equipment capability parameters</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nVial</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of vials</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial variable values</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name (default: 'ipopt')</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print solver output (default: False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_scaling</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply variable scaling (default: True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution dictionary (see solve_single_step)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">optimize_single_step</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">vial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Av&#39;</span><span class="p">:</span> <span class="mf">3.8</span><span class="p">,</span> <span class="s1">&#39;Ap&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">product</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;T_pr_crit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">ht</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="mf">2.75e-4</span><span class="p">,</span> <span class="s1">&#39;KP&#39;</span><span class="p">:</span> <span class="mf">8.93e-4</span><span class="p">,</span> <span class="s1">&#39;KD&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">},</span>
<span class="gp">... </span>    <span class="n">Lpr0</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Lck</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">tee</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_single_step</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span>
                        <span class="n">Pch_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">Tsh_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
                        <span class="n">eq_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">nVial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span>
                        <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">apply_scaling</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience function to create and solve single-step model in one call.</span>

<span class="sd">    This function combines create_single_step_model() and solve_single_step()</span>
<span class="sd">    for ease of use when you don&#39;t need to inspect the model structure.</span>

<span class="sd">    Args:</span>
<span class="sd">        vial (dict): Vial geometry (see create_single_step_model)</span>
<span class="sd">        product (dict): Product properties (see create_single_step_model)</span>
<span class="sd">        ht (dict): Heat transfer parameters (see create_single_step_model)</span>
<span class="sd">        Lpr0 (float): Initial product length [cm]</span>
<span class="sd">        Lck (float): Current dried cake length [cm]</span>
<span class="sd">        Pch_bounds (tuple): Chamber pressure bounds [Torr]</span>
<span class="sd">        Tsh_bounds (tuple): Shelf temperature bounds [C]</span>
<span class="sd">        eq_cap (dict): Equipment capability parameters</span>
<span class="sd">        nVial (int): Number of vials</span>
<span class="sd">        warmstart_data (dict): Initial variable values</span>
<span class="sd">        solver (str): Solver name (default: &#39;ipopt&#39;)</span>
<span class="sd">        tee (bool): Print solver output (default: False)</span>
<span class="sd">        apply_scaling (bool): Apply variable scaling (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Solution dictionary (see solve_single_step)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; solution = optimize_single_step(</span>
<span class="sd">        ...     vial={&#39;Av&#39;: 3.8, &#39;Ap&#39;: 3.14},</span>
<span class="sd">        ...     product={&#39;R0&#39;: 1.4, &#39;A1&#39;: 16.0, &#39;A2&#39;: 0.0, &#39;T_pr_crit&#39;: -5.0},</span>
<span class="sd">        ...     ht={&#39;KC&#39;: 2.75e-4, &#39;KP&#39;: 8.93e-4, &#39;KD&#39;: 0.46},</span>
<span class="sd">        ...     Lpr0=1.5,</span>
<span class="sd">        ...     Lck=0.5,</span>
<span class="sd">        ...     tee=True</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create and solve</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span>
        <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">,</span>
        <span class="n">Pch_bounds</span><span class="o">=</span><span class="n">Pch_bounds</span><span class="p">,</span>
        <span class="n">Tsh_bounds</span><span class="o">=</span><span class="n">Tsh_bounds</span><span class="p">,</span>
        <span class="n">eq_cap</span><span class="o">=</span><span class="n">eq_cap</span><span class="p">,</span>
        <span class="n">nVial</span><span class="o">=</span><span class="n">nVial</span><span class="p">,</span>
        <span class="n">apply_scaling</span><span class="o">=</span><span class="n">apply_scaling</span>
    <span class="p">)</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
        <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">,</span>
        <span class="n">warmstart_data</span><span class="o">=</span><span class="n">warmstart_data</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.single_step.solve_single_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Solve Pyomo single-step model and extract results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyomo.environ.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model created by create_single_step_model()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>solver</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solver name. Default: 'ipopt'</p>
              </div>
            </td>
            <td>
                  <code>&#39;ipopt&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tee</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print solver output. Default: False</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmstart_data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values for variables with keys:
'Pch', 'Tsh', 'Tsub', 'Tbot', 'Psub', 'dmdt', 'Kv'.
If provided, these values are used to initialize the model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution dictionary with keys:
- 'status' (str): Solver termination condition
- 'Pch' (float): Chamber pressure [Torr]
- 'Tsh' (float): Shelf temperature [C]
- 'Tsub' (float): Sublimation front temperature [C]
- 'Tbot' (float): Vial bottom temperature [C]
- 'Psub' (float): Vapor pressure [Torr]
- 'dmdt' (float): Sublimation rate [kg/hr]
- 'Kv' (float): Vial heat transfer coefficient [cal/s/K/cm]
- 'Rp' (float): Product resistance [cmhrTorr/g]
- 'obj' (float): Objective value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If solver is not available or fails to solve.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>For IPOPT solver, the following options are used:
- max_iter: 3000
- tol: 1e-6
- mu_strategy: 'adaptive'
- print_level: 5 (if tee=True), 0 (if tee=False)</p>
<p>If IPOPT is not in PATH, will attempt to use IDAES-provided IPOPT.</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">Lck</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal Pch: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> Torr&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal Tsh: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> C&quot;</span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/single_step.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmstart_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve Pyomo single-step model and extract results.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (pyo.ConcreteModel): Pyomo model created by create_single_step_model()</span>
<span class="sd">        solver (str, optional): Solver name. Default: &#39;ipopt&#39;</span>
<span class="sd">        tee (bool, optional): If True, print solver output. Default: False</span>
<span class="sd">        warmstart_data (dict, optional): Initial values for variables with keys:</span>
<span class="sd">            &#39;Pch&#39;, &#39;Tsh&#39;, &#39;Tsub&#39;, &#39;Tbot&#39;, &#39;Psub&#39;, &#39;dmdt&#39;, &#39;Kv&#39;.</span>
<span class="sd">            If provided, these values are used to initialize the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Solution dictionary with keys:</span>
<span class="sd">            - &#39;status&#39; (str): Solver termination condition</span>
<span class="sd">            - &#39;Pch&#39; (float): Chamber pressure [Torr]</span>
<span class="sd">            - &#39;Tsh&#39; (float): Shelf temperature [C]</span>
<span class="sd">            - &#39;Tsub&#39; (float): Sublimation front temperature [C]</span>
<span class="sd">            - &#39;Tbot&#39; (float): Vial bottom temperature [C]</span>
<span class="sd">            - &#39;Psub&#39; (float): Vapor pressure [Torr]</span>
<span class="sd">            - &#39;dmdt&#39; (float): Sublimation rate [kg/hr]</span>
<span class="sd">            - &#39;Kv&#39; (float): Vial heat transfer coefficient [cal/s/K/cm]</span>
<span class="sd">            - &#39;Rp&#39; (float): Product resistance [cmhrTorr/g]</span>
<span class="sd">            - &#39;obj&#39; (float): Objective value</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If solver is not available or fails to solve.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For IPOPT solver, the following options are used:</span>
<span class="sd">        - max_iter: 3000</span>
<span class="sd">        - tol: 1e-6</span>
<span class="sd">        - mu_strategy: &#39;adaptive&#39;</span>
<span class="sd">        - print_level: 5 (if tee=True), 0 (if tee=False)</span>

<span class="sd">        If IPOPT is not in PATH, will attempt to use IDAES-provided IPOPT.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; model = create_single_step_model(vial, product, ht, Lpr0, Lck)</span>
<span class="sd">        &gt;&gt;&gt; solution = solve_single_step(model, tee=True)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal Pch: {solution[&#39;Pch&#39;]:.4f} Torr&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Optimal Tsh: {solution[&#39;Tsh&#39;]:.2f} C&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Apply warmstart values if provided</span>
    <span class="k">if</span> <span class="n">warmstart_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Pch&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tsh&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tsub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Tbot&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Psub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;log_Psub&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;log_Psub&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;dmdt&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;Kv&#39;</span> <span class="ow">in</span> <span class="n">warmstart_data</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">warmstart_data</span><span class="p">[</span><span class="s1">&#39;Kv&#39;</span><span class="p">])</span>

    <span class="c1"># Create solver - try IDAES first if available, then standard Pyomo</span>
    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">idaes.core.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solver</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">get_solver</span><span class="p">(</span><span class="s1">&#39;ipopt&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="c1"># Fall back to standard Pyomo solver</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

    <span class="c1"># Configure IPOPT options</span>
    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">tee</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Solve</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">tee</span><span class="p">)</span>

    <span class="c1"># Check convergence</span>
    <span class="n">termination</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">termination_condition</span>
    <span class="n">status_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">termination</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">termination</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">optimal</span><span class="p">,</span> 
                           <span class="n">pyo</span><span class="o">.</span><span class="n">TerminationCondition</span><span class="o">.</span><span class="n">locallyOptimal</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Solver status: </span><span class="si">{</span><span class="n">termination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract solution</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status_str</span><span class="p">,</span>
        <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Pch</span><span class="p">),</span>
        <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsh</span><span class="p">),</span>
        <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tsub</span><span class="p">),</span>
        <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tbot</span><span class="p">),</span>
        <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Psub</span><span class="p">),</span>
        <span class="s1">&#39;log_Psub&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_Psub</span><span class="p">),</span>
        <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dmdt</span><span class="p">),</span>
        <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Kv</span><span class="p">),</span>
        <span class="s1">&#39;Rp&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Rp</span><span class="p">),</span>
        <span class="s1">&#39;obj&#39;</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">obj</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">solution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="lyopronto.pyomo_models.utils" class="doc doc-heading">
            <code>utils</code>


</h3>

    <div class="doc doc-contents ">

        <p>Utility functions for Pyomo model initialization, scaling, and result extraction.</p>
<p>This module provides helper functions to bridge scipy and Pyomo implementations,
including warmstarting Pyomo models from scipy solutions and converting results
to standard output formats.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.utils.add_scaling_suffix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">variable_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add scaling factors to Pyomo model for improved numerical conditioning.</p>
<p>Scaling can significantly improve solver convergence by ensuring all
variables and constraints have similar magnitudes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="pyo.ConcreteModel">ConcreteModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pyomo model to add scaling to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>variable_scales</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom scaling factors. If None,
uses default scales based on typical variable magnitudes.
Keys are variable names ('Tsub', 'Pch', etc.), values are
scaling factors.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>None</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Modifies model in place by adding scaling_factor Suffix</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>Default scaling factors:
- Temperature variables (Tsub, Tbot, Tsh): 0.01 (typical ~-20C)
- Pressure variables (Pch, Psub): 10 (typical ~0.1 Torr)
- Kv: 1e4 (typical ~1e-4)
- dmdt: 1.0</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">create_single_step_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>  <span class="c1"># Use defaults</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Or with custom scales:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">})</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_scaling_suffix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">variable_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add scaling factors to Pyomo model for improved numerical conditioning.</span>

<span class="sd">    Scaling can significantly improve solver convergence by ensuring all</span>
<span class="sd">    variables and constraints have similar magnitudes.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (pyo.ConcreteModel): Pyomo model to add scaling to</span>
<span class="sd">        variable_scales (dict, optional): Custom scaling factors. If None,</span>
<span class="sd">            uses default scales based on typical variable magnitudes.</span>
<span class="sd">            Keys are variable names (&#39;Tsub&#39;, &#39;Pch&#39;, etc.), values are</span>
<span class="sd">            scaling factors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: Modifies model in place by adding scaling_factor Suffix</span>

<span class="sd">    Notes:</span>
<span class="sd">        Default scaling factors:</span>
<span class="sd">        - Temperature variables (Tsub, Tbot, Tsh): 0.01 (typical ~-20C)</span>
<span class="sd">        - Pressure variables (Pch, Psub): 10 (typical ~0.1 Torr)</span>
<span class="sd">        - Kv: 1e4 (typical ~1e-4)</span>
<span class="sd">        - dmdt: 1.0</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; model = create_single_step_model(...)</span>
<span class="sd">        &gt;&gt;&gt; add_scaling_suffix(model)  # Use defaults</span>
<span class="sd">        &gt;&gt;&gt; # Or with custom scales:</span>
<span class="sd">        &gt;&gt;&gt; add_scaling_suffix(model, {&#39;Pch&#39;: 5, &#39;Tsh&#39;: 0.02})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyo</span>

    <span class="c1"># Default scales</span>
    <span class="n">default_scales</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>    <span class="c1"># Typical value ~-20C</span>
        <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1"># Typical value ~0.1 Torr</span>
        <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>       <span class="c1"># Typical value ~1e-4</span>
        <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Use custom scales if provided, otherwise defaults</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="n">variable_scales</span> <span class="k">if</span> <span class="n">variable_scales</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_scales</span>

    <span class="c1"># Create scaling suffix</span>
    <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">pyo</span><span class="o">.</span><span class="n">Suffix</span><span class="o">.</span><span class="n">EXPORT</span><span class="p">)</span>

    <span class="c1"># Apply scaling factors</span>
    <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">scales</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.utils.check_solution_validity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_solution_validity</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Validate that a Pyomo solution satisfies physical constraints.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>solution</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution dictionary from solve_single_step()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tol</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tolerance for constraint violations. Default: 1e-3</p>
              </div>
            </td>
            <td>
                  <code>0.001</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(is_valid, violations) where:
- is_valid (bool): True if all checks pass
- violations (list): List of violation messages</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>Checks performed:
- Temperature ordering: Tsub  Tbot  Tsh
- Sublimation temperature below freezing: Tsub &lt; 0
- Positive pressures and rates
- Vapor pressure consistency</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">is_valid</span><span class="p">,</span> <span class="n">violations</span> <span class="o">=</span> <span class="n">check_solution_validity</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Violations:&quot;</span><span class="p">,</span> <span class="n">violations</span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_solution_validity</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that a Pyomo solution satisfies physical constraints.</span>

<span class="sd">    Args:</span>
<span class="sd">        solution (dict): Solution dictionary from solve_single_step()</span>
<span class="sd">        tol (float, optional): Tolerance for constraint violations. Default: 1e-3</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (is_valid, violations) where:</span>
<span class="sd">            - is_valid (bool): True if all checks pass</span>
<span class="sd">            - violations (list): List of violation messages</span>

<span class="sd">    Notes:</span>
<span class="sd">        Checks performed:</span>
<span class="sd">        - Temperature ordering: Tsub  Tbot  Tsh</span>
<span class="sd">        - Sublimation temperature below freezing: Tsub &lt; 0</span>
<span class="sd">        - Positive pressures and rates</span>
<span class="sd">        - Vapor pressure consistency</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; solution = solve_single_step(model)</span>
<span class="sd">        &gt;&gt;&gt; is_valid, violations = check_solution_validity(solution)</span>
<span class="sd">        &gt;&gt;&gt; if not is_valid:</span>
<span class="sd">        ...     print(&quot;Violations:&quot;, violations)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Temperature ordering</span>
    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tsub (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) &gt; Tbot (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tbot (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) &gt; Tsh (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Sublimation temperature below freezing</span>
    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tsub (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) above freezing&quot;</span><span class="p">)</span>

    <span class="c1"># Positive values</span>
    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative Pch: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative Psub: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Negative dmdt: </span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Driving force check (Psub should be &gt; Pch for sublimation)</span>
    <span class="k">if</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
        <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Psub (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Psub&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">) &lt; Pch (</span><span class="si">{</span><span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">is_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">is_valid</span><span class="p">,</span> <span class="n">violations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.utils.extract_solution_to_array" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_solution_to_array</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convert Pyomo solution dict to standard output array format.</p>
<p>This function formats a Pyomo solution to match the scipy output format
for consistency and comparison.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>solution</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Solution from solve_single_step() with keys:
'Pch', 'Tsh', 'Tsub', 'Tbot', 'dmdt', etc.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time value for this step [hr]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: Array of shape (7,) with columns:
[time, Tsub, Tbot, Tsh, Pch_mTorr, flux, frac_dried]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Pch is converted from Torr to mTorr</li>
<li>flux is dmdt normalized by product area</li>
<li>frac_dried must be computed externally (requires Lck and Lpr0)</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">solution</span> <span class="o">=</span> <span class="n">solve_single_step</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">output_row</span> <span class="o">=</span> <span class="n">extract_solution_to_array</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_solution_to_array</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert Pyomo solution dict to standard output array format.</span>

<span class="sd">    This function formats a Pyomo solution to match the scipy output format</span>
<span class="sd">    for consistency and comparison.</span>

<span class="sd">    Args:</span>
<span class="sd">        solution (dict): Solution from solve_single_step() with keys:</span>
<span class="sd">            &#39;Pch&#39;, &#39;Tsh&#39;, &#39;Tsub&#39;, &#39;Tbot&#39;, &#39;dmdt&#39;, etc.</span>
<span class="sd">        time (float): Time value for this step [hr]</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Array of shape (7,) with columns:</span>
<span class="sd">            [time, Tsub, Tbot, Tsh, Pch_mTorr, flux, frac_dried]</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Pch is converted from Torr to mTorr</span>
<span class="sd">        - flux is dmdt normalized by product area</span>
<span class="sd">        - frac_dried must be computed externally (requires Lck and Lpr0)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; solution = solve_single_step(model)</span>
<span class="sd">        &gt;&gt;&gt; output_row = extract_solution_to_array(solution, time=0.5)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note: This is a simplified version</span>
    <span class="c1"># In full implementation, would need vial[&#39;Ap&#39;] and Lck/Lpr0 for complete conversion</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">time</span><span class="p">,</span>
        <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsub&#39;</span><span class="p">],</span>
        <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tbot&#39;</span><span class="p">],</span>
        <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Tsh&#39;</span><span class="p">],</span>
        <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;Pch&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">constant</span><span class="o">.</span><span class="n">Torr_to_mTorr</span><span class="p">,</span>  <span class="c1"># Torr  mTorr</span>
        <span class="n">solution</span><span class="p">[</span><span class="s1">&#39;dmdt&#39;</span><span class="p">],</span>  <span class="c1"># Note: needs conversion to flux [kg/hr/m]</span>
        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># frac_dried - needs to be computed externally</span>
    <span class="p">])</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="lyopronto.pyomo_models.utils.initialize_from_scipy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize_from_scipy</span><span class="p">(</span><span class="n">scipy_output</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">ht</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create warmstart data dictionary from scipy optimization output.</p>
<p>This function extracts values from a scipy optimization result array
and formats them as a dictionary suitable for initializing Pyomo variables.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scipy_output</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output from opt_Pch_Tsh.dry() or similar,
with shape (n_steps, 7) and columns:
[time, Tsub, Tbot, Tsh, Pch_mTorr, flux, frac_dried]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_index</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the time step to extract (0-based)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vial</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vial geometry with 'Av', 'Ap' keys</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>product</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Product properties with 'R0', 'A1', 'A2' keys</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Lpr0</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial product length [cm]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ht</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Heat transfer parameters with 'KC', 'KP', 'KD' keys.
If provided, Kv will be computed accurately.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Warmstart data with keys: 'Pch', 'Tsh', 'Tsub', 'Tbot', 'Psub', 
'log_Psub', 'dmdt', 'Kv'</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Pch is converted from mTorr to Torr (divides by 1000)</li>
<li>Lck is calculated from frac_dried</li>
<li>Derived quantities (Psub, dmdt, Kv) are computed from physics functions</li>
</ul>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">lyopronto</span><span class="w"> </span><span class="kn">import</span> <span class="n">opt_Pch_Tsh</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scipy_out</span> <span class="o">=</span> <span class="n">opt_Pch_Tsh</span><span class="o">.</span><span class="n">dry</span><span class="p">(</span><span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">Pch</span><span class="p">,</span> <span class="n">Tsh</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">eq_cap</span><span class="p">,</span> <span class="n">nVial</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">warmstart</span> <span class="o">=</span> <span class="n">initialize_from_scipy</span><span class="p">(</span><span class="n">scipy_out</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Use warmstart dict to initialize Pyomo model</span>
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lyopronto/pyomo_models/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">initialize_from_scipy</span><span class="p">(</span><span class="n">scipy_output</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">vial</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">Lpr0</span><span class="p">,</span> <span class="n">ht</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create warmstart data dictionary from scipy optimization output.</span>

<span class="sd">    This function extracts values from a scipy optimization result array</span>
<span class="sd">    and formats them as a dictionary suitable for initializing Pyomo variables.</span>

<span class="sd">    Args:</span>
<span class="sd">        scipy_output (np.ndarray): Output from opt_Pch_Tsh.dry() or similar,</span>
<span class="sd">            with shape (n_steps, 7) and columns:</span>
<span class="sd">            [time, Tsub, Tbot, Tsh, Pch_mTorr, flux, frac_dried]</span>
<span class="sd">        time_index (int): Index of the time step to extract (0-based)</span>
<span class="sd">        vial (dict): Vial geometry with &#39;Av&#39;, &#39;Ap&#39; keys</span>
<span class="sd">        product (dict): Product properties with &#39;R0&#39;, &#39;A1&#39;, &#39;A2&#39; keys</span>
<span class="sd">        Lpr0 (float): Initial product length [cm]</span>
<span class="sd">        ht (dict, optional): Heat transfer parameters with &#39;KC&#39;, &#39;KP&#39;, &#39;KD&#39; keys.</span>
<span class="sd">            If provided, Kv will be computed accurately.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Warmstart data with keys: &#39;Pch&#39;, &#39;Tsh&#39;, &#39;Tsub&#39;, &#39;Tbot&#39;, &#39;Psub&#39;, </span>
<span class="sd">            &#39;log_Psub&#39;, &#39;dmdt&#39;, &#39;Kv&#39;</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Pch is converted from mTorr to Torr (divides by 1000)</span>
<span class="sd">        - Lck is calculated from frac_dried</span>
<span class="sd">        - Derived quantities (Psub, dmdt, Kv) are computed from physics functions</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from lyopronto import opt_Pch_Tsh</span>
<span class="sd">        &gt;&gt;&gt; scipy_out = opt_Pch_Tsh.dry(vial, product, ht, Pch, Tsh, dt, eq_cap, nVial)</span>
<span class="sd">        &gt;&gt;&gt; warmstart = initialize_from_scipy(scipy_out, 10, vial, product, Lpr0)</span>
<span class="sd">        &gt;&gt;&gt; # Use warmstart dict to initialize Pyomo model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract values from scipy output</span>
    <span class="c1"># Columns: [time, Tsub, Tbot, Tsh, Pch_mTorr, flux, frac_dried]</span>
    <span class="n">Tsub</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="n">time_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">Tbot</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="n">time_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">Tsh</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="n">time_index</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">Pch</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="n">time_index</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">constant</span><span class="o">.</span><span class="n">Torr_to_mTorr</span>  <span class="c1"># mTorr  Torr</span>
    <span class="n">frac_dried</span> <span class="o">=</span> <span class="n">scipy_output</span><span class="p">[</span><span class="n">time_index</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Calculate derived quantities</span>
    <span class="n">Lck</span> <span class="o">=</span> <span class="n">frac_dried</span> <span class="o">*</span> <span class="n">Lpr0</span>  <span class="c1"># Current dried cake length [cm]</span>
    <span class="n">Rp</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Rp_FUN</span><span class="p">(</span><span class="n">Lck</span><span class="p">,</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span> <span class="n">product</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">])</span>
    <span class="n">Psub</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Vapor_pressure</span><span class="p">(</span><span class="n">Tsub</span><span class="p">)</span>
    <span class="n">dmdt</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">sub_rate</span><span class="p">(</span><span class="n">vial</span><span class="p">[</span><span class="s1">&#39;Ap&#39;</span><span class="p">],</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Tsub</span><span class="p">,</span> <span class="n">Pch</span><span class="p">)</span>

    <span class="c1"># Calculate Kv from heat transfer parameters if available</span>
    <span class="k">if</span> <span class="n">ht</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Kv</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">Kv_FUN</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KC&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KP&#39;</span><span class="p">],</span> <span class="n">ht</span><span class="p">[</span><span class="s1">&#39;KD&#39;</span><span class="p">],</span> <span class="n">Pch</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use typical value as fallback</span>
        <span class="n">Kv</span> <span class="o">=</span> <span class="mf">5e-4</span>  <span class="c1"># Typical value [cal/s/K/cm]</span>

    <span class="n">warmstart_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Pch&#39;</span><span class="p">:</span> <span class="n">Pch</span><span class="p">,</span>
        <span class="s1">&#39;Tsh&#39;</span><span class="p">:</span> <span class="n">Tsh</span><span class="p">,</span>
        <span class="s1">&#39;Tsub&#39;</span><span class="p">:</span> <span class="n">Tsub</span><span class="p">,</span>
        <span class="s1">&#39;Tbot&#39;</span><span class="p">:</span> <span class="n">Tbot</span><span class="p">,</span>
        <span class="s1">&#39;Psub&#39;</span><span class="p">:</span> <span class="n">Psub</span><span class="p">,</span>
        <span class="s1">&#39;log_Psub&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Psub</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)),</span>  <span class="c1"># Add log for stability</span>
        <span class="s1">&#39;dmdt&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dmdt</span><span class="p">),</span>  <span class="c1"># Ensure non-negative</span>
        <span class="s1">&#39;Kv&#39;</span><span class="p">:</span> <span class="n">Kv</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">warmstart_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>